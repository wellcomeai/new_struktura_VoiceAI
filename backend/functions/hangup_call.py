# backend/functions/hangup_call.py
"""
–§—É–Ω–∫—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–≤–æ–Ω–∫–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ UI.
–§–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ VoxEngine —Å–∫—Ä–∏–ø—Ç–µ.
"""

from typing import Dict, Any
from backend.functions.base import FunctionBase
from backend.functions.registry import register_function
from backend.core.logging import get_logger

logger = get_logger(__name__)

@register_function
class HangupCallFunction(FunctionBase):
    """
    –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –∑–≤–æ–Ω–∫–∞.
    
    –í–ê–ñ–ù–û: –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ UI.
    –†–µ–∞–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ª–æ–∫–∞–ª—å–Ω–æ –≤ VoxEngine —Å–∫—Ä–∏–ø—Ç–µ.
    """
    
    @classmethod
    def get_name(cls) -> str:
        return "hangup_call"
    
    @classmethod
    def get_display_name(cls) -> str:
        return "–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–≤–æ–Ω–∫–∞ (—Ç–æ–ª—å–∫–æ Voximplant)"
    
    @classmethod
    def get_description(cls) -> str:
        return """
        –ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç–µ–∫—É—â–∏–π –∑–≤–æ–Ω–æ–∫ –∫–æ–≥–¥–∞ —Ä–∞–∑–≥–æ–≤–æ—Ä –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω –∏–ª–∏ –ø–æ –ø—Ä–æ—Å—å–±–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
        
        –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é –≤ —Å–ª–µ–¥—É—é—â–∏—Ö —Å–ª—É—á–∞—è—Ö:
        - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–±–ª–∞–≥–æ–¥–∞—Ä–∏–ª –∏ –∑–∞–≤–µ—Ä—à–∏–ª —Ä–∞–∑–≥–æ–≤–æ—Ä
        - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä—è–º–æ –ø–æ–ø—Ä–æ—Å–∏–ª –∑–∞–≤–µ—Ä—à–∏—Ç—å –∑–≤–æ–Ω–æ–∫
        - –†–∞–∑–≥–æ–≤–æ—Ä –¥–æ—Å—Ç–∏–≥ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
        - –ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
        - –í–æ–∑–Ω–∏–∫–ª–∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã
        
        –§—É–Ω–∫—Ü–∏—è –º–æ–∂–µ—Ç –≤–∫–ª—é—á–∞—Ç—å –ø—Ä–æ—â–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ–º.
        """
    
    @classmethod
    def get_parameters(cls) -> Dict[str, Any]:
        return {
            "type": "object",
            "properties": {
                "reason": {
                    "type": "string",
                    "description": "–ü—Ä–∏—á–∏–Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–≤–æ–Ω–∫–∞",
                    "enum": [
                        "conversation_completed",  # –†–∞–∑–≥–æ–≤–æ—Ä –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω
                        "user_request",           # –ü–æ –ø—Ä–æ—Å—å–±–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                        "time_limit_reached",     # –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –≤—Ä–µ–º–µ–Ω–∏
                        "technical_issue",        # –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞
                        "emergency"               # –≠–∫—Å—Ç—Ä–µ–Ω–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
                    ]
                },
                "farewell_message": {
                    "type": "string",
                    "description": "–ü—Ä–æ—â–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –±—É–¥–µ—Ç –ø—Ä–æ–∏–∑–Ω–µ—Å–µ–Ω–æ –ø–µ—Ä–µ–¥ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ–º –∑–≤–æ–Ω–∫–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)",
                    "maxLength": 200,
                    "examples": [
                        "–î–æ —Å–≤–∏–¥–∞–Ω–∏—è! –•–æ—Ä–æ—à–µ–≥–æ –¥–Ω—è!",
                        "–°–ø–∞—Å–∏–±–æ –∑–∞ –æ–±—Ä–∞—â–µ–Ω–∏–µ! –î–æ –≤—Å—Ç—Ä–µ—á–∏!",
                        "–í—Å–µ–≥–æ –¥–æ–±—Ä–æ–≥–æ!",
                        "–û–±—Ä–∞—â–∞–π—Ç–µ—Å—å –µ—â–µ!"
                    ]
                }
            },
            "required": ["reason"]
        }
    
    @classmethod
    def get_example_prompt(cls) -> str:
        return """
<p><strong>‚ö†Ô∏è –í–ê–ñ–ù–û:</strong> –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç <strong>–¢–û–õ–¨–ö–û</strong> –ø—Ä–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–Ω—ã—Ö –∑–≤–æ–Ω–∫–∞—Ö —á–µ—Ä–µ–∑ Voximplant!</p>

<p>–ò—Å–ø–æ–ª—å–∑—É–π —Ñ—É–Ω–∫—Ü–∏—é <code>hangup_call</code> –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–Ω–æ–≥–æ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞.</p>

<p><strong>–ö–æ–≥–¥–∞ –∑–∞–≤–µ—Ä—à–∞—Ç—å –∑–≤–æ–Ω–æ–∫:</strong></p>
<ul>
    <li>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–±–ª–∞–≥–æ–¥–∞—Ä–∏–ª –∏ –ø–æ–ø—Ä–æ—â–∞–ª—Å—è ("—Å–ø–∞—Å–∏–±–æ, –¥–æ —Å–≤–∏–¥–∞–Ω–∏—è")</li>
    <li>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä—è–º–æ –ø–æ–ø—Ä–æ—Å–∏–ª –∑–∞–≤–µ—Ä—à–∏—Ç—å –∑–≤–æ–Ω–æ–∫</li>
    <li>–†–∞–∑–≥–æ–≤–æ—Ä –¥–æ—Å—Ç–∏–≥ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è (–≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã —Ä–µ—à–µ–Ω—ã)</li>
    <li>–ü—Ä–µ–≤—ã—à–µ–Ω–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è —Ä–∞–∑–≥–æ–≤–æ—Ä–∞</li>
    <li>–í–æ–∑–Ω–∏–∫–ª–∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã (–ø–ª–æ—Ö–∞—è —Å–≤—è–∑—å, –æ—à–∏–±–∫–∏)</li>
</ul>

<p><strong>‚ö†Ô∏è –ù–ï –∑–∞–≤–µ—Ä—à–∞–π –∑–≤–æ–Ω–æ–∫ –µ—Å–ª–∏:</strong></p>
<ul>
    <li>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–¥–∞–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã</li>
    <li>–†–∞–∑–≥–æ–≤–æ—Ä –≤—Å–µ –µ—â–µ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–µ–Ω</li>
    <li>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —è–≤–Ω–æ —Ö–æ—á–µ—Ç –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –æ–±—â–µ–Ω–∏–µ</li>
    <li>–ï—Å—Ç—å –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ (–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ, –∑–∞–ø–∏—Å—å –¥–∞–Ω–Ω—ã—Ö)</li>
</ul>

<p><strong>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ—É–Ω–∫—Ü–∏–∏:</strong></p>
<ul>
    <li><code>reason</code> ‚Äî –ø—Ä–∏—á–∏–Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</li>
    <li><code>farewell_message</code> ‚Äî –ø—Ä–æ—â–∞–ª—å–Ω–∞—è —Ñ—Ä–∞–∑–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –º–∞–∫—Å 200 —Å–∏–º–≤–æ–ª–æ–≤)</li>
</ul>

<p><strong>–ü—Ä–∏—á–∏–Ω—ã –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è (reason):</strong></p>
<ul>
    <li><code>conversation_completed</code> ‚Äî —Ä–∞–∑–≥–æ–≤–æ—Ä –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω ‚úÖ</li>
    <li><code>user_request</code> ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ø—Ä–æ—Å–∏–ª –∑–∞–∫–æ–Ω—á–∏—Ç—å üëã</li>
    <li><code>time_limit_reached</code> ‚Äî –ø—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –≤—Ä–µ–º–µ–Ω–∏ ‚è∞</li>
    <li><code>technical_issue</code> ‚Äî —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞ ‚ö†Ô∏è</li>
    <li><code>emergency</code> ‚Äî —ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ üö®</li>
</ul>

<p><strong>–ü—Ä–∏–º–µ—Ä—ã –≤—ã–∑–æ–≤–∞:</strong></p>

<p>–ü—Ä–∏–º–µ—Ä 1 - –ù–æ—Ä–º–∞–ª—å–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ:</p>
<pre>{
  "reason": "conversation_completed",
  "farewell_message": "–î–æ —Å–≤–∏–¥–∞–Ω–∏—è! –•–æ—Ä–æ—à–µ–≥–æ –¥–Ω—è!"
}</pre>

<p>–ü—Ä–∏–º–µ—Ä 2 - –ü–æ –ø—Ä–æ—Å—å–±–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</p>
<pre>{
  "reason": "user_request",
  "farewell_message": "–°–ø–∞—Å–∏–±–æ –∑–∞ –æ–±—Ä–∞—â–µ–Ω–∏–µ! –û–±—Ä–∞—â–∞–π—Ç–µ—Å—å –µ—â–µ!"
}</pre>

<p>–ü—Ä–∏–º–µ—Ä 3 - –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –≤—Ä–µ–º–µ–Ω–∏:</p>
<pre>{
  "reason": "time_limit_reached",
  "farewell_message": "–ò–∑–≤–∏–Ω–∏—Ç–µ, –≤—Ä–µ–º—è —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ –∏—Å—Ç–µ–∫–ª–æ. –í—Å–µ–≥–æ –¥–æ–±—Ä–æ–≥–æ!"
}</pre>

<p><strong>üí° –ü—Ä–∏–º–µ—Ä—ã –ø—Ä–æ—â–∞–ª—å–Ω—ã—Ö —Ñ—Ä–∞–∑:</strong></p>
<ul>
    <li>"–î–æ —Å–≤–∏–¥–∞–Ω–∏—è! –•–æ—Ä–æ—à–µ–≥–æ –¥–Ω—è!" (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è)</li>
    <li>"–°–ø–∞—Å–∏–±–æ –∑–∞ –æ–±—Ä–∞—â–µ–Ω–∏–µ! –î–æ –≤—Å—Ç—Ä–µ—á–∏!" (–¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤)</li>
    <li>"–í—Å–µ–≥–æ –¥–æ–±—Ä–æ–≥–æ! –û–±—Ä–∞—â–∞–π—Ç–µ—Å—å –µ—â–µ!" (–¥—Ä—É–∂–µ–ª—é–±–Ω–∞—è)</li>
    <li>"–î–æ —Å–≤–∏–¥–∞–Ω–∏—è!" (–∫–æ—Ä–æ—Ç–∫–∞—è)</li>
    <li>"–ü—Ä–∏—è—Ç–Ω–æ–≥–æ –¥–Ω—è! –î–æ –Ω–æ–≤—ã—Ö –≤—Å—Ç—Ä–µ—á!" (–ø–æ–∑–∏—Ç–∏–≤–Ω–∞—è)</li>
</ul>

<p><strong>üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</strong></p>
<ul>
    <li>–§—É–Ω–∫—Ü–∏—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –≤ VoxEngine —Å–∫—Ä–∏–ø—Ç–µ</li>
    <li>Backend –º–µ—Ç–æ–¥ <code>execute()</code> –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —á–µ—Ä–µ–∑ Voximplant</li>
    <li>–ü—Ä–æ—â–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –±—É–¥–µ—Ç –æ–∑–≤—É—á–µ–Ω–æ –ø–µ—Ä–µ–¥ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ–º –∑–≤–æ–Ω–∫–∞</li>
    <li>–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–∏ –∑–≤–æ–Ω–æ–∫ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è</li>
</ul>

<p><strong>–°—Ü–µ–Ω–∞—Ä–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:</strong></p>

<p><em>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</em> "–°–ø–∞—Å–∏–±–æ, —ç—Ç–æ –≤—Å–µ! –î–æ —Å–≤–∏–¥–∞–Ω–∏—è!"<br>
<em>–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç:</em> [–≤—ã–∑—ã–≤–∞–µ—Ç hangup_call —Å reason="user_request", farewell="–°–ø–∞—Å–∏–±–æ –∑–∞ –æ–±—Ä–∞—â–µ–Ω–∏–µ! –•–æ—Ä–æ—à–µ–≥–æ –¥–Ω—è!"]</p>

<p><em>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</em> "–ó–∞–∫–æ–Ω—á–∏–ª–∏, —Å–ø–∞—Å–∏–±–æ"<br>
<em>–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç:</em> [–≤—ã–∑—ã–≤–∞–µ—Ç hangup_call —Å reason="conversation_completed", farewell="–í—Å–µ–≥–æ –¥–æ–±—Ä–æ–≥–æ!"]</p>
"""
    
    @staticmethod
    async def execute(arguments: Dict[str, Any], context: Dict[str, Any] = None) -> Dict[str, Any]:
        """
        –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–∏.
        
        –í–ê–ñ–ù–û: –†–µ–∞–ª—å–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–≤–æ–Ω–∫–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ VoxEngine —Å–∫—Ä–∏–ø—Ç–µ.
        –≠—Ç–æ—Ç –º–µ—Ç–æ–¥ –≤—ã–∑—ã–≤–∞—Ç—å—Å—è –ù–ï –¥–æ–ª–∂–µ–Ω –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —á–µ—Ä–µ–∑ Voximplant.
        
        Args:
            arguments: –ê—Ä–≥—É–º–µ–Ω—Ç—ã —Ñ—É–Ω–∫—Ü–∏–∏
            context: –ö–æ–Ω—Ç–µ–∫—Å—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
            
        Returns:
            –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        """
        reason = arguments.get("reason", "unknown")
        farewell_message = arguments.get("farewell_message", "")
        
        logger.warning(f"[HANGUP] Backend execute() –≤—ã–∑–≤–∞–Ω –¥–ª—è hangup_call. –≠—Ç–æ –Ω–µ –¥–æ–ª–∂–Ω–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —á–µ—Ä–µ–∑ Voximplant!")
        logger.info(f"[HANGUP] Reason: {reason}, Farewell: {farewell_message}")
        
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        # –≠—Ç–æ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–µ –¥–æ–ª–∂–µ–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è, —Ç–∞–∫ –∫–∞–∫ —Ñ—É–Ω–∫—Ü–∏—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ VoxEngine
        return {
            "success": True,
            "message": "–§—É–Ω–∫—Ü–∏—è hangup_call –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤ VoxEngine",
            "reason": reason,
            "farewell_message": farewell_message,
            "note": "–ï—Å–ª–∏ –≤—ã –≤–∏–¥–∏—Ç–µ —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ, –∑–Ω–∞—á–∏—Ç —Ñ—É–Ω–∫—Ü–∏—è –±—ã–ª–∞ –≤—ã–∑–≤–∞–Ω–∞ –Ω–µ —á–µ—Ä–µ–∑ Voximplant",
            "timestamp": context.get("timestamp") if context else None
        }
