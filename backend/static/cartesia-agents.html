<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cartesia –∞–≥–µ–Ω—Ç—ã | Voicyfy</title>
  <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
  <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png">
  <link rel="manifest" href="/static/manifest.json">
  <meta name="theme-color" content="#7c3aed">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* ============================================================================
       CSS VARIABLES
       ============================================================================ */
    :root {
      --primary-blue: #2563eb;
      --primary-blue-light: #3b82f6;
      --primary-blue-dark: #1d4ed8;
      --text-dark: #0f172a;
      --text-gray: #64748b;
      --text-light: #94a3b8;
      --bg-light: #f8fafc;
      --bg-blue-light: #eff6ff;
      --white: #ffffff;
      --border-color: #e2e8f0;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --radius-md: 0.5rem;
      --radius-lg: 1rem;
      --cartesia-gradient: linear-gradient(135deg, #7c3aed, #5b21b6);
      --cartesia-light: #ede9fe;
      --cartesia-accent: #8b5cf6;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    body { background-color: var(--bg-light); color: var(--text-dark); min-height: 100vh; display: flex; }

    /* ============================================================================
       SIDEBAR
       ============================================================================ */
    .sidebar {
      width: 260px;
      background-color: var(--white);
      border-right: 1px solid var(--border-color);
      height: 100vh;
      position: fixed;
      left: 0;
      top: 0;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      z-index: 50;
    }

    .sidebar-header {
      padding: 1.5rem;
      border-bottom: 1px solid var(--border-color);
    }

    .sidebar-logo {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text-dark);
      text-decoration: none;
    }

    .logo-icon {
      width: 30px;
      height: 30px;
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .logo-icon img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      border-radius: var(--radius-md);
    }

    .sidebar-nav { padding: 1.5rem 0; flex-grow: 1; }

    .sidebar-section {
      padding: 0 1.5rem;
      margin-bottom: 0.75rem;
      color: var(--text-light);
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-weight: 600;
    }

    .sidebar-nav-item {
      display: flex;
      align-items: center;
      padding: 0.75rem 1.5rem;
      color: var(--text-gray);
      text-decoration: none;
      transition: background-color 0.2s, color 0.2s;
      border-left: 3px solid transparent;
    }

    .sidebar-nav-item:hover {
      background-color: var(--cartesia-light);
      color: var(--cartesia-accent);
    }

    .sidebar-nav-item.active {
      background-color: var(--cartesia-light);
      color: var(--cartesia-accent);
      border-left-color: var(--cartesia-accent);
      font-weight: 600;
    }

    .sidebar-nav-item i { margin-right: 0.75rem; width: 20px; text-align: center; }

    .sidebar-footer {
      padding: 1rem 1.5rem;
      border-top: 1px solid var(--border-color);
    }

    /* Plan-locked features */
    .plan-locked-feature {
      opacity: 0.6;
      cursor: pointer !important;
      position: relative;
    }

    .plan-locked-feature::after {
      content: "üîí";
      font-size: 0.875rem;
      position: absolute;
      right: 1.5rem;
    }

    .plan-locked-feature:hover {
      opacity: 0.8;
      background-color: var(--cartesia-light);
    }

    /* ============================================================================
       MAIN CONTENT
       ============================================================================ */
    .main-content {
      flex: 1;
      margin-left: 260px;
      padding: 0;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    /* ============================================================================
       TOP NAV
       ============================================================================ */
    .top-nav {
      background-color: var(--white);
      border-bottom: 1px solid var(--border-color);
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
      position: sticky;
      top: 0;
      z-index: 40;
    }

    .top-nav-left { display: flex; align-items: center; gap: 1rem; }

    .page-title {
      font-size: 1.25rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .top-nav-right { display: flex; align-items: center; gap: 1rem; }

    .mobile-menu-toggle {
      display: none;
      background: none;
      border: none;
      font-size: 1.25rem;
      color: var(--text-gray);
      cursor: pointer;
      padding: 0.5rem;
    }

    /* ============================================================================
       BUTTONS
       ============================================================================ */
    .btn {
      padding: 0.6rem 1.25rem;
      border-radius: var(--radius-md);
      font-weight: 500;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      border: none;
    }

    .btn-primary { background: var(--cartesia-gradient); color: white; }
    .btn-primary:hover { opacity: 0.9; transform: translateY(-1px); }

    .btn-outline {
      border: 1px solid var(--border-color);
      background-color: var(--white);
      color: var(--text-gray);
    }
    .btn-outline:hover { background-color: var(--bg-light); }

    .btn-secondary {
      background-color: var(--bg-light);
      color: var(--text-gray);
      border: 1px solid var(--border-color);
    }
    .btn-secondary:hover { background-color: var(--border-color); }

    .btn-danger { background-color: #ef4444; color: white; }
    .btn-danger:hover { background-color: #dc2626; }

    .btn-sm { padding: 0.375rem 0.75rem; font-size: 0.8125rem; }

    .btn-icon {
      background: none;
      border: none;
      color: var(--text-gray);
      cursor: pointer;
      padding: 0.5rem;
      border-radius: var(--radius-md);
      transition: all 0.2s;
    }
    .btn-icon:hover { background-color: var(--bg-light); color: var(--cartesia-accent); }

    /* ============================================================================
       USER DROPDOWN
       ============================================================================ */
    .user-menu { display: flex; align-items: center; gap: 1rem; position: relative; }

    .user-button {
      background: none;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      color: var(--text-dark);
      font-weight: 500;
      padding: 0.5rem 1rem;
      border-radius: var(--radius-md);
      transition: background-color 0.2s;
    }
    .user-button:hover { background-color: var(--bg-light); }

    .user-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--cartesia-gradient);
      display: flex;
      justify-content: center;
      align-items: center;
      color: white;
      font-weight: 600;
      font-size: 0.875rem;
    }

    .user-dropdown {
      position: absolute;
      top: calc(100% + 0.5rem);
      right: 0;
      background-color: var(--white);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-md);
      min-width: 200px;
      z-index: 100;
      overflow: hidden;
      display: none;
    }

    .user-dropdown.show {
      display: block;
      animation: dropdown-fade 0.2s ease-in-out forwards;
    }

    @keyframes dropdown-fade {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .dropdown-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1rem;
      color: var(--text-gray);
      text-decoration: none;
      font-size: 0.875rem;
      transition: background-color 0.2s;
    }
    .dropdown-item:hover { background-color: var(--bg-light); color: var(--cartesia-accent); }

    .dropdown-divider { height: 1px; background-color: var(--border-color); margin: 0.25rem 0; }

    /* ============================================================================
       CONTENT AREA
       ============================================================================ */
    .content-container { padding: 2rem; flex-grow: 1; }

    /* ============================================================================
       API KEYS CARD
       ============================================================================ */
    .api-keys-card {
      background: var(--white);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-color);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: var(--shadow-sm);
    }

    .api-keys-card h3 {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .api-key-row {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }
    .api-key-row label { min-width: 180px; font-size: 0.875rem; color: var(--text-gray); font-weight: 500; }
    .api-key-row input {
      flex: 1;
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      font-size: 0.875rem;
      font-family: monospace;
    }
    .api-key-row input:focus {
      outline: none;
      border-color: var(--cartesia-accent);
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    }

    .api-key-actions { display: flex; gap: 0.5rem; }

    .api-key-warning {
      background: #fef3c7;
      border: 1px solid #fbbf24;
      border-radius: var(--radius-md);
      padding: 0.75rem 1rem;
      margin-top: 1rem;
      font-size: 0.875rem;
      color: #92400e;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    /* ============================================================================
       API KEY SETUP SCREEN
       ============================================================================ */
    .api-key-setup {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 50vh;
      padding: 2rem;
    }
    .api-key-setup.show { display: flex; }

    .api-key-setup-icon {
      font-size: 4rem;
      background: var(--cartesia-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 1.5rem;
    }

    .api-key-setup-title { font-size: 2rem; font-weight: 600; margin-bottom: 1rem; text-align: center; }

    .api-key-setup-description {
      color: var(--text-gray);
      max-width: 600px;
      text-align: center;
      margin-bottom: 2rem;
      line-height: 1.6;
    }

    .api-key-setup-steps {
      background-color: var(--white);
      border-radius: var(--radius-lg);
      padding: 2rem;
      max-width: 600px;
      width: 100%;
      box-shadow: var(--shadow-md);
      margin-bottom: 2rem;
    }
    .api-key-setup-steps h3 { margin-bottom: 1rem; }
    .api-key-setup-steps ol { padding-left: 1.5rem; line-height: 1.8; }
    .api-key-setup-steps li { margin-bottom: 0.5rem; }
    .api-key-setup-steps a { color: var(--cartesia-accent); text-decoration: none; }
    .api-key-setup-steps a:hover { text-decoration: underline; }

    /* ============================================================================
       CARD & AGENTS LIST
       ============================================================================ */
    .card {
      background-color: var(--white);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border-color);
      margin-bottom: 2rem;
      padding: 1.5rem;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .card-title { font-size: 1.125rem; font-weight: 600; }

    .agents-list-container { display: none; margin-top: 0; }
    .agents-list-container.show { display: block; }

    .agent-list-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .agents-count { color: var(--text-gray); font-weight: 500; margin: 0; }

    .agent-items {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
      gap: 1.5rem;
    }

    .agent-item {
      background-color: var(--white);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border-color);
      padding: 1.5rem;
      display: flex;
      gap: 1.25rem;
      transition: all 0.2s;
      position: relative;
    }
    .agent-item:hover { box-shadow: var(--shadow-md); transform: translateY(-2px); }

    .cartesia-badge {
      position: absolute;
      top: 0.75rem;
      right: 0.75rem;
      background: var(--cartesia-gradient);
      color: white;
      padding: 0.25rem 0.75rem;
      border-radius: 1rem;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      box-shadow: 0 2px 8px rgba(124, 58, 237, 0.3);
    }

    .agent-icon {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: var(--cartesia-gradient);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.5rem;
      flex-shrink: 0;
    }

    .agent-info { flex: 1; min-width: 0; }

    .agent-name {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .agent-description {
      color: var(--text-gray);
      margin-bottom: 0.75rem;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      font-size: 0.95rem;
    }

    .agent-meta {
      display: flex;
      gap: 1rem;
      color: var(--text-light);
      font-size: 0.875rem;
    }

    .agent-actions {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      justify-content: center;
    }

    /* ============================================================================
       EMPTY STATE
       ============================================================================ */
    .empty-state { text-align: center; padding: 3rem 1rem; }
    .empty-icon { font-size: 3rem; color: var(--text-light); margin-bottom: 1rem; }
    .empty-title { font-size: 1.5rem; font-weight: 600; margin-bottom: 0.75rem; }
    .empty-description { color: var(--text-gray); max-width: 500px; margin: 0 auto 2rem; }

    /* ============================================================================
       EDIT CONTAINER
       ============================================================================ */
    .edit-container { display: none; }
    .edit-container.show { display: block; }

    /* Tabs */
    .tabs {
      display: flex;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 0;
    }

    .tab {
      padding: 0.75rem 1.5rem;
      color: var(--text-gray);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      font-weight: 500;
      background: none;
      border-top: none;
      border-left: none;
      border-right: none;
      font-size: 0.875rem;
    }
    .tab:hover { color: var(--text-dark); }
    .tab.active { color: var(--cartesia-accent); border-bottom-color: var(--cartesia-accent); font-weight: 600; }

    .tab-content { display: none; padding: 1.5rem; }
    .tab-content.active { display: block; }

    /* ============================================================================
       FORM
       ============================================================================ */
    .form-section {
      background-color: var(--white);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border-color);
      margin-bottom: 2rem;
      padding: 1.5rem;
    }

    .form-group { margin-bottom: 1.5rem; }
    .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.875rem; color: var(--text-dark); }
    .form-group .hint { font-size: 0.75rem; color: var(--text-light); margin-top: 0.25rem; }

    .form-control {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      font-size: 0.875rem;
      color: var(--text-dark);
      transition: all 0.2s;
    }
    .form-control:focus {
      outline: none;
      border-color: var(--cartesia-accent);
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    }
    textarea.form-control { min-height: 150px; resize: vertical; font-family: inherit; }

    .form-footer {
      display: flex;
      justify-content: flex-end;
      gap: 1rem;
      margin-top: 2rem;
    }

    /* Slider */
    .slider-container { display: flex; align-items: center; gap: 1rem; }
    .slider-container input[type="range"] {
      flex: 1;
      -webkit-appearance: none;
      height: 6px;
      border-radius: 3px;
      background: var(--border-color);
      outline: none;
    }
    .slider-container input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--cartesia-accent);
      cursor: pointer;
    }
    .slider-value { min-width: 40px; text-align: center; font-weight: 600; color: var(--cartesia-accent); }

    /* Agent ID info */
    .agent-id-info {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem;
      background-color: var(--cartesia-light);
      border-radius: var(--radius-md);
      border: 1px solid var(--cartesia-accent);
      margin-bottom: 1.5rem;
    }
    .agent-id-label { font-weight: 600; color: var(--text-dark); font-size: 0.875rem; }
    .agent-id-value {
      font-family: monospace;
      font-size: 0.85rem;
      color: var(--cartesia-accent);
      background-color: var(--white);
      padding: 0.375rem 0.75rem;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-color);
      user-select: all;
    }
    .copy-id-btn { margin-left: auto; }

    /* ============================================================================
       FUNCTIONS
       ============================================================================ */
    .function-option {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s;
    }
    .function-option:hover { background-color: var(--cartesia-light); }
    .function-option input { margin: 0; }

    .function-info {
      border: 1px solid var(--border-color);
      margin-top: 1rem;
      padding: 1rem;
      background-color: var(--bg-light);
      border-radius: var(--radius-md);
    }

    .function-schema {
      background-color: var(--white);
      padding: 1rem;
      border-radius: var(--radius-md);
      overflow-x: auto;
      font-family: monospace;
      font-size: 0.875rem;
      color: var(--text-dark);
      white-space: pre-wrap;
    }

    .functions-loading {
      text-align: center;
      padding: 2rem;
      color: var(--text-gray);
    }
    .functions-loading i { font-size: 2rem; margin-bottom: 1rem; animation: spin 1s linear infinite; }

    /* ============================================================================
       NOTIFICATIONS
       ============================================================================ */
    .notification {
      position: fixed;
      top: 1rem;
      right: 1rem;
      background-color: var(--white);
      border-radius: var(--radius-md);
      padding: 1rem;
      box-shadow: var(--shadow-md);
      max-width: 400px;
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      transition: transform 0.3s, opacity 0.3s;
      transform: translateY(-20px);
      opacity: 0;
    }
    .notification.show { transform: translateY(0); opacity: 1; }
    .notification-success { border-left: 4px solid #10b981; }
    .notification-error { border-left: 4px solid #ef4444; }
    .notification-info { border-left: 4px solid var(--cartesia-accent); }
    .notification-icon { font-size: 1.25rem; }
    .notification-success .notification-icon { color: #10b981; }
    .notification-error .notification-icon { color: #ef4444; }
    .notification-info .notification-icon { color: var(--cartesia-accent); }
    .notification-content { flex: 1; }
    .notification-close { background: none; border: none; color: var(--text-gray); cursor: pointer; font-size: 1.125rem; }

    /* ============================================================================
       LOADING
       ============================================================================ */
    .loading-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: rgba(255, 255, 255, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 500;
    }
    .loading-overlay.show { display: flex; }

    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 5px solid var(--cartesia-light);
      border-radius: 50%;
      border-top-color: var(--cartesia-accent);
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ============================================================================
       CONFIRM MODAL
       ============================================================================ */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      z-index: 600;
      justify-content: center;
      align-items: center;
    }
    .modal-overlay.show { display: flex; }

    .modal-box {
      background: var(--white);
      border-radius: var(--radius-lg);
      padding: 2rem;
      max-width: 400px;
      width: 90%;
      box-shadow: var(--shadow-lg);
      animation: modal-slide-up 0.3s ease-out;
    }
    .modal-box h3 { margin-bottom: 0.75rem; }
    .modal-box p { color: var(--text-gray); margin-bottom: 1.5rem; font-size: 0.875rem; }
    .modal-actions { display: flex; justify-content: flex-end; gap: 0.75rem; }

    @keyframes modal-slide-up {
      from { opacity: 0; transform: translateY(30px) scale(0.95); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }

    /* ============================================================================
       FEATURE BLOCKED MODAL
       ============================================================================ */
    .feature-blocked-modal {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      z-index: 9999;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .feature-blocked-modal.show {
      display: flex;
      animation: modal-fade-in 0.3s ease-in-out;
    }
    .feature-blocked-modal .fb-overlay {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
    }
    .feature-blocked-modal .fb-content {
      position: relative;
      background-color: var(--white);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      max-width: 450px;
      width: 100%;
      animation: modal-slide-up 0.3s ease-out;
      overflow: hidden;
    }
    .feature-blocked-modal .fb-header {
      background: linear-gradient(135deg, #f97316, #ea580c);
      color: white;
      padding: 1.5rem;
      text-align: center;
    }
    .feature-blocked-modal .fb-header i { font-size: 2.5rem; margin-bottom: 0.5rem; display: block; }
    .feature-blocked-modal .fb-header h3 { font-size: 1.25rem; font-weight: 600; }
    .feature-blocked-modal .fb-body { padding: 1.5rem; text-align: center; }
    .feature-blocked-modal .fb-body p { color: var(--text-gray); margin-bottom: 1rem; line-height: 1.6; }
    .feature-blocked-modal .current-plan-info {
      background-color: var(--bg-light);
      padding: 0.75rem 1rem;
      border-radius: var(--radius-md);
      margin-bottom: 1rem;
    }
    .feature-blocked-modal .current-plan-info span { font-weight: 600; color: var(--text-dark); }
    .feature-blocked-modal .required-plans { font-size: 0.875rem; color: var(--text-gray); }
    .feature-blocked-modal .required-plans strong { color: var(--cartesia-accent); }
    .feature-blocked-modal .fb-footer { padding: 1rem 1.5rem 1.5rem; display: flex; gap: 1rem; }
    .feature-blocked-modal .fb-footer .btn { flex: 1; justify-content: center; }

    @keyframes modal-fade-in {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* ============================================================================
       SIDEBAR OVERLAY (MOBILE)
       ============================================================================ */
    .sidebar-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 49;
    }

    /* ============================================================================
       RESPONSIVE
       ============================================================================ */
    @media (max-width: 768px) {
      .sidebar { transform: translateX(-100%); transition: transform 0.3s ease; }
      .sidebar.mobile-open { transform: translateX(0); }
      .sidebar-overlay.show { display: block; }
      .main-content { margin-left: 0; }
      .mobile-menu-toggle { display: block; }
      .top-nav { padding: 0.75rem 1rem; }
      .content-container { padding: 1rem; }
      .agent-items { grid-template-columns: 1fr; }
      .agent-item { flex-direction: column; text-align: center; }
      .agent-actions { flex-direction: row; justify-content: center; }
      .api-key-row { flex-direction: column; align-items: flex-start; }
      .api-key-row label { min-width: auto; }
      .tabs { overflow-x: auto; flex-wrap: nowrap; }
      .tab { white-space: nowrap; flex-shrink: 0; }
      .agent-id-info { flex-direction: column; align-items: flex-start; }
      .copy-id-btn { margin-left: 0; width: 100%; }
      .form-footer { flex-direction: column; }
      .user-dropdown { right: auto; left: 0; }
    }

    @media (max-width: 480px) {
      .content-container { padding: 0.5rem; }
      .form-section { padding: 1rem; }
      .agent-item { padding: 1rem; }
      .notification { right: 0.5rem; left: 0.5rem; max-width: none; }
    }
  </style>
</head>
<body>

  <!-- Sidebar Overlay (mobile) -->
  <div class="sidebar-overlay" id="sidebar-overlay"></div>

  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <a href="/" class="sidebar-logo">
        <div class="logo-icon">
          <img src="/static/images/IMG_2820.PNG" alt="Voicyfy Logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
          <div style="display:none; width: 30px; height: 30px; border-radius: 0.5rem; background: linear-gradient(135deg, #4a86e8, #2563eb); color: white; align-items: center; justify-content: center; font-size: 0.875rem;">
            <i class="fas fa-robot"></i>
          </div>
        </div>
        <span>Voicyfy</span>
      </a>
    </div>

    <nav class="sidebar-nav">
      <div class="sidebar-section">–û—Å–Ω–æ–≤–Ω–æ–µ</div>
      <a href="/static/dashboard.html" class="sidebar-nav-item"><i class="fas fa-home"></i> –î–∞—à–±–æ—Ä–¥</a>
      <a href="/static/agents.html" class="sidebar-nav-item"><i class="fas fa-robot"></i> OpenAI –∞–≥–µ–Ω—Ç—ã</a>
      <a href="/static/gemini-agents.html" class="sidebar-nav-item"><i class="fas fa-gem"></i> Gemini –∞–≥–µ–Ω—Ç—ã</a>
      <a href="/static/cartesia-agents.html" class="sidebar-nav-item active"><i class="fas fa-wave-square"></i> Cartesia –∞–≥–µ–Ω—Ç—ã</a>
      <a href="/static/knowledge-base.html" class="sidebar-nav-item"><i class="fas fa-book"></i> –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π</a>
      <a href="/static/telephony.html" class="sidebar-nav-item" data-feature="telephony"><i class="fas fa-phone"></i> –¢–µ–ª–µ—Ñ–æ–Ω–∏—è</a>
      <a href="/static/conversations.html" class="sidebar-nav-item"><i class="fas fa-comments"></i> –î–∏–∞–ª–æ–≥–∏</a>
      <a href="/static/crm.html" class="sidebar-nav-item" data-feature="crm"><i class="fas fa-address-book"></i> CRM</a>

      <div class="sidebar-section">–ò–ò –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å</div>
      <a href="/static/voice_llm_interface.html" class="sidebar-nav-item"><i class="fas fa-microphone"></i> JARVIS AI</a>
      <div class="sidebar-section">–ê–∫–∫–∞—É–Ω—Ç</div>
      <a href="/static/settings.html" class="sidebar-nav-item"><i class="fas fa-gear"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏</a>
    </nav>

    <div class="sidebar-footer">
      <a href="https://voicyfy.ru/static/index.html" class="btn btn-secondary" style="width: 100%; text-decoration: none; justify-content: center;" id="logout-button">
        <i class="fas fa-sign-out-alt"></i> –í—ã–π—Ç–∏
      </a>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Top Nav -->
    <div class="top-nav">
      <div class="top-nav-left">
        <button class="mobile-menu-toggle" id="mobile-menu-toggle"><i class="fas fa-bars"></i></button>
        <h1 class="page-title">
          <i class="fas fa-wave-square" style="color: var(--cartesia-accent);"></i>
          Cartesia –∞–≥–µ–Ω—Ç—ã
        </h1>
      </div>
      <div class="top-nav-right">
        <button class="btn btn-primary" id="create-agent-btn"><i class="fas fa-plus"></i> –°–æ–∑–¥–∞—Ç—å –∞–≥–µ–Ω—Ç–∞</button>
        <div class="user-menu">
          <button class="user-button" id="user-menu-button">
            <div class="user-avatar" id="user-avatar">?</div>
            <span id="user-name">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span>
            <i class="fas fa-chevron-down"></i>
          </button>
          <div class="user-dropdown" id="user-dropdown">
            <div style="padding: 0.75rem 1rem; font-size: 0.8125rem; color: var(--text-light);" id="user-email">-</div>
            <div class="dropdown-divider"></div>
            <a href="/static/settings.html" class="dropdown-item"><i class="fas fa-gear"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏</a>
            <a href="https://voicyfy.ru/static/index.html" class="dropdown-item" id="dropdown-logout"><i class="fas fa-sign-out-alt"></i> –í—ã–π—Ç–∏</a>
          </div>
        </div>
      </div>
    </div>

    <!-- Content Area -->
    <div class="content-container">

      <!-- API Keys Card -->
      <div class="api-keys-card" id="api-keys-card">
        <h3><i class="fas fa-key" style="color: var(--cartesia-accent);"></i> API –∫–ª—é—á–∏ –¥–ª—è Cartesia –∞–≥–µ–Ω—Ç–æ–≤</h3>

        <div class="api-key-row">
          <label>OpenAI API Key (LLM)</label>
          <input type="password" id="openai-key-input" placeholder="sk-..." autocomplete="off">
          <div class="api-key-actions">
            <button class="btn-icon" id="toggle-openai-key" title="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å"><i class="fas fa-eye"></i></button>
          </div>
        </div>

        <div class="api-key-row">
          <label>Cartesia API Key (TTS)</label>
          <input type="password" id="cartesia-key-input" placeholder="sk_car_..." autocomplete="off">
          <div class="api-key-actions">
            <button class="btn-icon" id="toggle-cartesia-key" title="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å"><i class="fas fa-eye"></i></button>
          </div>
        </div>

        <div style="display: flex; gap: 0.5rem; margin-top: 0.75rem;">
          <button class="btn btn-primary btn-sm" id="save-keys-btn"><i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–ª—é—á–∏</button>
          <button class="btn btn-secondary btn-sm" id="clear-keys-btn"><i class="fas fa-trash"></i> –û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>

        <div class="api-key-warning" id="keys-warning" style="display: none;">
          <i class="fas fa-exclamation-triangle"></i>
          <span>–î–æ–±–∞–≤—å—Ç–µ OpenAI –∏ Cartesia API –∫–ª—é—á–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã –∞–≥–µ–Ω—Ç–æ–≤</span>
        </div>
      </div>

      <!-- Setup Screen (no keys) -->
      <div class="api-key-setup" id="setup-screen">
        <div class="api-key-setup-icon"><i class="fas fa-wave-square"></i></div>
        <h2 class="api-key-setup-title">–ù–∞—Å—Ç—Ä–æ–π—Ç–µ API –∫–ª—é—á–∏</h2>
        <p class="api-key-setup-description">
          –î–ª—è —Ä–∞–±–æ—Ç—ã Cartesia –∞–≥–µ–Ω—Ç–æ–≤ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–æ–±–∞–≤–∏—Ç—å OpenAI API Key (–¥–ª—è LLM –æ–±—Ä–∞–±–æ—Ç–∫–∏) –∏ Cartesia API Key (–¥–ª—è —Å–∏–Ω—Ç–µ–∑–∞ —Ä–µ—á–∏).
        </p>
        <div class="api-key-setup-steps">
          <h3>–ö–∞–∫ –Ω–∞—á–∞—Ç—å:</h3>
          <ol>
            <li>–ü–æ–ª—É—á–∏—Ç–µ OpenAI API Key –Ω–∞ <a href="https://platform.openai.com/api-keys" target="_blank">platform.openai.com</a></li>
            <li>–ü–æ–ª—É—á–∏—Ç–µ Cartesia API Key –Ω–∞ <a href="https://play.cartesia.ai/" target="_blank">play.cartesia.ai</a></li>
            <li>–í—Å—Ç–∞–≤—å—Ç–µ –∫–ª—é—á–∏ –≤ –ø–æ–ª—è –≤—ã—à–µ –∏ –Ω–∞–∂–º–∏—Ç–µ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–ª—é—á–∏"</li>
          </ol>
        </div>
        <p style="color: var(--text-light); font-size: 0.875rem; text-align: center;">
          –ü–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–ª—é—á–µ–π –≤—ã —Å–º–æ–∂–µ—Ç–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –∏ —É–ø—Ä–∞–≤–ª—è—Ç—å Cartesia –∞–≥–µ–Ω—Ç–∞–º–∏
        </p>
      </div>

      <!-- Agents List Container -->
      <div class="agents-list-container" id="agents-list-container">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">–í–∞—à–∏ –≥–æ–ª–æ—Å–æ–≤—ã–µ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç—ã –Ω–∞ Cartesia</h2>
          </div>
          <div id="agents-list"></div>
        </div>
      </div>

      <!-- Edit Container -->
      <div class="edit-container" id="edit-container">
        <div class="form-section" style="margin-bottom: 0; border-bottom-left-radius: 0; border-bottom-right-radius: 0;">
          <div style="display: flex; align-items: center; justify-content: space-between;">
            <h2 id="edit-title" style="font-size: 1.125rem; font-weight: 600;">–ù–æ–≤—ã–π –∞–≥–µ–Ω—Ç</h2>
            <button class="btn btn-secondary btn-sm" onclick="switchToListMode()"><i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥</button>
          </div>
        </div>

        <div class="tabs">
          <button class="tab active" data-tab="settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
          <button class="tab" data-tab="functions">–§—É–Ω–∫—Ü–∏–∏</button>
        </div>

        <!-- Settings Tab -->
        <div class="tab-content active" id="tab-settings">
          <div class="form-section">
            <!-- Agent ID (—Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏) -->
            <div class="agent-id-info" id="agent-id-info" style="display: none;">
              <span class="agent-id-label">ID –∞–≥–µ–Ω—Ç–∞:</span>
              <span class="agent-id-value" id="agent-id-display">-</span>
              <button class="btn btn-outline btn-sm copy-id-btn" id="copy-agent-id"><i class="fas fa-copy"></i> –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å ID</button>
            </div>

            <div class="form-group">
              <label for="agent-name">–ù–∞–∑–≤–∞–Ω–∏–µ –∞–≥–µ–Ω—Ç–∞ *</label>
              <input type="text" class="form-control" id="agent-name" placeholder="–ú–æ–π Cartesia –∞–≥–µ–Ω—Ç" required>
            </div>

            <div class="form-group">
              <label for="agent-greeting">–ü–µ—Ä–≤–∞—è —Ñ—Ä–∞–∑–∞ (–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ)</label>
              <input type="text" class="form-control" id="agent-greeting" placeholder="–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ß–µ–º —è –º–æ–≥—É –≤–∞–º –ø–æ–º–æ—á—å?" value="–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ß–µ–º —è –º–æ–≥—É –≤–∞–º –ø–æ–º–æ—á—å?" maxlength="200">
              <p class="hint">–≠—Ç–∞ —Ñ—Ä–∞–∑–∞ –±—É–¥–µ—Ç –ø–µ—Ä–≤—ã–º, —á—Ç–æ —Å–∫–∞–∂–µ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø—Ä–∏ –∑–≤–æ–Ω–∫–µ. –ú–∞–∫—Å–∏–º—É–º 200 —Å–∏–º–≤–æ–ª–æ–≤.</p>
            </div>

            <div class="form-group">
              <label for="agent-description">–û–ø–∏—Å–∞–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
              <input type="text" class="form-control" id="agent-description" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∞–≥–µ–Ω—Ç–∞">
            </div>

            <div class="form-group">
              <label for="agent-system-prompt">–°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç</label>
              <textarea class="form-control" id="agent-system-prompt" placeholder="–í—ã ‚Äî –≥–æ–ª–æ—Å–æ–≤–æ–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. –û—Ç–≤–µ—á–∞–π—Ç–µ –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ —Å—É—â–µ—Å—Ç–≤—É." rows="6"></textarea>
              <p class="hint">–ó–∞–¥–∞–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –≤–∞—à–µ–≥–æ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞. –≠—Ç–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç –µ–≥–æ –∑–Ω–∞–Ω–∏—è, —Å—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è –∏ –ø–æ–≤–µ–¥–µ–Ω–∏–µ.</p>
            </div>

            <div class="form-group">
              <label for="agent-voice-id">Cartesia Voice ID</label>
              <input type="text" class="form-control" id="agent-voice-id" placeholder="a0e99841-438c-4a64-b679-ae501e7d6091">
              <p class="hint">ID –≥–æ–ª–æ—Å–∞ –∏–∑ –ª–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞ <a href="https://play.cartesia.ai/" target="_blank" style="color: var(--cartesia-accent);">play.cartesia.ai</a></p>
            </div>

            <div class="form-group">
              <label>–°–∫–æ—Ä–æ—Å—Ç—å –≥–æ–ª–æ—Å–∞</label>
              <div class="slider-container">
                <span style="font-size: 0.75rem; color: var(--text-light);">0.5x</span>
                <input type="range" id="agent-voice-speed" min="0.5" max="1.5" step="0.1" value="1.0">
                <span style="font-size: 0.75rem; color: var(--text-light);">1.5x</span>
                <span class="slider-value" id="voice-speed-value">1.0</span>
              </div>
            </div>

            <div class="form-footer">
              <button class="btn btn-secondary" onclick="switchToListMode()">–û—Ç–º–µ–Ω–∞</button>
              <button class="btn btn-danger" id="delete-agent-btn" style="display: none;" onclick="confirmDeleteAgent()"><i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å</button>
              <button class="btn btn-primary" id="save-agent-btn" onclick="saveAgent()"><i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
          </div>
        </div>

        <!-- Functions Tab -->
        <div class="tab-content" id="tab-functions">
          <div class="form-section">
            <h3 style="margin-bottom: 1rem;">–§—É–Ω–∫—Ü–∏–∏ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞</h3>
            <p style="color: var(--text-gray); font-size: 0.875rem; margin-bottom: 1rem;">–í–∫–ª—é—á–∏—Ç–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≤–∞—à–µ–≥–æ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞:</p>
            <div id="functions-container">
              <div class="functions-loading">
                <i class="fas fa-spinner"></i>
                <p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π...</p>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </main>

  <!-- Notification -->
  <div class="notification notification-success" id="notification" style="display: none;">
    <div class="notification-icon"><i class="fas fa-check-circle"></i></div>
    <div class="notification-content"><div id="notification-message">–û–ø–µ—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞!</div></div>
    <button class="notification-close" id="notification-close">&times;</button>
  </div>

  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loading-overlay"><div class="loading-spinner"></div></div>

  <!-- Confirm Modal -->
  <div class="modal-overlay" id="confirm-modal">
    <div class="modal-box">
      <h3 id="confirm-title">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h3>
      <p id="confirm-message">–í—ã —É–≤–µ—Ä–µ–Ω—ã?</p>
      <div class="modal-actions">
        <button class="btn btn-secondary" id="confirm-cancel">–û—Ç–º–µ–Ω–∞</button>
        <button class="btn btn-danger" id="confirm-ok">–£–¥–∞–ª–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <!-- Feature Blocked Modal -->
  <div class="feature-blocked-modal" id="feature-blocked-modal">
    <div class="fb-overlay" id="feature-modal-overlay"></div>
    <div class="fb-content">
      <div class="fb-header">
        <i class="fas fa-lock"></i>
        <h3>–§—É–Ω–∫—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</h3>
      </div>
      <div class="fb-body">
        <p id="feature-blocked-message">–î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–º—É —Ä–∞–∑–¥–µ–ª—É –Ω–µ–æ–±—Ö–æ–¥–∏–º —Ç–∞—Ä–∏—Ñ –°—Ç–∞—Ä—Ç –∏–ª–∏ Profi.</p>
        <div class="current-plan-info">
          –í–∞—à —Ç–µ–∫—É—â–∏–π —Ç–∞—Ä–∏—Ñ: <span id="current-plan-name-display">-</span>
        </div>
        <p class="required-plans">
          –ù–µ–æ–±—Ö–æ–¥–∏–º —Ç–∞—Ä–∏—Ñ: <strong id="required-plans-text">–°—Ç–∞—Ä—Ç –∏–ª–∏ Profi</strong>
        </p>
      </div>
      <div class="fb-footer">
        <button class="btn btn-secondary" id="feature-modal-close">–ó–∞–∫—Ä—ã—Ç—å</button>
        <button class="btn btn-primary" id="feature-modal-upgrade"><i class="fas fa-arrow-up"></i> –í—ã–±—Ä–∞—Ç—å —Ç–∞—Ä–∏—Ñ</button>
      </div>
    </div>
  </div>

  <!-- ============================================================================
       JAVASCRIPT
       ============================================================================ -->
  <script>
    // ============================================================================
    // CONSTANTS
    // ============================================================================
    const PRIVILEGED_USERS = ['well96well@gmail.com', 'stas@gmail.com'];
    const SPECIAL_ASSISTANT_LIMITS = { 'v83839370@gmail.com': 25 };

    const FEATURE_ACCESS = {
      crm: ['free', 'referral_trial', 'start', 'profi'],
      telephony: ['free', 'referral_trial', 'start', 'profi'],
      outbound_calls: ['free', 'referral_trial', 'start', 'profi']
    };

    const FEATURE_NAMES = {
      crm: 'CRM',
      telephony: '–¢–µ–ª–µ—Ñ–æ–Ω–∏—è',
      outbound_calls: '–ò—Å—Ö–æ–¥—è—â–∏–µ –∑–≤–æ–Ω–∫–∏'
    };

    const PLAN_NAMES = {
      'free': '–ü—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥',
      'referral_trial': '–†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π —Ç—Ä–∏–∞–ª',
      'ai_voice': 'AI Voice',
      'start': '–¢–∞—Ä–∏—Ñ –°—Ç–∞—Ä—Ç',
      'profi': 'Profi'
    };

    const API_BASE_URL = '/api';

    // ============================================================================
    // STATE
    // ============================================================================
    let currentUser = null;
    let currentAgentId = null;
    let agents = [];
    let availableFunctions = [];
    let isLoading = false;
    let currentUserPlanCode = 'free';

    let assistantsLimitInfo = {
      openaiCount: 0,
      geminiCount: 0,
      grokCount: 0,
      cartesiaCount: 0,
      totalCount: 0,
      maxAllowed: 3,
      canCreate: true
    };

    // ============================================================================
    // AUTH & API
    // ============================================================================
    function getToken() {
      return localStorage.getItem('auth_token');
    }

    function checkAuth() {
      if (!getToken()) {
        window.location.href = '/static/index.html';
        return false;
      }
      return true;
    }

    async function apiRequest(endpoint, options = {}) {
      const token = getToken();
      if (!options.headers) options.headers = {};
      options.headers['Authorization'] = `Bearer ${token}`;

      if (options.body && typeof options.body !== 'string' && !(options.body instanceof FormData)) {
        options.headers['Content-Type'] = 'application/json';
        options.body = JSON.stringify(options.body);
      }

      try {
        const response = await fetch(`${API_BASE_URL}${endpoint}`, { ...options });

        if (response.status === 401) {
          localStorage.removeItem('auth_token');
          window.location.href = '/static/index.html';
          throw new Error('–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è');
        }

        if (response.status === 204) return null;

        const data = await response.json();
        if (!response.ok) throw new Error(data.detail || '–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞');
        return data;
      } catch (error) {
        console.error('API Error:', error);
        throw error;
      }
    }

    // ============================================================================
    // USER DATA
    // ============================================================================
    async function loadUserData() {
      try {
        currentUser = await apiRequest('/users/me');
        updateUserUI();
        return currentUser;
      } catch (e) {
        console.error('Error loading user:', e);
        return null;
      }
    }

    function updateUserUI() {
      if (!currentUser) return;

      const firstName = currentUser.first_name || '';
      const lastName = currentUser.last_name || '';

      if (firstName || lastName) {
        document.getElementById('user-name').textContent = firstName + (lastName ? ` ${lastName}` : '');
        let initials = '';
        if (firstName) initials += firstName[0];
        if (lastName) initials += lastName[0];
        document.getElementById('user-avatar').textContent = initials.toUpperCase();
      } else if (currentUser.company_name) {
        document.getElementById('user-name').textContent = currentUser.company_name;
        document.getElementById('user-avatar').textContent = currentUser.company_name.substring(0, 2).toUpperCase();
      } else {
        document.getElementById('user-name').textContent = currentUser.email;
        document.getElementById('user-avatar').textContent = currentUser.email.substring(0, 2).toUpperCase();
      }

      document.getElementById('user-email').textContent = currentUser.email;
    }

    // ============================================================================
    // PRIVILEGES & LIMITS (–∫–∞–∫ –≤ Gemini)
    // ============================================================================
    function isPrivilegedUser() {
      if (!currentUser) return false;
      return currentUser.is_admin || PRIVILEGED_USERS.includes(currentUser.email);
    }

    function getSpecialLimit() {
      if (currentUser && currentUser.email && SPECIAL_ASSISTANT_LIMITS[currentUser.email]) {
        return SPECIAL_ASSISTANT_LIMITS[currentUser.email];
      }
      return null;
    }

    async function loadAssistantsLimitInfo() {
      try {
        console.log('[LIMITS] –ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ª–∏–º–∏—Ç–∞—Ö –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–≤...');

        if (isPrivilegedUser()) {
          console.log('[LIMITS] –ü—Ä–∏–≤–∏–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Äî –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø');
          assistantsLimitInfo = {
            openaiCount: 0, geminiCount: 0, grokCount: 0, cartesiaCount: 0,
            totalCount: 0, maxAllowed: 999999, canCreate: true
          };
          return assistantsLimitInfo;
        }

        const [openaiAssistants, geminiAssistants, grokAssistants, cartesiaData, subscription] = await Promise.all([
          apiRequest('/assistants').catch(() => []),
          apiRequest('/gemini-assistants').catch(() => []),
          apiRequest('/grok-assistants').catch(() => []),
          apiRequest('/cartesia-assistants').catch(() => ({ assistants: [] })),
          apiRequest('/subscriptions/my-subscription').catch(() => null)
        ]);

        const openaiCount = Array.isArray(openaiAssistants) ? openaiAssistants.length : 0;
        const geminiCount = Array.isArray(geminiAssistants) ? geminiAssistants.length : 0;
        const grokCount = Array.isArray(grokAssistants) ? grokAssistants.length : 0;
        const cartesiaCount = Array.isArray(cartesiaData) ? cartesiaData.length : (cartesiaData.assistants || []).length;
        const totalCount = openaiCount + geminiCount + grokCount + cartesiaCount;

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–¥ —Ç–µ–∫—É—â–µ–≥–æ –ø–ª–∞–Ω–∞
        if (subscription && subscription.subscription_plan && subscription.subscription_plan.code) {
          currentUserPlanCode = subscription.subscription_plan.code;
          console.log('[LIMITS] –ö–æ–¥ —Ç–∞—Ä–∏—Ñ–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', currentUserPlanCode);
        }

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ª–∏–º–∏—Ç
        let maxAllowed = 3;
        const specialLimit = getSpecialLimit();
        if (specialLimit !== null) {
          maxAllowed = specialLimit;
          console.log(`[LIMITS] –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –ª–∏–º–∏—Ç –¥–ª—è ${currentUser.email}: ${maxAllowed}`);
        } else if (subscription && subscription.subscription_plan && subscription.subscription_plan.max_assistants) {
          maxAllowed = subscription.subscription_plan.max_assistants;
        }

        assistantsLimitInfo = {
          openaiCount, geminiCount, grokCount, cartesiaCount,
          totalCount, maxAllowed,
          canCreate: totalCount < maxAllowed
        };

        console.log('[LIMITS] –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ª–∏–º–∏—Ç–∞—Ö:', assistantsLimitInfo);
        return assistantsLimitInfo;

      } catch (error) {
        console.error('[LIMITS] –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ª–∏–º–∏—Ç–∞—Ö:', error);
        assistantsLimitInfo = {
          openaiCount: 0, geminiCount: 0, grokCount: 0, cartesiaCount: 0,
          totalCount: 0, maxAllowed: 3, canCreate: true
        };
        return assistantsLimitInfo;
      }
    }

    function canCreateAssistant() {
      if (isPrivilegedUser()) return true;
      return assistantsLimitInfo.canCreate;
    }

    function showLimitReachedNotification() {
      const { totalCount, maxAllowed } = assistantsLimitInfo;
      showNotification(`–î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–≤ (${totalCount}/${maxAllowed}). –£–ª—É—á—à–∏—Ç–µ —Ç–∞—Ä–∏—Ñ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤—ã—Ö.`, 'error');
    }

    function updateCreateButtonState() {
      const btn = document.getElementById('create-agent-btn');
      if (!btn) return;
      if (!canCreateAssistant()) {
        btn.disabled = true;
        btn.title = `–î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–≤ (${assistantsLimitInfo.totalCount}/${assistantsLimitInfo.maxAllowed})`;
        btn.style.opacity = '0.6';
        btn.style.cursor = 'not-allowed';
      } else {
        btn.disabled = false;
        btn.title = '–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ –∞–≥–µ–Ω—Ç–∞';
        btn.style.opacity = '1';
        btn.style.cursor = 'pointer';
      }
    }

    // ============================================================================
    // FEATURE ACCESS (—Ç–∞—Ä–∏—Ñ—ã)
    // ============================================================================
    function canAccessFeature(feature) {
      if (!currentUser) return true;
      if (isPrivilegedUser()) return true;
      const allowedPlans = FEATURE_ACCESS[feature];
      if (!allowedPlans) return true;
      return allowedPlans.includes(currentUserPlanCode);
    }

    function getPlanDisplayName(planCode) {
      return PLAN_NAMES[planCode] || planCode;
    }

    function applyFeatureAccessToSidebar() {
      console.log('[ACCESS] –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∞—Ç—Ä–∏—Ü—É –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è –ø–ª–∞–Ω–∞:', currentUserPlanCode);
      document.querySelectorAll('.plan-locked-feature').forEach(el => el.classList.remove('plan-locked-feature'));

      document.querySelectorAll('[data-feature]').forEach(element => {
        const feature = element.getAttribute('data-feature');
        if (!canAccessFeature(feature)) {
          element.classList.add('plan-locked-feature');
          console.log(`[ACCESS] –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è: ${feature}`);
        }
      });
    }

    function showFeatureBlockedModal(feature) {
      const featureName = FEATURE_NAMES[feature] || feature;
      const planName = getPlanDisplayName(currentUserPlanCode);
      document.getElementById('feature-blocked-message').textContent = `–î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Ä–∞–∑–¥–µ–ª—É "${featureName}" –Ω–µ–æ–±—Ö–æ–¥–∏–º —Ç–∞—Ä–∏—Ñ –°—Ç–∞—Ä—Ç –∏–ª–∏ Profi.`;
      document.getElementById('current-plan-name-display').textContent = planName;
      document.getElementById('required-plans-text').textContent = '–°—Ç–∞—Ä—Ç –∏–ª–∏ Profi';
      document.getElementById('feature-blocked-modal').classList.add('show');
    }

    function hideFeatureBlockedModal() {
      document.getElementById('feature-blocked-modal').classList.remove('show');
    }

    // ============================================================================
    // NOTIFICATIONS
    // ============================================================================
    function showNotification(message, type = 'success') {
      const notification = document.getElementById('notification');
      const notificationMessage = document.getElementById('notification-message');
      const icon = notification.querySelector('.notification-icon i');

      notification.className = `notification notification-${type}`;
      notificationMessage.textContent = message;

      if (type === 'success') icon.className = 'fas fa-check-circle';
      else if (type === 'error') icon.className = 'fas fa-exclamation-circle';
      else icon.className = 'fas fa-info-circle';

      notification.style.display = 'flex';
      setTimeout(() => notification.classList.add('show'), 10);

      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.style.display = 'none', 300);
      }, 5000);
    }

    function setLoading(loading) {
      isLoading = loading;
      const overlay = document.getElementById('loading-overlay');
      if (loading) overlay.classList.add('show');
      else overlay.classList.remove('show');
    }

    // ============================================================================
    // API KEYS
    // ============================================================================
    async function loadApiKeysStatus() {
      try {
        const status = await apiRequest('/cartesia-assistants/api-keys');
        const openaiInput = document.getElementById('openai-key-input');
        const cartesiaInput = document.getElementById('cartesia-key-input');
        const warning = document.getElementById('keys-warning');

        if (status.openai_key_preview) openaiInput.placeholder = status.openai_key_preview;
        if (status.cartesia_key_preview) cartesiaInput.placeholder = status.cartesia_key_preview;

        const hasKeys = status.has_openai_key && status.has_cartesia_key;
        warning.style.display = hasKeys ? 'none' : 'flex';
        return hasKeys;
      } catch (e) {
        console.error('Error loading API keys status:', e);
        return false;
      }
    }

    async function saveApiKeys() {
      const openaiKey = document.getElementById('openai-key-input').value.trim();
      const cartesiaKey = document.getElementById('cartesia-key-input').value.trim();

      if (!openaiKey && !cartesiaKey) {
        showNotification('–í–≤–µ–¥–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∫–ª—é—á', 'error');
        return;
      }

      setLoading(true);
      try {
        const body = {};
        if (openaiKey) body.openai_api_key = openaiKey;
        if (cartesiaKey) body.cartesia_api_key = cartesiaKey;

        await apiRequest('/cartesia-assistants/api-keys', { method: 'PUT', body });

        document.getElementById('openai-key-input').value = '';
        document.getElementById('cartesia-key-input').value = '';

        showNotification('API –∫–ª—é—á–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
        const hasKeys = await loadApiKeysStatus();
        checkApiKeyAndShowContent(hasKeys);

        if (hasKeys) {
          await loadAgentsList();
          await loadAssistantsLimitInfo();
          applyFeatureAccessToSidebar();
          updateCreateButtonState();
        }
      } catch (e) {
        showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + e.message, 'error');
      } finally {
        setLoading(false);
      }
    }

    async function clearApiKeys() {
      if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å API –∫–ª—é—á–∏?')) return;

      setLoading(true);
      try {
        await apiRequest('/cartesia-assistants/api-keys', {
          method: 'PUT',
          body: { openai_api_key: '', cartesia_api_key: '' }
        });

        document.getElementById('openai-key-input').value = '';
        document.getElementById('cartesia-key-input').value = '';

        showNotification('API –∫–ª—é—á–∏ —É–¥–∞–ª–µ–Ω—ã', 'success');
        const hasKeys = await loadApiKeysStatus();
        checkApiKeyAndShowContent(hasKeys);
      } catch (e) {
        showNotification('–û—à–∏–±–∫–∞: ' + e.message, 'error');
      } finally {
        setLoading(false);
      }
    }

    function checkApiKeyAndShowContent(hasKeys) {
      const setupScreen = document.getElementById('setup-screen');
      const agentsContainer = document.getElementById('agents-list-container');
      const createBtn = document.getElementById('create-agent-btn');

      if (hasKeys) {
        setupScreen.classList.remove('show');
        agentsContainer.classList.add('show');
        createBtn.style.display = 'inline-flex';
        updateCreateButtonState();
      } else {
        setupScreen.classList.add('show');
        agentsContainer.classList.remove('show');
        createBtn.style.display = 'none';
      }
    }

    // ============================================================================
    // AGENTS CRUD
    // ============================================================================
    async function loadAgentsList() {
      try {
        const data = await apiRequest('/cartesia-assistants');
        agents = data.assistants || [];
        renderAgentsList();
      } catch (e) {
        console.error('Error loading agents:', e);
        showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≥–µ–Ω—Ç–æ–≤', 'error');
      }
    }

    function renderAgentsList() {
      const container = document.getElementById('agents-list');
      container.innerHTML = '';

      if (agents.length === 0) {
        const limitText = isPrivilegedUser()
          ? ''
          : `<br><small style="color: var(--text-light);">(${assistantsLimitInfo.totalCount}/${assistantsLimitInfo.maxAllowed} –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ)</small>`;
        const isDisabled = !canCreateAssistant();

        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon"><i class="fas fa-wave-square"></i></div>
            <h3 class="empty-title">–£ –≤–∞—Å –µ—â—ë –Ω–µ—Ç Cartesia –∞–≥–µ–Ω—Ç–æ–≤</h3>
            <p class="empty-description">
              –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤–æ–≥–æ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –Ω–∞ –±–∞–∑–µ Cartesia TTS
              ${limitText}
            </p>
            <button class="btn btn-primary" id="empty-create-btn" ${isDisabled ? 'disabled style="opacity: 0.6; cursor: not-allowed;"' : ''}>
              <i class="fas fa-plus"></i> –°–æ–∑–¥–∞—Ç—å –∞–≥–µ–Ω—Ç–∞
            </button>
          </div>
        `;

        const emptyBtn = document.getElementById('empty-create-btn');
        if (emptyBtn) {
          emptyBtn.addEventListener('click', () => {
            if (canCreateAssistant()) navigateToCreateAgent();
            else showLimitReachedNotification();
          });
        }
        return;
      }

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–∏–º–∏—Ç—ã
      const limitInfo = isPrivilegedUser()
        ? ''
        : `<small style="color: var(--text-light); font-weight: normal;">(–≤—Å–µ–≥–æ ${assistantsLimitInfo.totalCount}/${assistantsLimitInfo.maxAllowed})</small>`;

      const headerEl = document.createElement('div');
      headerEl.className = 'agent-list-header';
      headerEl.innerHTML = `<h4 class="agents-count">Cartesia –∞–≥–µ–Ω—Ç–æ–≤: ${agents.length} ${limitInfo}</h4>`;
      container.appendChild(headerEl);

      const listEl = document.createElement('div');
      listEl.className = 'agent-items';

      agents.forEach(agent => {
        const agentEl = document.createElement('div');
        agentEl.className = 'agent-item';
        agentEl.innerHTML = `
          <div class="cartesia-badge">Cartesia</div>
          <div class="agent-icon"><i class="fas fa-wave-square"></i></div>
          <div class="agent-info">
            <h3 class="agent-name">${escapeHtml(agent.name)}</h3>
            <p class="agent-description">${agent.description ? escapeHtml(agent.description) : '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'}</p>
            <div class="agent-meta">
              ${agent.cartesia_voice_id ? `<span><i class="fas fa-microphone"></i> Voice: ${escapeHtml(agent.cartesia_voice_id.substring(0, 12))}...</span>` : ''}
              <span><i class="fas fa-tachometer-alt"></i> –°–∫–æ—Ä–æ—Å—Ç—å: ${agent.voice_speed || 1.0}x</span>
              <span><i class="fas fa-calendar"></i> ${new Date(agent.created_at).toLocaleDateString('ru-RU')}</span>
            </div>
          </div>
          <div class="agent-actions">
            <button class="btn btn-primary btn-sm" onclick="editAgent('${agent.id}')"><i class="fas fa-edit"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
          </div>
        `;
        listEl.appendChild(agentEl);
      });

      container.appendChild(listEl);
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    async function loadAgentData(id) {
      setLoading(true);
      try {
        const agent = await apiRequest(`/cartesia-assistants/${id}`);
        fillAgentForm(agent);
        currentAgentId = id;
        document.getElementById('edit-title').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: ' + agent.name;
        document.getElementById('delete-agent-btn').style.display = 'inline-flex';
        document.getElementById('agent-id-display').textContent = id;
        document.getElementById('agent-id-info').style.display = 'flex';
      } catch (e) {
        showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≥–µ–Ω—Ç–∞: ' + e.message, 'error');
        switchToListMode();
      } finally {
        setLoading(false);
      }
    }

    function fillAgentForm(agent) {
      document.getElementById('agent-name').value = agent.name || '';
      document.getElementById('agent-greeting').value = agent.greeting_message || '–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ß–µ–º —è –º–æ–≥—É –≤–∞–º –ø–æ–º–æ—á—å?';
      document.getElementById('agent-description').value = agent.description || '';
      document.getElementById('agent-system-prompt').value = agent.system_prompt || '';
      document.getElementById('agent-voice-id').value = agent.cartesia_voice_id || '';

      const speedSlider = document.getElementById('agent-voice-speed');
      speedSlider.value = agent.voice_speed || 1.0;
      document.getElementById('voice-speed-value').textContent = speedSlider.value;

      loadFunctions(agent.functions || []);
    }

    function getFormData() {
      const enabledFunctions = [];
      document.querySelectorAll('input[type="checkbox"][data-function-name]:checked').forEach(cb => {
        const funcData = availableFunctions.find(f => f.name === cb.dataset.functionName);
        if (funcData) {
          enabledFunctions.push({ name: funcData.name, description: funcData.description });
        }
      });

      return {
        name: document.getElementById('agent-name').value.trim(),
        greeting_message: document.getElementById('agent-greeting').value.trim() || null,
        description: document.getElementById('agent-description').value.trim() || null,
        system_prompt: document.getElementById('agent-system-prompt').value.trim() || null,
        cartesia_voice_id: document.getElementById('agent-voice-id').value.trim() || null,
        voice_speed: parseFloat(document.getElementById('agent-voice-speed').value),
        functions: enabledFunctions.length > 0 ? enabledFunctions : null,
      };
    }

    async function saveAgent() {
      const data = getFormData();
      if (!data.name) {
        showNotification('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∞–≥–µ–Ω—Ç–∞', 'error');
        return;
      }

      setLoading(true);
      try {
        if (currentAgentId) {
          await apiRequest(`/cartesia-assistants/${currentAgentId}`, { method: 'PUT', body: data });
          showNotification('–ê–≥–µ–Ω—Ç –æ–±–Ω–æ–≤–ª—ë–Ω', 'success');
          await loadAgentData(currentAgentId);
        } else {
          if (!canCreateAssistant()) {
            showLimitReachedNotification();
            setLoading(false);
            return;
          }
          const created = await apiRequest('/cartesia-assistants', { method: 'POST', body: data });
          currentAgentId = created.id;
          showNotification('–ê–≥–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω', 'success');
          await loadAssistantsLimitInfo();
          updateCreateButtonState();
        }
        await loadAgentsList();
        switchToListMode();
      } catch (e) {
        showNotification('–û—à–∏–±–∫–∞: ' + e.message, 'error');
      } finally {
        setLoading(false);
      }
    }

    function confirmDeleteAgent() {
      if (!currentAgentId) return;
      document.getElementById('confirm-title').textContent = '–£–¥–∞–ª–∏—Ç—å –∞–≥–µ–Ω—Ç–∞?';
      document.getElementById('confirm-message').textContent = '–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å. –ê–≥–µ–Ω—Ç –±—É–¥–µ—Ç —É–¥–∞–ª—ë–Ω –Ω–∞–≤—Å–µ–≥–¥–∞.';
      document.getElementById('confirm-modal').classList.add('show');

      document.getElementById('confirm-ok').onclick = async () => {
        document.getElementById('confirm-modal').classList.remove('show');
        setLoading(true);
        try {
          await apiRequest(`/cartesia-assistants/${currentAgentId}`, { method: 'DELETE' });
          showNotification('–ê–≥–µ–Ω—Ç —É–¥–∞–ª—ë–Ω', 'success');
          currentAgentId = null;
          await loadAgentsList();
          await loadAssistantsLimitInfo();
          updateCreateButtonState();
          switchToListMode();
        } catch (e) {
          showNotification('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + e.message, 'error');
        } finally {
          setLoading(false);
        }
      };
    }

    // ============================================================================
    // FUNCTIONS
    // ============================================================================
    async function loadAvailableFunctions() {
      try {
        console.log('[FUNCTIONS] –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π...');
        const functions = await apiRequest('/functions/');
        availableFunctions = functions;
        console.log('[FUNCTIONS] –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ñ—É–Ω–∫—Ü–∏–π:', availableFunctions.length);
        renderFunctions(functions);
      } catch (error) {
        console.error('[FUNCTIONS] –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ—É–Ω–∫—Ü–∏–π:', error);
        const container = document.getElementById('functions-container');
        container.innerHTML = `
          <div style="text-align: center; padding: 2rem; color: #ef4444;">
            <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem;"></i>
            <p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ—É–Ω–∫—Ü–∏–π: ${error.message}</p>
            <button class="btn btn-outline" onclick="loadAvailableFunctions()" style="margin-top: 1rem;">
              <i class="fas fa-sync-alt"></i> –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
            </button>
          </div>
        `;
      }
    }

    function renderFunctions(functions) {
      const container = document.getElementById('functions-container');

      if (!functions || functions.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 2rem; color: var(--text-gray);">
            <i class="fas fa-inbox" style="font-size: 2rem; margin-bottom: 1rem;"></i>
            <p>–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π</p>
          </div>
        `;
        return;
      }

      container.innerHTML = '';

      functions.forEach(func => {
        const functionId = `function-${func.name}`;
        const infoId = `${func.name}-info`;

        const funcGroup = document.createElement('div');
        funcGroup.className = 'form-group';

        const label = document.createElement('label');
        label.className = 'function-option';
        label.innerHTML = `
          <input type="checkbox" id="${functionId}" name="${functionId}" data-function-name="${func.name}">
          <span>${func.display_name || func.name}</span>
        `;
        funcGroup.appendChild(label);

        const infoDiv = document.createElement('div');
        infoDiv.id = infoId;
        infoDiv.className = 'function-info';
        infoDiv.style.display = 'none';
        infoDiv.innerHTML = `
          <h4>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ñ—É–Ω–∫—Ü–∏–∏:</h4>
          <pre class="function-schema">${JSON.stringify({
            name: func.name,
            description: func.description,
            parameters: func.parameters
          }, null, 2)}</pre>
        `;
        funcGroup.appendChild(infoDiv);
        container.appendChild(funcGroup);

        const checkbox = document.getElementById(functionId);
        checkbox.addEventListener('change', function() {
          infoDiv.style.display = this.checked ? 'block' : 'none';
        });
      });
    }

    function loadFunctions(agentFunctions) {
      document.querySelectorAll('input[type="checkbox"][data-function-name]').forEach(cb => {
        cb.checked = false;
        const info = document.getElementById(`${cb.dataset.functionName}-info`);
        if (info) info.style.display = 'none';
      });

      if (!agentFunctions) return;
      agentFunctions.forEach(fn => {
        const name = fn.name || fn;
        const cb = document.querySelector(`input[data-function-name="${name}"]`);
        if (cb) {
          cb.checked = true;
          const info = document.getElementById(`${name}-info`);
          if (info) info.style.display = 'block';
        }
      });
    }

    // ============================================================================
    // NAVIGATION
    // ============================================================================
    function navigateToCreateAgent() {
      if (!canCreateAssistant()) {
        showLimitReachedNotification();
        return;
      }
      currentAgentId = null;
      initCreateMode();
      switchToEditMode();
    }

    function editAgent(id) {
      currentAgentId = id;
      switchToEditMode();
      loadAgentData(id);
    }

    function switchToEditMode() {
      document.getElementById('agents-list-container').classList.remove('show');
      document.getElementById('setup-screen').classList.remove('show');
      document.getElementById('edit-container').classList.add('show');
      document.getElementById('create-agent-btn').style.display = 'none';

      // Reset to first tab
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
      document.querySelector('.tab[data-tab="settings"]').classList.add('active');
      document.getElementById('tab-settings').classList.add('active');

      // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –µ—Å–ª–∏ –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
      if (availableFunctions.length === 0) loadAvailableFunctions();
    }

    function switchToListMode() {
      document.getElementById('edit-container').classList.remove('show');
      document.getElementById('agents-list-container').classList.add('show');
      document.getElementById('create-agent-btn').style.display = 'inline-flex';
      updateCreateButtonState();
      currentAgentId = null;
    }

    function initCreateMode() {
      document.getElementById('edit-title').textContent = '–ù–æ–≤—ã–π –∞–≥–µ–Ω—Ç';
      document.getElementById('delete-agent-btn').style.display = 'none';
      document.getElementById('agent-id-info').style.display = 'none';
      document.getElementById('agent-id-display').textContent = '-';

      document.getElementById('agent-name').value = '';
      document.getElementById('agent-greeting').value = '–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ß–µ–º —è –º–æ–≥—É –≤–∞–º –ø–æ–º–æ—á—å?';
      document.getElementById('agent-description').value = '';
      document.getElementById('agent-system-prompt').value = '';
      document.getElementById('agent-voice-id').value = '';
      document.getElementById('agent-voice-speed').value = '1.0';
      document.getElementById('voice-speed-value').textContent = '1.0';

      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–∏
      document.querySelectorAll('input[type="checkbox"][data-function-name]').forEach(cb => {
        cb.checked = false;
        const info = document.getElementById(`${cb.dataset.functionName}-info`);
        if (info) info.style.display = 'none';
      });
    }

    // ============================================================================
    // INIT
    // ============================================================================
    async function initPage() {
      if (!checkAuth()) return;

      await loadUserData();

      const hasKeys = await loadApiKeysStatus();

      if (!hasKeys) {
        checkApiKeyAndShowContent(false);
      } else {
        await loadAssistantsLimitInfo();
        applyFeatureAccessToSidebar();

        // Handle URL params
        const params = new URLSearchParams(window.location.search);
        const agentId = params.get('id');
        const mode = params.get('mode');

        if (agentId) {
          checkApiKeyAndShowContent(true);
          await loadAvailableFunctions();
          editAgent(agentId);
        } else if (mode === 'create') {
          if (!canCreateAssistant()) {
            showLimitReachedNotification();
            window.location.href = '/static/cartesia-agents.html';
            return;
          }
          checkApiKeyAndShowContent(true);
          await loadAvailableFunctions();
          navigateToCreateAgent();
        } else {
          checkApiKeyAndShowContent(true);
          await loadAgentsList();
        }
      }
    }

    // ============================================================================
    // EVENT LISTENERS
    // ============================================================================
    document.addEventListener('DOMContentLoaded', initPage);

    // Mobile menu
    document.getElementById('mobile-menu-toggle').addEventListener('click', () => {
      document.getElementById('sidebar').classList.toggle('mobile-open');
      document.getElementById('sidebar-overlay').classList.toggle('show');
    });
    document.getElementById('sidebar-overlay').addEventListener('click', () => {
      document.getElementById('sidebar').classList.remove('mobile-open');
      document.getElementById('sidebar-overlay').classList.remove('show');
    });

    // User dropdown
    document.getElementById('user-menu-button').addEventListener('click', (e) => {
      e.stopPropagation();
      document.getElementById('user-dropdown').classList.toggle('show');
    });
    document.addEventListener('click', (e) => {
      const dropdown = document.getElementById('user-dropdown');
      const button = document.getElementById('user-menu-button');
      if (dropdown.classList.contains('show') && !dropdown.contains(e.target) && !button.contains(e.target)) {
        dropdown.classList.remove('show');
      }
    });

    // Logout
    document.getElementById('logout-button').addEventListener('click', () => localStorage.removeItem('auth_token'));
    document.getElementById('dropdown-logout').addEventListener('click', () => localStorage.removeItem('auth_token'));

    // Create agent button
    document.getElementById('create-agent-btn').addEventListener('click', () => {
      if (canCreateAssistant()) navigateToCreateAgent();
      else showLimitReachedNotification();
    });

    // Copy agent ID
    document.getElementById('copy-agent-id').addEventListener('click', () => {
      const agentId = document.getElementById('agent-id-display').textContent;
      if (agentId && agentId !== '-') {
        navigator.clipboard.writeText(agentId).then(() => showNotification('ID –∞–≥–µ–Ω—Ç–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!', 'success'));
      }
    });

    // API keys
    document.getElementById('save-keys-btn').addEventListener('click', saveApiKeys);
    document.getElementById('clear-keys-btn').addEventListener('click', clearApiKeys);

    // Toggle key visibility
    document.getElementById('toggle-openai-key').addEventListener('click', () => {
      const input = document.getElementById('openai-key-input');
      input.type = input.type === 'password' ? 'text' : 'password';
    });
    document.getElementById('toggle-cartesia-key').addEventListener('click', () => {
      const input = document.getElementById('cartesia-key-input');
      input.type = input.type === 'password' ? 'text' : 'password';
    });

    // Tabs
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const tabId = tab.dataset.tab;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(`tab-${tabId}`).classList.add('active');

        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –Ω–∞ —Ç–∞–±
        if (tabId === 'functions' && availableFunctions.length === 0) loadAvailableFunctions();
      });
    });

    // Voice speed slider
    document.getElementById('agent-voice-speed').addEventListener('input', (e) => {
      document.getElementById('voice-speed-value').textContent = e.target.value;
    });

    // Confirm modal cancel
    document.getElementById('confirm-cancel').addEventListener('click', () => {
      document.getElementById('confirm-modal').classList.remove('show');
    });

    // Notification close
    document.getElementById('notification-close').addEventListener('click', () => {
      const notification = document.getElementById('notification');
      notification.classList.remove('show');
      setTimeout(() => notification.style.display = 'none', 300);
    });

    // Feature blocked modal
    document.getElementById('feature-modal-overlay').addEventListener('click', hideFeatureBlockedModal);
    document.getElementById('feature-modal-close').addEventListener('click', hideFeatureBlockedModal);
    document.getElementById('feature-modal-upgrade').addEventListener('click', () => {
      hideFeatureBlockedModal();
      window.location.href = '/static/dashboard.html';
    });

    // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ –Ω–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.querySelectorAll('[data-feature]').forEach(link => {
      link.addEventListener('click', function(e) {
        if (this.classList.contains('plan-locked-feature')) {
          e.preventDefault();
          showFeatureBlockedModal(this.getAttribute('data-feature'));
        }
      });
    });
  </script>
</body>
</html>
