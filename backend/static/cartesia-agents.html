<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cartesia агенты | Voicyfy</title>
  <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
  <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png">
  <link rel="manifest" href="/static/manifest.json">
  <meta name="theme-color" content="#7c3aed">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-blue: #2563eb;
      --primary-blue-light: #3b82f6;
      --primary-blue-dark: #1d4ed8;
      --text-dark: #0f172a;
      --text-gray: #64748b;
      --text-light: #94a3b8;
      --bg-light: #f8fafc;
      --bg-blue-light: #eff6ff;
      --white: #ffffff;
      --border-color: #e2e8f0;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --radius-md: 0.5rem;
      --radius-lg: 1rem;
      --cartesia-gradient: linear-gradient(135deg, #7c3aed, #5b21b6);
      --cartesia-light: #ede9fe;
      --cartesia-accent: #8b5cf6;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    body { background-color: var(--bg-light); color: var(--text-dark); min-height: 100vh; display: flex; }

    /* Sidebar */
    .sidebar { width: 260px; background-color: var(--white); border-right: 1px solid var(--border-color); height: 100vh; position: fixed; left: 0; top: 0; overflow-y: auto; display: flex; flex-direction: column; z-index: 50; }
    .sidebar-header { padding: 1.5rem; border-bottom: 1px solid var(--border-color); }
    .sidebar-logo { display: flex; align-items: center; gap: 0.75rem; font-size: 1.25rem; font-weight: 700; color: var(--text-dark); text-decoration: none; }
    .logo-icon { width: 30px; height: 30px; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; }
    .logo-icon img { width: 100%; height: 100%; object-fit: contain; border-radius: var(--radius-md); }
    .sidebar-nav { padding: 1.5rem 0; flex-grow: 1; }
    .sidebar-section { padding: 0.5rem 1.5rem; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; color: var(--text-light); letter-spacing: 0.05em; margin-top: 0.5rem; }
    .sidebar-nav-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.625rem 1.5rem; color: var(--text-gray); text-decoration: none; font-size: 0.875rem; transition: all 0.2s; border-left: 3px solid transparent; }
    .sidebar-nav-item:hover { background-color: var(--bg-light); color: var(--text-dark); }
    .sidebar-nav-item.active { color: var(--cartesia-accent); background-color: var(--cartesia-light); border-left-color: var(--cartesia-accent); font-weight: 600; }
    .sidebar-nav-item i { width: 20px; text-align: center; font-size: 1rem; }
    .sidebar-footer { padding: 1rem 1.5rem; border-top: 1px solid var(--border-color); }

    /* Main Content */
    .main-content { margin-left: 260px; flex: 1; min-height: 100vh; display: flex; flex-direction: column; }

    /* Top Navigation */
    .top-nav { background-color: var(--white); border-bottom: 1px solid var(--border-color); padding: 1rem 2rem; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 40; }
    .top-nav-left { display: flex; align-items: center; gap: 1rem; }
    .top-nav-title { font-size: 1.25rem; font-weight: 700; color: var(--text-dark); display: flex; align-items: center; gap: 0.5rem; }
    .top-nav-right { display: flex; align-items: center; gap: 1rem; }
    .mobile-menu-btn { display: none; background: none; border: none; font-size: 1.25rem; color: var(--text-gray); cursor: pointer; padding: 0.5rem; }

    /* Buttons */
    .btn { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; border-radius: var(--radius-md); font-size: 0.875rem; font-weight: 500; cursor: pointer; transition: all 0.2s; border: none; }
    .btn-primary { background: var(--cartesia-gradient); color: white; }
    .btn-primary:hover { opacity: 0.9; transform: translateY(-1px); }
    .btn-secondary { background-color: var(--bg-light); color: var(--text-gray); border: 1px solid var(--border-color); }
    .btn-secondary:hover { background-color: var(--border-color); }
    .btn-danger { background-color: #ef4444; color: white; }
    .btn-danger:hover { background-color: #dc2626; }
    .btn-sm { padding: 0.375rem 0.75rem; font-size: 0.8125rem; }

    /* User Dropdown */
    .user-dropdown { position: relative; }
    .user-avatar { width: 36px; height: 36px; border-radius: 50%; background: var(--cartesia-gradient); color: white; display: flex; align-items: center; justify-content: center; font-size: 0.875rem; font-weight: 600; cursor: pointer; }
    .dropdown-menu { position: absolute; right: 0; top: 100%; margin-top: 0.5rem; background: var(--white); border: 1px solid var(--border-color); border-radius: var(--radius-md); box-shadow: var(--shadow-lg); min-width: 200px; display: none; z-index: 100; }
    .dropdown-menu.show { display: block; }
    .dropdown-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; color: var(--text-gray); text-decoration: none; font-size: 0.875rem; transition: all 0.2s; }
    .dropdown-item:hover { background-color: var(--bg-light); color: var(--text-dark); }
    .dropdown-divider { height: 1px; background-color: var(--border-color); margin: 0.25rem 0; }

    /* Content Area */
    .content-area { padding: 2rem; flex: 1; }

    /* API Keys Card */
    .api-keys-card { background: var(--white); border-radius: var(--radius-lg); border: 1px solid var(--border-color); padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: var(--shadow-sm); }
    .api-keys-card h3 { font-size: 1rem; font-weight: 600; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }
    .api-key-row { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem; }
    .api-key-row label { min-width: 180px; font-size: 0.875rem; color: var(--text-gray); font-weight: 500; }
    .api-key-row input { flex: 1; padding: 0.5rem 0.75rem; border: 1px solid var(--border-color); border-radius: var(--radius-md); font-size: 0.875rem; font-family: monospace; }
    .api-key-row input:focus { outline: none; border-color: var(--cartesia-accent); box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1); }
    .api-key-actions { display: flex; gap: 0.5rem; }
    .api-key-warning { background: #fef3c7; border: 1px solid #fbbf24; border-radius: var(--radius-md); padding: 0.75rem 1rem; margin-top: 1rem; font-size: 0.875rem; color: #92400e; display: flex; align-items: center; gap: 0.5rem; }

    /* Setup Screen */
    .setup-screen { display: none; text-align: center; padding: 3rem; background: var(--white); border-radius: var(--radius-lg); border: 1px solid var(--border-color); }
    .setup-screen.show { display: block; }
    .setup-icon { font-size: 3rem; color: var(--cartesia-accent); margin-bottom: 1rem; }
    .setup-screen h2 { font-size: 1.5rem; margin-bottom: 0.5rem; }
    .setup-screen p { color: var(--text-gray); margin-bottom: 1.5rem; }

    /* Agents Grid */
    .agents-container { display: none; }
    .agents-container.show { display: block; }
    .agents-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1.5rem; margin-top: 1rem; }

    /* Agent Card */
    .agent-card { background: var(--white); border-radius: var(--radius-lg); border: 1px solid var(--border-color); overflow: hidden; transition: all 0.2s; box-shadow: var(--shadow-sm); }
    .agent-card:hover { box-shadow: var(--shadow-md); transform: translateY(-2px); }
    .agent-card-header { padding: 1.25rem 1.25rem 0; display: flex; align-items: flex-start; gap: 1rem; }
    .agent-icon { width: 48px; height: 48px; border-radius: var(--radius-md); background: var(--cartesia-gradient); color: white; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; flex-shrink: 0; }
    .agent-info { flex: 1; min-width: 0; }
    .agent-badge { display: inline-block; font-size: 0.6875rem; font-weight: 600; padding: 0.125rem 0.5rem; border-radius: 9999px; background: var(--cartesia-light); color: var(--cartesia-accent); margin-bottom: 0.25rem; }
    .agent-name { font-size: 1rem; font-weight: 600; color: var(--text-dark); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .agent-description { font-size: 0.8125rem; color: var(--text-gray); margin-top: 0.25rem; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .agent-card-body { padding: 1rem 1.25rem; }
    .agent-meta { display: flex; gap: 1rem; flex-wrap: wrap; }
    .agent-meta-item { font-size: 0.75rem; color: var(--text-light); display: flex; align-items: center; gap: 0.25rem; }
    .agent-card-footer { padding: 0.75rem 1.25rem; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 0.5rem; }

    /* Edit Container */
    .edit-container { display: none; background: var(--white); border-radius: var(--radius-lg); border: 1px solid var(--border-color); box-shadow: var(--shadow-sm); }
    .edit-container.show { display: block; }
    .edit-header { padding: 1.25rem 1.5rem; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; }
    .edit-header h2 { font-size: 1.125rem; font-weight: 600; }

    /* Tabs */
    .tabs { display: flex; border-bottom: 1px solid var(--border-color); padding: 0 1.5rem; }
    .tab { padding: 0.75rem 1rem; font-size: 0.875rem; color: var(--text-gray); cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s; background: none; border-top: none; border-left: none; border-right: none; }
    .tab:hover { color: var(--text-dark); }
    .tab.active { color: var(--cartesia-accent); border-bottom-color: var(--cartesia-accent); font-weight: 600; }
    .tab-content { display: none; padding: 1.5rem; }
    .tab-content.active { display: block; }

    /* Form */
    .form-group { margin-bottom: 1.25rem; }
    .form-group label { display: block; font-size: 0.875rem; font-weight: 500; color: var(--text-dark); margin-bottom: 0.375rem; }
    .form-group .hint { font-size: 0.75rem; color: var(--text-light); margin-top: 0.25rem; }
    .form-control { width: 100%; padding: 0.625rem 0.75rem; border: 1px solid var(--border-color); border-radius: var(--radius-md); font-size: 0.875rem; color: var(--text-dark); transition: all 0.2s; }
    .form-control:focus { outline: none; border-color: var(--cartesia-accent); box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1); }
    textarea.form-control { min-height: 120px; resize: vertical; font-family: inherit; }

    /* Slider */
    .slider-container { display: flex; align-items: center; gap: 1rem; }
    .slider-container input[type="range"] { flex: 1; -webkit-appearance: none; height: 6px; border-radius: 3px; background: var(--border-color); outline: none; }
    .slider-container input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; border-radius: 50%; background: var(--cartesia-accent); cursor: pointer; }
    .slider-value { min-width: 40px; text-align: center; font-weight: 600; color: var(--cartesia-accent); }

    /* Functions */
    .functions-list { display: flex; flex-direction: column; gap: 0.75rem; }
    .function-item { display: flex; align-items: flex-start; gap: 0.75rem; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: var(--radius-md); }
    .function-item label { font-size: 0.875rem; font-weight: 500; cursor: pointer; }
    .function-item .function-desc { font-size: 0.75rem; color: var(--text-gray); margin-top: 0.25rem; }
    .function-info { display: none; margin-top: 0.5rem; padding: 0.5rem; background: var(--bg-light); border-radius: var(--radius-md); font-size: 0.75rem; }

    /* Form Actions */
    .form-actions { display: flex; justify-content: flex-end; gap: 0.75rem; padding-top: 1rem; border-top: 1px solid var(--border-color); margin-top: 1.5rem; }

    /* Empty State */
    .empty-state { text-align: center; padding: 3rem; color: var(--text-gray); }
    .empty-state i { font-size: 3rem; margin-bottom: 1rem; color: var(--text-light); }
    .empty-state h3 { font-size: 1.125rem; margin-bottom: 0.5rem; color: var(--text-dark); }

    /* Notifications */
    .notification { position: fixed; top: 1rem; right: 1rem; padding: 0.75rem 1.25rem; border-radius: var(--radius-md); font-size: 0.875rem; color: white; z-index: 1000; opacity: 0; transform: translateY(-10px); transition: all 0.3s; max-width: 400px; }
    .notification.show { opacity: 1; transform: translateY(0); }
    .notification.success { background-color: #10b981; }
    .notification.error { background-color: #ef4444; }
    .notification.info { background-color: var(--cartesia-accent); }

    /* Loading */
    .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 500; justify-content: center; align-items: center; }
    .loading-overlay.show { display: flex; }
    .spinner { width: 40px; height: 40px; border: 3px solid var(--border-color); border-top-color: var(--cartesia-accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Limits info */
    .limits-info { font-size: 0.8125rem; color: var(--text-gray); margin-top: 0.5rem; }

    /* Confirm Modal */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 600; justify-content: center; align-items: center; }
    .modal-overlay.show { display: flex; }
    .modal-box { background: var(--white); border-radius: var(--radius-lg); padding: 2rem; max-width: 400px; width: 90%; box-shadow: var(--shadow-lg); }
    .modal-box h3 { margin-bottom: 0.75rem; }
    .modal-box p { color: var(--text-gray); margin-bottom: 1.5rem; font-size: 0.875rem; }
    .modal-actions { display: flex; justify-content: flex-end; gap: 0.75rem; }

    /* Feature Lock */
    .feature-lock { opacity: 0.5; position: relative; }
    .feature-lock::after { content: ' \uD83D\uDD12'; }

    /* Responsive */
    @media (max-width: 768px) {
      .sidebar { transform: translateX(-100%); transition: transform 0.3s; }
      .sidebar.open { transform: translateX(0); }
      .main-content { margin-left: 0; }
      .mobile-menu-btn { display: block; }
      .top-nav { padding: 0.75rem 1rem; }
      .content-area { padding: 1rem; }
      .agents-grid { grid-template-columns: 1fr; }
      .api-key-row { flex-direction: column; align-items: flex-start; }
      .api-key-row label { min-width: auto; }
    }
  </style>
</head>
<body>

  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <a href="/" class="sidebar-logo">
        <div class="logo-icon">
          <img src="/static/images/IMG_2820.PNG" alt="Voicyfy Logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
          <div style="display:none; width: 30px; height: 30px; border-radius: 0.5rem; background: linear-gradient(135deg, #4a86e8, #2563eb); color: white; align-items: center; justify-content: center; font-size: 0.875rem;">
            <i class="fas fa-robot"></i>
          </div>
        </div>
        <span>Voicyfy</span>
      </a>
    </div>

    <nav class="sidebar-nav">
      <div class="sidebar-section">Основное</div>
      <a href="/static/dashboard.html" class="sidebar-nav-item"><i class="fas fa-home"></i> Дашборд</a>
      <a href="/static/agents.html" class="sidebar-nav-item"><i class="fas fa-robot"></i> OpenAI агенты</a>
      <a href="/static/gemini-agents.html" class="sidebar-nav-item"><i class="fas fa-gem"></i> Gemini агенты</a>
      <a href="/static/grok-agents.html" class="sidebar-nav-item"><i class="fas fa-bolt"></i> Grok агенты</a>
      <a href="/static/cartesia-agents.html" class="sidebar-nav-item active"><i class="fas fa-wave-square"></i> Cartesia агенты</a>
      <a href="/static/knowledge-base.html" class="sidebar-nav-item"><i class="fas fa-book"></i> База знаний</a>
      <a href="/static/telephony.html" class="sidebar-nav-item" data-feature="telephony"><i class="fas fa-phone"></i> Телефония</a>
      <a href="/static/conversations.html" class="sidebar-nav-item"><i class="fas fa-comments"></i> Диалоги</a>
      <a href="/static/crm.html" class="sidebar-nav-item" data-feature="crm"><i class="fas fa-address-book"></i> CRM</a>
      <div class="sidebar-section">ИИ Интерфейс</div>
      <a href="/static/voice_llm_interface.html" class="sidebar-nav-item"><i class="fas fa-microphone"></i> JARVIS AI</a>
      <div class="sidebar-section">Аккаунт</div>
      <a href="/static/settings.html" class="sidebar-nav-item"><i class="fas fa-gear"></i> Настройки</a>
    </nav>

    <div class="sidebar-footer">
      <a href="https://voicyfy.ru/static/index.html" class="btn btn-secondary" style="width: 100%; text-decoration: none; justify-content: center;" id="logout-button">
        <i class="fas fa-sign-out-alt"></i> Выйти
      </a>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Top Nav -->
    <div class="top-nav">
      <div class="top-nav-left">
        <button class="mobile-menu-btn" id="mobile-menu-btn"><i class="fas fa-bars"></i></button>
        <div class="top-nav-title">
          <i class="fas fa-wave-square" style="color: var(--cartesia-accent);"></i>
          Cartesia агенты
        </div>
      </div>
      <div class="top-nav-right">
        <button class="btn btn-primary" id="create-agent-btn"><i class="fas fa-plus"></i> Создать агента</button>
        <div class="user-dropdown">
          <div class="user-avatar" id="user-avatar">?</div>
          <div class="dropdown-menu" id="user-dropdown-menu">
            <div style="padding: 0.75rem 1rem; font-size: 0.8125rem; color: var(--text-light);" id="user-email">-</div>
            <div class="dropdown-divider"></div>
            <a href="/static/settings.html" class="dropdown-item"><i class="fas fa-gear"></i> Настройки</a>
            <a href="https://voicyfy.ru/static/index.html" class="dropdown-item" id="logout-dropdown"><i class="fas fa-sign-out-alt"></i> Выйти</a>
          </div>
        </div>
      </div>
    </div>

    <!-- Content Area -->
    <div class="content-area">

      <!-- API Keys Card -->
      <div class="api-keys-card" id="api-keys-card">
        <h3><i class="fas fa-key" style="color: var(--cartesia-accent);"></i> API ключи для Cartesia агентов</h3>

        <div class="api-key-row">
          <label>OpenAI API Key (LLM)</label>
          <input type="password" id="openai-key-input" placeholder="sk-..." autocomplete="off">
          <div class="api-key-actions">
            <button class="btn btn-sm btn-secondary" id="toggle-openai-key" title="Показать/скрыть"><i class="fas fa-eye"></i></button>
          </div>
        </div>

        <div class="api-key-row">
          <label>Cartesia API Key (TTS)</label>
          <input type="password" id="cartesia-key-input" placeholder="sk_car_..." autocomplete="off">
          <div class="api-key-actions">
            <button class="btn btn-sm btn-secondary" id="toggle-cartesia-key" title="Показать/скрыть"><i class="fas fa-eye"></i></button>
          </div>
        </div>

        <div style="display: flex; gap: 0.5rem; margin-top: 0.75rem;">
          <button class="btn btn-primary btn-sm" id="save-keys-btn"><i class="fas fa-save"></i> Сохранить ключи</button>
          <button class="btn btn-secondary btn-sm" id="clear-keys-btn"><i class="fas fa-trash"></i> Очистить</button>
        </div>

        <div class="api-key-warning" id="keys-warning" style="display: none;">
          <i class="fas fa-exclamation-triangle"></i>
          <span>Добавьте OpenAI и Cartesia API ключи для работы агентов</span>
        </div>
      </div>

      <!-- Setup Screen (no keys) -->
      <div class="setup-screen" id="setup-screen">
        <div class="setup-icon"><i class="fas fa-wave-square"></i></div>
        <h2>Настройте API ключи</h2>
        <p>Для работы Cartesia агентов необходимо добавить OpenAI API Key (для LLM обработки) и Cartesia API Key (для синтеза речи).</p>
        <div style="text-align: left; max-width: 500px; margin: 0 auto;">
          <p style="margin-bottom: 0.5rem;"><strong>Шаг 1:</strong> Получите OpenAI API Key на <a href="https://platform.openai.com/api-keys" target="_blank">platform.openai.com</a></p>
          <p style="margin-bottom: 0.5rem;"><strong>Шаг 2:</strong> Получите Cartesia API Key на <a href="https://play.cartesia.ai/" target="_blank">play.cartesia.ai</a></p>
          <p><strong>Шаг 3:</strong> Вставьте ключи в поля выше и нажмите "Сохранить ключи"</p>
        </div>
      </div>

      <!-- Agents Container -->
      <div class="agents-container" id="agents-container">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <h2 style="font-size: 1.125rem; font-weight: 600;">Мои агенты</h2>
            <div class="limits-info" id="limits-info"></div>
          </div>
        </div>
        <div class="agents-grid" id="agents-grid"></div>
        <div class="empty-state" id="empty-state" style="display: none;">
          <i class="fas fa-wave-square"></i>
          <h3>Нет агентов</h3>
          <p>Создайте первого Cartesia агента</p>
          <button class="btn btn-primary" onclick="navigateToCreateAgent()" style="margin-top: 1rem;"><i class="fas fa-plus"></i> Создать агента</button>
        </div>
      </div>

      <!-- Edit Container -->
      <div class="edit-container" id="edit-container">
        <div class="edit-header">
          <h2 id="edit-title">Новый агент</h2>
          <button class="btn btn-secondary btn-sm" onclick="switchToListMode()"><i class="fas fa-arrow-left"></i> Назад</button>
        </div>

        <div class="tabs">
          <button class="tab active" data-tab="settings">Настройки</button>
          <button class="tab" data-tab="functions">Функции</button>
        </div>

        <!-- Settings Tab -->
        <div class="tab-content active" id="tab-settings">
          <div class="form-group">
            <label>Название агента *</label>
            <input type="text" class="form-control" id="agent-name" placeholder="Мой Cartesia агент" required>
          </div>

          <div class="form-group">
            <label>Описание</label>
            <input type="text" class="form-control" id="agent-description" placeholder="Краткое описание агента">
          </div>

          <div class="form-group">
            <label>Системный промпт</label>
            <textarea class="form-control" id="agent-system-prompt" placeholder="Вы — голосовой ассистент. Отвечайте кратко и по существу." rows="5"></textarea>
          </div>

          <div class="form-group">
            <label>Cartesia Voice ID</label>
            <input type="text" class="form-control" id="agent-voice-id" placeholder="a0e99841-438c-4a64-b679-ae501e7d6091">
            <div class="hint">ID голоса из личного кабинета <a href="https://play.cartesia.ai/" target="_blank">play.cartesia.ai</a></div>
          </div>

          <div class="form-group">
            <label>Скорость голоса</label>
            <div class="slider-container">
              <span style="font-size: 0.75rem; color: var(--text-light);">0.5x</span>
              <input type="range" id="agent-voice-speed" min="0.5" max="1.5" step="0.1" value="1.0">
              <span style="font-size: 0.75rem; color: var(--text-light);">1.5x</span>
              <span class="slider-value" id="voice-speed-value">1.0</span>
            </div>
          </div>

          <div class="form-group">
            <label>Первая фраза (приветствие)</label>
            <input type="text" class="form-control" id="agent-greeting" placeholder="Здравствуйте! Чем я могу вам помочь?" value="Здравствуйте! Чем я могу вам помочь?">
          </div>

          <div class="form-actions">
            <button class="btn btn-secondary" onclick="switchToListMode()">Отмена</button>
            <button class="btn btn-danger" id="delete-agent-btn" style="display: none;" onclick="deleteAgent()"><i class="fas fa-trash"></i> Удалить</button>
            <button class="btn btn-primary" id="save-agent-btn" onclick="saveAgent()"><i class="fas fa-save"></i> Сохранить</button>
          </div>
        </div>

        <!-- Functions Tab -->
        <div class="tab-content" id="tab-functions">
          <div class="functions-list" id="functions-list">
            <p style="color: var(--text-gray); font-size: 0.875rem;">Загрузка функций...</p>
          </div>
        </div>
      </div>

    </div>
  </main>

  <!-- Notification -->
  <div class="notification" id="notification"></div>

  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loading-overlay"><div class="spinner"></div></div>

  <!-- Confirm Modal -->
  <div class="modal-overlay" id="confirm-modal">
    <div class="modal-box">
      <h3 id="confirm-title">Подтверждение</h3>
      <p id="confirm-message">Вы уверены?</p>
      <div class="modal-actions">
        <button class="btn btn-secondary" id="confirm-cancel">Отмена</button>
        <button class="btn btn-danger" id="confirm-ok">Удалить</button>
      </div>
    </div>
  </div>

  <script>
    // ============================================================================
    // CONSTANTS
    // ============================================================================
    const PRIVILEGED_USERS = ['well96well@gmail.com', 'stas@gmail.com'];
    const SPECIAL_ASSISTANT_LIMITS = { 'v83839370@gmail.com': 25 };
    const FEATURE_ACCESS = {
      crm: ['free', 'referral_trial', 'start', 'profi'],
      telephony: ['free', 'referral_trial', 'start', 'profi'],
      outbound_calls: ['free', 'referral_trial', 'start', 'profi']
    };
    const PLAN_NAMES = {
      'free': 'Пробный период',
      'referral_trial': 'Реферальный триал',
      'ai_voice': 'AI Voice',
      'start': 'Тариф Старт',
      'profi': 'Profi'
    };

    // ============================================================================
    // STATE
    // ============================================================================
    let currentUser = null;
    let currentAgentId = null;
    let agents = [];
    let availableFunctions = [];
    let totalAssistantsCount = 0;
    let maxAssistants = 3;

    // ============================================================================
    // AUTH
    // ============================================================================
    function getToken() {
      return localStorage.getItem('token') || localStorage.getItem('access_token');
    }

    function checkAuth() {
      if (!getToken()) {
        window.location.href = '/static/index.html';
      }
    }

    async function apiRequest(endpoint, options = {}) {
      const token = getToken();
      const headers = { 'Content-Type': 'application/json', ...(options.headers || {}) };
      if (token) headers['Authorization'] = `Bearer ${token}`;

      const response = await fetch(`/api${endpoint}`, { ...options, headers });

      if (response.status === 401) {
        localStorage.removeItem('token');
        localStorage.removeItem('access_token');
        window.location.href = '/static/index.html';
        return;
      }

      if (response.status === 204) return null;

      const data = await response.json();
      if (!response.ok) throw new Error(data.detail || 'Request failed');
      return data;
    }

    // ============================================================================
    // ASSISTANT LIMITS
    // ============================================================================
    function isPrivilegedUser() {
      if (!currentUser) return false;
      if (currentUser.is_admin) return true;
      return PRIVILEGED_USERS.includes(currentUser.email);
    }

    function getSpecialLimit() {
      if (!currentUser) return null;
      return SPECIAL_ASSISTANT_LIMITS[currentUser.email] || null;
    }

    async function loadAssistantsLimitInfo() {
      try {
        const [openai, gemini, grok, cartesia] = await Promise.all([
          apiRequest('/assistants').catch(() => []),
          apiRequest('/gemini-assistants').catch(() => []),
          apiRequest('/grok-assistants').catch(() => []),
          apiRequest('/cartesia-assistants').catch(() => ({ assistants: [] })),
        ]);

        const openaiCount = Array.isArray(openai) ? openai.length : 0;
        const geminiCount = Array.isArray(gemini) ? gemini.length : 0;
        const grokCount = Array.isArray(grok) ? grok.length : 0;
        const cartesiaCount = Array.isArray(cartesia) ? cartesia.length : (cartesia.assistants || []).length;

        totalAssistantsCount = openaiCount + geminiCount + grokCount + cartesiaCount;

        if (isPrivilegedUser()) {
          maxAssistants = 999;
        } else {
          const specialLimit = getSpecialLimit();
          if (specialLimit) {
            maxAssistants = specialLimit;
          } else {
            maxAssistants = 3;
          }
        }

        const limitsEl = document.getElementById('limits-info');
        if (limitsEl) {
          if (isPrivilegedUser()) {
            limitsEl.textContent = `Всего агентов: ${totalAssistantsCount} (без ограничений)`;
          } else {
            limitsEl.textContent = `Агентов: ${totalAssistantsCount} из ${maxAssistants}`;
          }
        }

        updateCreateButtonState();
      } catch (e) {
        console.error('Error loading limits:', e);
      }
    }

    function canCreateAssistant() {
      if (isPrivilegedUser()) return true;
      return totalAssistantsCount < maxAssistants;
    }

    function updateCreateButtonState() {
      const btn = document.getElementById('create-agent-btn');
      if (!btn) return;
      if (!canCreateAssistant()) {
        btn.disabled = true;
        btn.title = `Достигнут лимит (${maxAssistants}) агентов`;
        btn.style.opacity = '0.5';
      } else {
        btn.disabled = false;
        btn.title = '';
        btn.style.opacity = '1';
      }
    }

    // ============================================================================
    // FEATURE ACCESS
    // ============================================================================
    function canAccessFeature(feature) {
      if (!currentUser) return false;
      if (isPrivilegedUser()) return true;
      const plan = currentUser.subscription_plan || 'free';
      const allowedPlans = FEATURE_ACCESS[feature];
      if (!allowedPlans) return true;
      return allowedPlans.includes(plan);
    }

    function applyFeatureAccessToSidebar() {
      document.querySelectorAll('[data-feature]').forEach(item => {
        const feature = item.getAttribute('data-feature');
        if (!canAccessFeature(feature)) {
          item.classList.add('feature-lock');
          item.addEventListener('click', (e) => {
            e.preventDefault();
            showNotification('Эта функция доступна на платных тарифах', 'info');
          });
        }
      });
    }

    // ============================================================================
    // NOTIFICATIONS
    // ============================================================================
    function showNotification(message, type = 'info') {
      const el = document.getElementById('notification');
      el.textContent = message;
      el.className = `notification ${type} show`;
      setTimeout(() => el.classList.remove('show'), 3000);
    }

    function setLoading(loading) {
      const overlay = document.getElementById('loading-overlay');
      if (loading) overlay.classList.add('show');
      else overlay.classList.remove('show');
    }

    // ============================================================================
    // USER DATA
    // ============================================================================
    async function loadUserData() {
      try {
        currentUser = await apiRequest('/users/me');
        updateUserUI();
        return currentUser;
      } catch (e) {
        console.error('Error loading user:', e);
      }
    }

    function updateUserUI() {
      if (!currentUser) return;
      const avatar = document.getElementById('user-avatar');
      const emailEl = document.getElementById('user-email');

      if (avatar && currentUser.email) {
        avatar.textContent = currentUser.email.charAt(0).toUpperCase();
      }
      if (emailEl) {
        emailEl.textContent = currentUser.email;
      }
    }

    // ============================================================================
    // API KEYS
    // ============================================================================
    async function loadApiKeysStatus() {
      try {
        const status = await apiRequest('/cartesia-assistants/api-keys');
        const openaiInput = document.getElementById('openai-key-input');
        const cartesiaInput = document.getElementById('cartesia-key-input');
        const warning = document.getElementById('keys-warning');

        if (status.openai_key_preview) {
          openaiInput.placeholder = status.openai_key_preview;
        }
        if (status.cartesia_key_preview) {
          cartesiaInput.placeholder = status.cartesia_key_preview;
        }

        const hasKeys = status.has_openai_key && status.has_cartesia_key;
        warning.style.display = hasKeys ? 'none' : 'flex';

        return hasKeys;
      } catch (e) {
        console.error('Error loading API keys status:', e);
        return false;
      }
    }

    async function saveApiKeys() {
      const openaiKey = document.getElementById('openai-key-input').value.trim();
      const cartesiaKey = document.getElementById('cartesia-key-input').value.trim();

      if (!openaiKey && !cartesiaKey) {
        showNotification('Введите хотя бы один ключ', 'error');
        return;
      }

      setLoading(true);
      try {
        const body = {};
        if (openaiKey) body.openai_api_key = openaiKey;
        if (cartesiaKey) body.cartesia_api_key = cartesiaKey;

        await apiRequest('/cartesia-assistants/api-keys', {
          method: 'PUT',
          body: JSON.stringify(body),
        });

        document.getElementById('openai-key-input').value = '';
        document.getElementById('cartesia-key-input').value = '';

        showNotification('API ключи сохранены', 'success');
        const hasKeys = await loadApiKeysStatus();
        checkApiKeyAndShowContent(hasKeys);
      } catch (e) {
        showNotification('Ошибка сохранения: ' + e.message, 'error');
      } finally {
        setLoading(false);
      }
    }

    async function clearApiKeys() {
      setLoading(true);
      try {
        await apiRequest('/cartesia-assistants/api-keys', {
          method: 'PUT',
          body: JSON.stringify({ openai_api_key: '', cartesia_api_key: '' }),
        });

        document.getElementById('openai-key-input').value = '';
        document.getElementById('cartesia-key-input').value = '';

        showNotification('API ключи удалены', 'success');
        const hasKeys = await loadApiKeysStatus();
        checkApiKeyAndShowContent(hasKeys);
      } catch (e) {
        showNotification('Ошибка: ' + e.message, 'error');
      } finally {
        setLoading(false);
      }
    }

    function checkApiKeyAndShowContent(hasKeys) {
      const setupScreen = document.getElementById('setup-screen');
      const agentsContainer = document.getElementById('agents-container');

      if (hasKeys) {
        setupScreen.classList.remove('show');
        agentsContainer.classList.add('show');
        loadAgentsList();
      } else {
        setupScreen.classList.add('show');
        agentsContainer.classList.remove('show');
      }
    }

    // ============================================================================
    // AGENTS CRUD
    // ============================================================================
    async function loadAgentsList() {
      try {
        const data = await apiRequest('/cartesia-assistants');
        agents = data.assistants || [];
        renderAgentsList();
      } catch (e) {
        console.error('Error loading agents:', e);
        showNotification('Ошибка загрузки агентов', 'error');
      }
    }

    function renderAgentsList() {
      const grid = document.getElementById('agents-grid');
      const emptyState = document.getElementById('empty-state');

      if (agents.length === 0) {
        grid.innerHTML = '';
        emptyState.style.display = 'block';
        return;
      }

      emptyState.style.display = 'none';
      grid.innerHTML = agents.map(agent => `
        <div class="agent-card">
          <div class="agent-card-header">
            <div class="agent-icon"><i class="fas fa-wave-square"></i></div>
            <div class="agent-info">
              <div class="agent-badge">Cartesia</div>
              <div class="agent-name">${escapeHtml(agent.name)}</div>
              ${agent.description ? `<div class="agent-description">${escapeHtml(agent.description)}</div>` : ''}
            </div>
          </div>
          <div class="agent-card-body">
            <div class="agent-meta">
              ${agent.cartesia_voice_id ? `<div class="agent-meta-item"><i class="fas fa-microphone"></i> Voice: ${escapeHtml(agent.cartesia_voice_id.substring(0, 12))}...</div>` : ''}
              <div class="agent-meta-item"><i class="fas fa-tachometer-alt"></i> Скорость: ${agent.voice_speed || 1.0}x</div>
              <div class="agent-meta-item"><i class="fas fa-calendar"></i> ${new Date(agent.created_at).toLocaleDateString('ru-RU')}</div>
            </div>
          </div>
          <div class="agent-card-footer">
            <button class="btn btn-primary btn-sm" onclick="editAgent('${agent.id}')"><i class="fas fa-pen"></i> Редактировать</button>
          </div>
        </div>
      `).join('');
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    async function loadAgentData(id) {
      setLoading(true);
      try {
        const agent = await apiRequest(`/cartesia-assistants/${id}`);
        fillAgentForm(agent);
        currentAgentId = id;
        document.getElementById('edit-title').textContent = 'Редактирование: ' + agent.name;
        document.getElementById('delete-agent-btn').style.display = 'inline-flex';
      } catch (e) {
        showNotification('Ошибка загрузки агента: ' + e.message, 'error');
        switchToListMode();
      } finally {
        setLoading(false);
      }
    }

    function fillAgentForm(agent) {
      document.getElementById('agent-name').value = agent.name || '';
      document.getElementById('agent-description').value = agent.description || '';
      document.getElementById('agent-system-prompt').value = agent.system_prompt || '';
      document.getElementById('agent-voice-id').value = agent.cartesia_voice_id || '';
      document.getElementById('agent-greeting').value = agent.greeting_message || '';

      const speedSlider = document.getElementById('agent-voice-speed');
      speedSlider.value = agent.voice_speed || 1.0;
      document.getElementById('voice-speed-value').textContent = speedSlider.value;

      loadFunctions(agent.functions || []);
    }

    function getFormData() {
      const enabledFunctions = [];
      document.querySelectorAll('input[type="checkbox"][data-function-name]:checked').forEach(cb => {
        enabledFunctions.push({ name: cb.dataset.functionName });
      });

      return {
        name: document.getElementById('agent-name').value.trim(),
        description: document.getElementById('agent-description').value.trim() || null,
        system_prompt: document.getElementById('agent-system-prompt').value.trim() || null,
        cartesia_voice_id: document.getElementById('agent-voice-id').value.trim() || null,
        voice_speed: parseFloat(document.getElementById('agent-voice-speed').value),
        greeting_message: document.getElementById('agent-greeting').value.trim() || null,
        functions: enabledFunctions.length > 0 ? enabledFunctions : null,
      };
    }

    async function saveAgent() {
      const data = getFormData();
      if (!data.name) {
        showNotification('Введите название агента', 'error');
        return;
      }

      setLoading(true);
      try {
        if (currentAgentId) {
          await apiRequest(`/cartesia-assistants/${currentAgentId}`, {
            method: 'PUT',
            body: JSON.stringify(data),
          });
          showNotification('Агент обновлён', 'success');
        } else {
          if (!canCreateAssistant()) {
            showNotification(`Достигнут лимит (${maxAssistants}) агентов`, 'error');
            return;
          }
          const created = await apiRequest('/cartesia-assistants', {
            method: 'POST',
            body: JSON.stringify(data),
          });
          currentAgentId = created.id;
          showNotification('Агент создан', 'success');
        }
        await loadAgentsList();
        await loadAssistantsLimitInfo();
        switchToListMode();
      } catch (e) {
        showNotification('Ошибка: ' + e.message, 'error');
      } finally {
        setLoading(false);
      }
    }

    async function deleteAgent() {
      if (!currentAgentId) return;

      const modal = document.getElementById('confirm-modal');
      document.getElementById('confirm-title').textContent = 'Удалить агента?';
      document.getElementById('confirm-message').textContent = 'Это действие нельзя отменить. Агент будет удалён навсегда.';
      modal.classList.add('show');

      document.getElementById('confirm-ok').onclick = async () => {
        modal.classList.remove('show');
        setLoading(true);
        try {
          await apiRequest(`/cartesia-assistants/${currentAgentId}`, { method: 'DELETE' });
          showNotification('Агент удалён', 'success');
          currentAgentId = null;
          await loadAgentsList();
          await loadAssistantsLimitInfo();
          switchToListMode();
        } catch (e) {
          showNotification('Ошибка удаления: ' + e.message, 'error');
        } finally {
          setLoading(false);
        }
      };
    }

    // ============================================================================
    // FUNCTIONS
    // ============================================================================
    async function loadAvailableFunctions() {
      try {
        availableFunctions = await apiRequest('/functions/');
        renderFunctionsList();
      } catch (e) {
        console.error('Error loading functions:', e);
      }
    }

    function renderFunctionsList() {
      const container = document.getElementById('functions-list');
      if (!availableFunctions || availableFunctions.length === 0) {
        container.innerHTML = '<p style="color: var(--text-gray); font-size: 0.875rem;">Нет доступных функций</p>';
        return;
      }

      container.innerHTML = availableFunctions.map(fn => `
        <div class="function-item">
          <input type="checkbox" id="fn-${fn.name}" data-function-name="${fn.name}">
          <div>
            <label for="fn-${fn.name}">${fn.display_name || fn.name}</label>
            <div class="function-desc">${fn.description || ''}</div>
            <div class="function-info" id="${fn.name}-info">
              ${fn.schema ? `<pre style="white-space: pre-wrap; word-break: break-all;">${JSON.stringify(fn.schema, null, 2)}</pre>` : ''}
            </div>
          </div>
        </div>
      `).join('');

      // Toggle function info on checkbox
      container.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        cb.addEventListener('change', () => {
          const info = document.getElementById(`${cb.dataset.functionName}-info`);
          if (info) info.style.display = cb.checked ? 'block' : 'none';
        });
      });
    }

    function loadFunctions(agentFunctions) {
      document.querySelectorAll('input[type="checkbox"][data-function-name]').forEach(cb => {
        cb.checked = false;
        const info = document.getElementById(`${cb.dataset.functionName}-info`);
        if (info) info.style.display = 'none';
      });

      if (!agentFunctions) return;
      agentFunctions.forEach(fn => {
        const name = fn.name || fn;
        const cb = document.querySelector(`input[data-function-name="${name}"]`);
        if (cb) {
          cb.checked = true;
          const info = document.getElementById(`${name}-info`);
          if (info) info.style.display = 'block';
        }
      });
    }

    // ============================================================================
    // NAVIGATION
    // ============================================================================
    function navigateToCreateAgent() {
      if (!canCreateAssistant()) {
        showNotification(`Достигнут лимит (${maxAssistants}) агентов`, 'error');
        return;
      }
      currentAgentId = null;
      initCreateMode();
      switchToEditMode();
    }

    function editAgent(id) {
      currentAgentId = id;
      switchToEditMode();
      loadAgentData(id);
    }

    function switchToEditMode() {
      document.getElementById('agents-container').classList.remove('show');
      document.getElementById('setup-screen').classList.remove('show');
      document.getElementById('edit-container').classList.add('show');
      // Reset to first tab
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
      document.querySelector('.tab[data-tab="settings"]').classList.add('active');
      document.getElementById('tab-settings').classList.add('active');
    }

    function switchToListMode() {
      document.getElementById('edit-container').classList.remove('show');
      document.getElementById('agents-container').classList.add('show');
      currentAgentId = null;
    }

    function initCreateMode() {
      document.getElementById('edit-title').textContent = 'Новый агент';
      document.getElementById('delete-agent-btn').style.display = 'none';
      document.getElementById('agent-name').value = '';
      document.getElementById('agent-description').value = '';
      document.getElementById('agent-system-prompt').value = '';
      document.getElementById('agent-voice-id').value = '';
      document.getElementById('agent-greeting').value = 'Здравствуйте! Чем я могу вам помочь?';
      document.getElementById('agent-voice-speed').value = '1.0';
      document.getElementById('voice-speed-value').textContent = '1.0';
      loadFunctions([]);
    }

    // ============================================================================
    // INIT
    // ============================================================================
    async function initPage() {
      checkAuth();
      await loadUserData();
      applyFeatureAccessToSidebar();
      await loadAvailableFunctions();

      const hasKeys = await loadApiKeysStatus();
      checkApiKeyAndShowContent(hasKeys);
      await loadAssistantsLimitInfo();

      // Handle URL params
      const params = new URLSearchParams(window.location.search);
      const agentId = params.get('id');
      const mode = params.get('mode');

      if (mode === 'create') {
        navigateToCreateAgent();
      } else if (agentId) {
        editAgent(agentId);
      }
    }

    // ============================================================================
    // EVENT LISTENERS
    // ============================================================================
    document.addEventListener('DOMContentLoaded', initPage);

    // Mobile menu
    document.getElementById('mobile-menu-btn').addEventListener('click', () => {
      document.getElementById('sidebar').classList.toggle('open');
    });

    // User dropdown
    document.getElementById('user-avatar').addEventListener('click', () => {
      document.getElementById('user-dropdown-menu').classList.toggle('show');
    });
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.user-dropdown')) {
        document.getElementById('user-dropdown-menu').classList.remove('show');
      }
    });

    // Logout
    document.getElementById('logout-button').addEventListener('click', () => {
      localStorage.removeItem('token');
      localStorage.removeItem('access_token');
    });
    const logoutDropdown = document.getElementById('logout-dropdown');
    if (logoutDropdown) {
      logoutDropdown.addEventListener('click', () => {
        localStorage.removeItem('token');
        localStorage.removeItem('access_token');
      });
    }

    // Create agent button
    document.getElementById('create-agent-btn').addEventListener('click', navigateToCreateAgent);

    // API keys
    document.getElementById('save-keys-btn').addEventListener('click', saveApiKeys);
    document.getElementById('clear-keys-btn').addEventListener('click', clearApiKeys);

    // Toggle key visibility
    document.getElementById('toggle-openai-key').addEventListener('click', () => {
      const input = document.getElementById('openai-key-input');
      input.type = input.type === 'password' ? 'text' : 'password';
    });
    document.getElementById('toggle-cartesia-key').addEventListener('click', () => {
      const input = document.getElementById('cartesia-key-input');
      input.type = input.type === 'password' ? 'text' : 'password';
    });

    // Tabs
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const tabId = tab.dataset.tab;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(`tab-${tabId}`).classList.add('active');
      });
    });

    // Voice speed slider
    document.getElementById('agent-voice-speed').addEventListener('input', (e) => {
      document.getElementById('voice-speed-value').textContent = e.target.value;
    });

    // Confirm modal cancel
    document.getElementById('confirm-cancel').addEventListener('click', () => {
      document.getElementById('confirm-modal').classList.remove('show');
    });
  </script>
</body>
</html>
