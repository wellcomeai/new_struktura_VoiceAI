<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JARVIS AI - Голосовой ассистент + LLM</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Orbitron:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: url('https://i.ibb.co/N6BsLQr3/image.png') center/cover no-repeat fixed;
            min-height: 100vh;
            position: relative;
            overflow: hidden;
        }

        /* Blur overlay */
        .background-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            backdrop-filter: blur(12px);
            background: rgba(255, 255, 255, 0.15);
            z-index: 1;
        }

        /* Main layout */
        .main-container {
            position: relative;
            z-index: 2;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            padding: 20px 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.05);
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4);
        }

        .logo-text {
            font-family: 'Orbitron', monospace;
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.02em;
        }

        .header-subtitle {
            font-size: 14px;
            color: #5a5a5a;
            margin-left: 10px;
            font-weight: 500;
        }

        /* Content layout */
        .content-container {
            flex: 1;
            display: flex;
            gap: 20px;
            padding: 20px;
            min-height: 0;
        }

        /* Left panel - LLM Results */
        .llm-panel {
            flex: 1;
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 24px;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.08),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .llm-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.5), transparent);
        }

        .llm-header {
            background: rgba(255, 255, 255, 0.15);
            padding: 24px 32px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.06);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .llm-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .llm-title {
            font-size: 18px;
            font-weight: 600;
            color: #1a1a1a;
            flex: 1;
        }

        .llm-meta {
            font-size: 12px;
            color: #6a6a6a;
            background: rgba(102, 126, 234, 0.1);
            padding: 6px 12px;
            border-radius: 8px;
            font-weight: 500;
        }

        .llm-content {
            flex: 1;
            padding: 32px;
            overflow-y: auto;
            font-size: 15px;
            line-height: 1.7;
            color: #2a2a2a;
        }

        .llm-content::-webkit-scrollbar {
            width: 8px;
        }

        .llm-content::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.03);
            border-radius: 4px;
        }

        .llm-content::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.3);
            border-radius: 4px;
        }

        .llm-content::-webkit-scrollbar-thumb:hover {
            background: rgba(102, 126, 234, 0.5);
        }

        .llm-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            color: #6a6a6a;
        }

        .placeholder-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.6;
        }

        .placeholder-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #3a3a3a;
        }

        .placeholder-text {
            font-size: 16px;
            max-width: 500px;
            line-height: 1.6;
            color: #6a6a6a;
        }

        /* Right panel - Voice Assistant */
        .voice-panel {
            flex: 0 0 480px;
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 24px;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.08),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .voice-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.5), transparent);
        }

        .voice-header {
            background: rgba(255, 255, 255, 0.15);
            padding: 24px 32px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.06);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .voice-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .voice-title {
            font-size: 18px;
            font-weight: 600;
            color: #1a1a1a;
            flex: 1;
        }

        .voice-status {
            font-size: 12px;
            padding: 6px 12px;
            border-radius: 8px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .voice-status.connected {
            background: rgba(34, 197, 94, 0.15);
            color: #16a34a;
        }

        .voice-status.processing {
            background: rgba(168, 85, 247, 0.15);
            color: #9333ea;
        }

        .voice-status.speaking {
            background: rgba(59, 130, 246, 0.15);
            color: #2563eb;
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse-dot 2s ease-in-out infinite;
        }

        @keyframes pulse-dot {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.2); }
        }

        .voice-content {
            flex: 1;
            padding: 32px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        /* JARVIS Sphere */
        .jarvis-container {
            position: relative;
            width: 320px;
            height: 320px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .jarvis-sphere {
            width: 280px;
            height: 280px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, rgba(102, 126, 234, 0.15), transparent 70%),
                        radial-gradient(circle at 70% 70%, rgba(118, 75, 162, 0.1), transparent 60%);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(102, 126, 234, 0.3);
            box-shadow: 
                inset 0 0 40px rgba(102, 126, 234, 0.1),
                0 0 40px rgba(102, 126, 234, 0.2),
                0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: all 0.5s ease;
            cursor: pointer;
        }

        .jarvis-sphere.listening {
            background: radial-gradient(circle at 30% 30%, rgba(102, 126, 234, 0.25), transparent 70%);
            border-color: rgba(102, 126, 234, 0.6);
            box-shadow: 
                inset 0 0 40px rgba(102, 126, 234, 0.2),
                0 0 60px rgba(102, 126, 234, 0.4);
            animation: pulse-sphere 2s ease-in-out infinite;
        }

        .jarvis-sphere.speaking {
            background: radial-gradient(circle at 30% 30%, rgba(34, 197, 94, 0.25), transparent 70%);
            border-color: rgba(34, 197, 94, 0.6);
            box-shadow: 
                inset 0 0 40px rgba(34, 197, 94, 0.2),
                0 0 60px rgba(34, 197, 94, 0.4);
            animation: pulse-sphere-fast 1s ease-in-out infinite;
        }

        .jarvis-sphere.processing {
            background: radial-gradient(circle at 30% 30%, rgba(168, 85, 247, 0.25), transparent 70%);
            border-color: rgba(168, 85, 247, 0.6);
            box-shadow: 
                inset 0 0 40px rgba(168, 85, 247, 0.2),
                0 0 60px rgba(168, 85, 247, 0.4);
            animation: pulse-sphere-slow 1.5s ease-in-out infinite;
        }

        @keyframes pulse-sphere {
            0%, 100% {
                transform: scale(1);
                box-shadow: 
                    inset 0 0 40px rgba(102, 126, 234, 0.2),
                    0 0 60px rgba(102, 126, 234, 0.4);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 
                    inset 0 0 60px rgba(102, 126, 234, 0.3),
                    0 0 80px rgba(102, 126, 234, 0.6);
            }
        }

        @keyframes pulse-sphere-fast {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.08);
            }
        }

        @keyframes pulse-sphere-slow {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.03);
            }
        }

        .jarvis-icon {
            font-size: 64px;
            color: #667eea;
            filter: drop-shadow(0 0 20px rgba(102, 126, 234, 0.6));
            transition: all 0.3s ease;
        }

        .jarvis-sphere.listening .jarvis-icon {
            color: #667eea;
            animation: icon-pulse 2s ease-in-out infinite;
        }

        .jarvis-sphere.speaking .jarvis-icon {
            color: #22c55e;
        }

        .jarvis-sphere.processing .jarvis-icon {
            color: #a855f7;
            animation: icon-rotate 2s linear infinite;
        }

        @keyframes icon-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        @keyframes icon-rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Visualizer */
        .circular-visualizer {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .viz-bar {
            position: absolute;
            width: 3px;
            background: linear-gradient(to top, transparent, #667eea, transparent);
            border-radius: 2px;
            bottom: 50%;
            left: 50%;
            transform-origin: bottom center;
            transition: height 0.1s ease;
            box-shadow: 0 0 8px rgba(102, 126, 234, 0.6);
        }

        .jarvis-sphere.speaking .viz-bar {
            background: linear-gradient(to top, transparent, #22c55e, transparent);
            box-shadow: 0 0 8px rgba(34, 197, 94, 0.6);
        }

        .jarvis-sphere.processing .viz-bar {
            background: linear-gradient(to top, transparent, #a855f7, transparent);
            box-shadow: 0 0 8px rgba(168, 85, 247, 0.6);
        }

        /* Instructions */
        .instructions {
            margin-top: 32px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            max-width: 360px;
        }

        .instructions-title {
            font-size: 14px;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 8px;
        }

        .instructions-text {
            font-size: 13px;
            color: #5a5a5a;
            line-height: 1.5;
        }

        /* Content formatting */
        .llm-content h1, .llm-content h2, .llm-content h3 {
            margin: 24px 0 12px 0;
            color: #1a1a1a;
            font-weight: 600;
        }

        .llm-content h1 { font-size: 24px; }
        .llm-content h2 { font-size: 20px; }
        .llm-content h3 { font-size: 18px; }

        .llm-content p {
            margin: 16px 0;
        }

        .llm-content ul, .llm-content ol {
            margin: 16px 0;
            padding-left: 24px;
        }

        .llm-content li {
            margin: 8px 0;
        }

        .llm-content code {
            background: rgba(102, 126, 234, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
            color: #764ba2;
        }

        .llm-content pre {
            background: rgba(0, 0, 0, 0.05);
            padding: 16px;
            border-radius: 12px;
            overflow-x: auto;
            margin: 20px 0;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .llm-content pre code {
            background: none;
            padding: 0;
            color: #2a2a2a;
        }

        .llm-content blockquote {
            border-left: 3px solid #667eea;
            padding-left: 16px;
            margin: 20px 0;
            font-style: italic;
            color: #4a4a4a;
        }

        .llm-content strong {
            color: #667eea;
            font-weight: 600;
        }

        .llm-content a {
            color: #667eea;
            text-decoration: none;
            border-bottom: 1px solid rgba(102, 126, 234, 0.3);
            transition: all 0.2s ease;
        }

        .llm-content a:hover {
            border-bottom-color: #667eea;
        }

        /* Loading animation */
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
        }

        .loading {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 20px;
        }

        .loading-dot {
            width: 10px;
            height: 10px;
            background: #667eea;
            border-radius: 50%;
            animation: pulse-loading 1.4s infinite ease-in-out;
        }

        .loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes pulse-loading {
            0%, 80%, 100% {
                transform: scale(0);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .loading-text {
            color: #6a6a6a;
            font-size: 16px;
        }

        /* Animation classes */
        .fade-in {
            animation: fadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Responsive design */
        @media (max-width: 1200px) {
            .voice-panel {
                flex: 0 0 400px;
            }

            .jarvis-container {
                width: 260px;
                height: 260px;
            }

            .jarvis-sphere {
                width: 240px;
                height: 240px;
            }

            .jarvis-icon {
                font-size: 48px;
            }
        }

        @media (max-width: 1024px) {
            .content-container {
                flex-direction: column;
                gap: 16px;
            }

            .voice-panel {
                flex: 0 0 320px;
                order: -1;
            }

            .llm-panel {
                flex: 1;
            }

            .jarvis-container {
                width: 200px;
                height: 200px;
            }

            .jarvis-sphere {
                width: 180px;
                height: 180px;
            }
        }

        @media (max-width: 768px) {
            .header {
                padding: 16px 20px;
            }

            .content-container {
                padding: 16px;
            }

            .llm-content, .voice-content {
                padding: 24px;
            }

            .logo-text {
                font-size: 24px;
            }

            .header-subtitle {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="background-overlay"></div>
    
    <div class="main-container">
        <!-- Header -->
        <div class="header">
            <div class="logo-icon">🎤</div>
            <div class="logo-text">JARVIS AI</div>
            <div class="header-subtitle">Голосовой ассистент + LLM</div>
        </div>

        <!-- Content Container -->
        <div class="content-container">
            <!-- Left Panel - LLM Results -->
            <div class="llm-panel">
                <div class="llm-header">
                    <div class="llm-icon">🤖</div>
                    <div class="llm-title">Результаты ИИ</div>
                    <div class="llm-meta" id="llmMeta">Ожидание запроса</div>
                </div>
                <div class="llm-content" id="llmContent">
                    <div class="llm-placeholder">
                        <span class="placeholder-icon">✨</span>
                        <div class="placeholder-title">Задайте вопрос голосовому ассистенту</div>
                        <div class="placeholder-text">
                            Нажмите на сферу JARVIS справа и произнесите ваш вопрос. 
                            Для сложных задач ассистент автоматически получит развернутый ответ от языковой модели.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Panel - Voice Assistant -->
            <div class="voice-panel">
                <div class="voice-header">
                    <div class="voice-icon">🎤</div>
                    <div class="voice-title">JARVIS</div>
                    <div class="voice-status connected" id="voiceStatus">
                        <span class="status-dot"></span>
                        <span id="statusText">Готов</span>
                    </div>
                </div>
                <div class="voice-content">
                    <div class="jarvis-container">
                        <div class="jarvis-sphere" id="jarvisSphere">
                            <i class="fas fa-microphone jarvis-icon"></i>
                            <div class="circular-visualizer" id="circularViz"></div>
                        </div>
                    </div>
                    
                    <div class="instructions">
                        <div class="instructions-title">Как использовать</div>
                        <div class="instructions-text">
                            Нажмите на сферу и говорите естественно с ассистентом. 
                            Для анализа, кода и исследований он автоматически обратится к мощной LLM модели.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        (function() {
            'use strict';

            const DEBUG_MODE = true;
            const ASSISTANT_ID = "17c631ce-0db1-4171-a81d-22d91d4cccd7";
            const SERVER_URL = "https://voicyfy.ru";
            
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);

            const WS_URL = SERVER_URL.replace(/^http/, 'ws') + '/ws/' + ASSISTANT_ID;

            let websocket = null;
            let isConnected = false;
            let isListening = false;
            let audioProcessor = null;
            let isPlayingAudio = false;
            let audioChunksBuffer = [];
            let audioPlaybackQueue = [];
            let isProcessingLLM = false;
            let llmStartTime = 0;

            window.audioInitialized = false;
            window.globalAudioContext = null;
            window.globalMicStream = null;

            const interruptionState = {
                is_assistant_speaking: false,
                is_user_speaking: false,
                current_audio_elements: []
            };

            const AUDIO_CONFIG = {
                silenceThreshold: 0.01,
                silenceDuration: 300,
                soundDetectionThreshold: 0.02,
                amplificationFactor: isMobile ? 2.0 : 1.0
            };

            // DOM Elements
            const jarvisSphere = document.getElementById('jarvisSphere');
            const circularViz = document.getElementById('circularViz');
            const llmContent = document.getElementById('llmContent');
            const llmMeta = document.getElementById('llmMeta');
            const voiceStatus = document.getElementById('voiceStatus');
            const statusText = document.getElementById('statusText');

            function log(message, type = 'info') {
                if (DEBUG_MODE || type === 'error') {
                    const prefix = '[JARVIS]';
                    if (type === 'error') {
                        console.error(`${prefix} ERROR:`, message);
                    } else if (type === 'warn') {
                        console.warn(`${prefix} WARNING:`, message);
                    } else {
                        console.log(`${prefix}`, message);
                    }
                }
            }

            log('🚀 JARVIS AI Interface Starting...');

            // LLM Functions
            function showLLMLoading() {
                log('⏳ Showing LLM loading state');
                llmContent.innerHTML = `
                    <div class="loading-container">
                        <div class="loading">
                            <div class="loading-dot"></div>
                            <div class="loading-dot"></div>
                            <div class="loading-dot"></div>
                        </div>
                        <div class="loading-text">Обрабатываю запрос с помощью ИИ...</div>
                    </div>
                `;
            }

            function formatMarkdown(text) {
                if (!text) return '<p>Нет контента</p>';

                return text
                    .replace(/```(\w+)?\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>')
                    .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                    .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                    .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                    .replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>')
                    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.+?)\*/g, '<em>$1</em>')
                    .replace(/`([^`]+)`/g, '<code>$1</code>')
                    .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>')
                    .replace(/^\* (.+)$/gim, '<li>$1</li>')
                    .replace(/^- (.+)$/gim, '<li>$1</li>')
                    .replace(/^(\d+)\. (.+)$/gim, '<li>$2</li>')
                    .replace(/^> (.+)$/gim, '<blockquote>$1</blockquote>')
                    .replace(/\n\n/g, '</p><p>')
                    .replace(/\n/g, '<br>')
                    .split('</p><p>')
                    .map(para => para.match(/^<(h[1-6]|pre|ul|ol|blockquote)/) ? para : `<p>${para}</p>`)
                    .join('</p><p>')
                    .replace(/<p><\/p>/g, '')
                    .replace(/<\/ul><ul>/g, '');
            }

            function displayLLMContent(content, model = 'GPT-4') {
                log('✅ Displaying LLM content');
                const formattedContent = formatMarkdown(content);
                llmContent.innerHTML = `<div class="fade-in">${formattedContent}</div>`;
                llmMeta.textContent = model;
                llmContent.scrollTop = 0;
            }

            function updateStatus(status, text, className) {
                statusText.textContent = text;
                voiceStatus.className = `voice-status ${className}`;
            }

            // Event Handlers
            function handleFunctionExecuting(data) {
                log(`🔧 Function executing: ${data.function}`);
                
                if (data.function === 'query_llm') {
                    isProcessingLLM = true;
                    llmStartTime = Date.now();
                    
                    jarvisSphere.classList.add('processing');
                    jarvisSphere.classList.remove('listening', 'speaking');
                    
                    showLLMLoading();
                    updateStatus('processing', 'AI анализирует...', 'processing');
                }
            }

            function handleLLMResult(data) {
                log('✅ LLM Result received');
                
                const content = data.content 
                    || data.response 
                    || data.result?.response 
                    || data.result?.answer
                    || '';
                
                const model = data.model || data.result?.model || 'GPT-4';
                
                if (!content) {
                    log('⚠️ Empty LLM content', 'warn');
                    llmContent.innerHTML = '<p style="color: #ef4444;">Ошибка: контент не получен</p>';
                    return;
                }
                
                displayLLMContent(content, model);
                
                const processingTime = ((Date.now() - llmStartTime) / 1000).toFixed(1);
                log(`Processing time: ${processingTime}s`);
                
                updateStatus('connected', 'Готов к разговору', 'connected');
                
                setTimeout(() => {
                    isProcessingLLM = false;
                    jarvisSphere.classList.remove('processing');
                }, 2000);
            }

            function handleFunctionCompleted(data) {
                log(`✅ Function completed: ${data.function}`);
                
                if (data.function === 'query_llm' && isProcessingLLM && data.result) {
                    log('📦 Using fallback from function_call.completed');
                    
                    const content = data.result.response || data.result.answer || data.result || '';
                    const model = data.result.model || 'GPT-4';
                    
                    if (content && typeof content === 'string') {
                        displayLLMContent(content, model);
                        isProcessingLLM = false;
                        jarvisSphere.classList.remove('processing');
                    }
                }
            }

            // Visualizer
            function createCircularVisualizer() {
                const barCount = isMobile ? 40 : 60;
                const angleStep = 360 / barCount;
                
                for (let i = 0; i < barCount; i++) {
                    const bar = document.createElement('div');
                    bar.className = 'viz-bar';
                    bar.style.transform = `rotate(${i * angleStep}deg) translateY(-140px)`;
                    bar.style.height = '20px';
                    circularViz.appendChild(bar);
                }
            }

            function updateCircularVisualization(audioData) {
                const bars = circularViz.querySelectorAll('.viz-bar');
                const step = Math.floor(audioData.length / bars.length);
                
                for (let i = 0; i < bars.length; i++) {
                    let sum = 0;
                    for (let j = 0; j < step; j++) {
                        const index = i * step + j;
                        if (index < audioData.length) {
                            sum += Math.abs(audioData[index]);
                        }
                    }
                    const average = sum / step;
                    const multiplier = isMobile ? 300 : 200;
                    const height = 20 + Math.min(80, Math.floor(average * multiplier));
                    bars[i].style.height = `${height}px`;
                }
            }

            function resetCircularVisualization() {
                const bars = circularViz.querySelectorAll('.viz-bar');
                bars.forEach(bar => bar.style.height = '20px');
            }

            // Audio Functions
            function arrayBufferToBase64(buffer) {
                const bytes = new Uint8Array(buffer);
                let binary = '';
                for (let i = 0; i < bytes.byteLength; i++) {
                    binary += String.fromCharCode(bytes[i]);
                }
                return btoa(binary);
            }

            function base64ToArrayBuffer(base64) {
                try {
                    const binaryString = atob(base64);
                    const bytes = new Uint8Array(binaryString.length);
                    for (let i = 0; i < binaryString.length; i++) {
                        bytes[i] = binaryString.charCodeAt(i);
                    }
                    return bytes.buffer;
                } catch (e) {
                    log(`Ошибка декодирования base64: ${e.message}`, 'error');
                    return new ArrayBuffer(0);
                }
            }

            function createWavFromPcm(pcmBuffer, sampleRate = 24000) {
                const wavHeader = new ArrayBuffer(44);
                const view = new DataView(wavHeader);
                
                view.setUint8(0, 'R'.charCodeAt(0));
                view.setUint8(1, 'I'.charCodeAt(0));
                view.setUint8(2, 'F'.charCodeAt(0));
                view.setUint8(3, 'F'.charCodeAt(0));
                view.setUint32(4, 36 + pcmBuffer.byteLength, true);
                view.setUint8(8, 'W'.charCodeAt(0));
                view.setUint8(9, 'A'.charCodeAt(0));
                view.setUint8(10, 'V'.charCodeAt(0));
                view.setUint8(11, 'E'.charCodeAt(0));
                view.setUint8(12, 'f'.charCodeAt(0));
                view.setUint8(13, 'm'.charCodeAt(0));
                view.setUint8(14, 't'.charCodeAt(0));
                view.setUint8(15, ' '.charCodeAt(0));
                view.setUint32(16, 16, true);
                view.setUint16(20, 1, true);
                view.setUint16(22, 1, true);
                view.setUint32(24, sampleRate, true);
                view.setUint32(28, sampleRate * 2, true);
                view.setUint16(32, 2, true);
                view.setUint16(34, 16, true);
                view.setUint8(36, 'd'.charCodeAt(0));
                view.setUint8(37, 'a'.charCodeAt(0));
                view.setUint8(38, 't'.charCodeAt(0));
                view.setUint8(39, 'a'.charCodeAt(0));
                view.setUint32(40, pcmBuffer.byteLength, true);
                
                const wavBuffer = new ArrayBuffer(wavHeader.byteLength + pcmBuffer.byteLength);
                const wavBytes = new Uint8Array(wavBuffer);
                wavBytes.set(new Uint8Array(wavHeader), 0);
                wavBytes.set(new Uint8Array(pcmBuffer), wavHeader.byteLength);
                
                return wavBuffer;
            }

            async function initializeAudio() {
                log('Начало инициализации аудио');
                
                try {
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        throw new Error("Браузер не поддерживает доступ к микрофону");
                    }

                    if (!window.globalAudioContext) {
                        const AudioContextClass = window.AudioContext || window.webkitAudioContext;
                        window.globalAudioContext = new AudioContextClass({
                            sampleRate: 24000,
                            latencyHint: 'interactive'
                        });
                    }

                    if (window.globalAudioContext.state === 'suspended') {
                        await window.globalAudioContext.resume();
                    }

                    if (!window.globalMicStream) {
                        window.globalMicStream = await navigator.mediaDevices.getUserMedia({
                            audio: {
                                echoCancellation: true,
                                noiseSuppression: true,
                                autoGainControl: true,
                                sampleRate: 24000,
                                channelCount: 1
                            }
                        });
                    }

                    window.audioInitialized = true;
                    log('Инициализация аудио завершена');
                    return true;

                } catch (error) {
                    log(`Ошибка инициализации аудио: ${error.message}`, 'error');
                    return false;
                }
            }

            function playNextAudio() {
                if (audioPlaybackQueue.length === 0) {
                    isPlayingAudio = false;
                    interruptionState.is_assistant_speaking = false;
                    jarvisSphere.classList.remove('speaking');
                    resetCircularVisualization();
                    
                    if (!isProcessingLLM) {
                        setTimeout(() => startListening(), 400);
                    }
                    return;
                }
                
                isPlayingAudio = true;
                interruptionState.is_assistant_speaking = true;
                jarvisSphere.classList.add('speaking');
                jarvisSphere.classList.remove('listening', 'processing');
                updateStatus('speaking', 'Говорю...', 'speaking');
                
                const audioBase64 = audioPlaybackQueue.shift();
                
                try {
                    const audioData = base64ToArrayBuffer(audioBase64);
                    if (audioData.byteLength === 0) {
                        playNextAudio();
                        return;
                    }
                    
                    const wavBuffer = createWavFromPcm(audioData);
                    const blob = new Blob([wavBuffer], { type: 'audio/wav' });
                    const audioUrl = URL.createObjectURL(blob);
                    
                    const audio = new Audio();
                    audio.src = audioUrl;
                    audio.playsInline = true;
                    
                    interruptionState.current_audio_elements.push(audio);
                    
                    audio.onended = function() {
                        URL.revokeObjectURL(audioUrl);
                        playNextAudio();
                    };
                    
                    audio.onerror = function() {
                        URL.revokeObjectURL(audioUrl);
                        playNextAudio();
                    };
                    
                    audio.play();
                    
                } catch (error) {
                    log(`Ошибка воспроизведения: ${error.message}`, 'error');
                    playNextAudio();
                }
            }

            function addAudioToPlaybackQueue(audioBase64) {
                if (!audioBase64 || typeof audioBase64 !== 'string') return;
                audioPlaybackQueue.push(audioBase64);
                if (!isPlayingAudio) playNextAudio();
            }

            async function startListening() {
                if (!isConnected || isPlayingAudio || isListening || isProcessingLLM) return;
                
                if (!window.audioInitialized) {
                    const success = await initializeAudio();
                    if (!success) return;
                }
                
                isListening = true;
                log('Начинаем прослушивание');
                
                jarvisSphere.classList.add('listening');
                jarvisSphere.classList.remove('speaking', 'processing');
                updateStatus('connected', 'Слушаю...', 'connected');
                
                if (!audioProcessor && window.globalAudioContext && window.globalMicStream) {
                    const bufferSize = 2048;
                    audioProcessor = window.globalAudioContext.createScriptProcessor(bufferSize, 1, 1);
                    
                    audioProcessor.onaudioprocess = function(e) {
                        if (isListening && websocket && websocket.readyState === WebSocket.OPEN) {
                            const inputBuffer = e.inputBuffer;
                            let inputData = inputBuffer.getChannelData(0);
                            
                            updateCircularVisualization(inputData);
                            
                            const pcm16Data = new Int16Array(inputData.length);
                            for (let i = 0; i < inputData.length; i++) {
                                pcm16Data[i] = Math.max(-32768, Math.min(32767, Math.floor(inputData[i] * 32767)));
                            }
                            
                            try {
                                websocket.send(JSON.stringify({
                                    type: "input_audio_buffer.append",
                                    event_id: `audio_${Date.now()}`,
                                    audio: arrayBufferToBase64(pcm16Data.buffer)
                                }));
                            } catch (error) {
                                log(`Ошибка отправки аудио: ${error.message}`, "error");
                            }
                        }
                    };
                    
                    const streamSource = window.globalAudioContext.createMediaStreamSource(window.globalMicStream);
                    streamSource.connect(audioProcessor);
                    
                    const gainNode = window.globalAudioContext.createGain();
                    gainNode.gain.value = 0;
                    audioProcessor.connect(gainNode);
                    gainNode.connect(window.globalAudioContext.destination);
                }
            }

            async function connectWebSocket() {
                try {
                    log('Подключение к WebSocket...');
                    updateStatus('connecting', 'Подключение...', 'processing');
                    
                    websocket = new WebSocket(WS_URL);
                    websocket.binaryType = 'arraybuffer';
                    
                    websocket.onopen = function() {
                        log('WebSocket подключен');
                        isConnected = true;
                        updateStatus('connected', 'Готов', 'connected');
                        
                        setTimeout(() => startListening(), 500);
                    };
                    
                    websocket.onmessage = function(event) {
                        try {
                            if (event.data instanceof Blob || !event.data) return;

                            const data = JSON.parse(event.data);
                            
                            if (data.type === 'function_call.executing') {
                                handleFunctionExecuting(data);
                                return;
                            }
                            
                            if (data.type === 'llm_result') {
                                handleLLMResult(data);
                                return;
                            }
                            
                            if (data.type === 'function_call.completed') {
                                handleFunctionCompleted(data);
                                return;
                            }
                            
                            if (data.type === 'response.audio.delta') {
                                if (data.delta) audioChunksBuffer.push(data.delta);
                                return;
                            }
                            
                            if (data.type === 'response.audio.done') {
                                if (audioChunksBuffer.length > 0) {
                                    const fullAudio = audioChunksBuffer.join('');
                                    addAudioToPlaybackQueue(fullAudio);
                                    audioChunksBuffer = [];
                                }
                                return;
                            }
                            
                            if (data.type === 'response.done') {
                                if (!isPlayingAudio && !isProcessingLLM) {
                                    setTimeout(() => startListening(), 400);
                                }
                                return;
                            }
                            
                        } catch (parseError) {
                            // Ignore
                        }
                    };
                    
                    websocket.onerror = function(error) {
                        log(`WebSocket ошибка: ${error}`, 'error');
                        updateStatus('disconnected', 'Ошибка', 'connected');
                    };
                    
                    websocket.onclose = function() {
                        log('WebSocket закрыт');
                        isConnected = false;
                        isListening = false;
                        updateStatus('disconnected', 'Отключено', 'connected');
                    };
                    
                } catch (error) {
                    log(`Ошибка подключения: ${error}`, 'error');
                }
            }

            // Click handler
            jarvisSphere.addEventListener('click', async function() {
                if (!window.audioInitialized) {
                    const success = await initializeAudio();
                    if (!success) return;
                }
                
                if (!isConnected) {
                    connectWebSocket();
                } else if (!isListening && !isPlayingAudio && !isProcessingLLM) {
                    startListening();
                }
            });

            // Initialize
            window.addEventListener('load', function() {
                log('✅ JARVIS AI Interface loaded');
                createCircularVisualizer();
                connectWebSocket();
            });

        })();
    </script>
</body>
</html>
