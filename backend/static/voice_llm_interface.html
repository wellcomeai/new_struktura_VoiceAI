<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JARVIS AI | Voicyfy</title>

    <!-- Favicon –∏ PWA -->
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png">
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#667eea">
    <meta name="description" content="JARVIS AI - –ì–æ–ª–æ—Å–æ–≤–æ–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π LLM">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Orbitron:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --background: rgba(255, 255, 255, 0.95);
            --text-color: #1a1a1a;
            --border-color: rgba(255, 255, 255, 0.3);
            --primary-blue: #2563eb;
            --primary-blue-light: #3b82f6;
            --text-dark: #0f172a;
            --text-gray: #64748b;
            --text-light: #94a3b8;
            --bg-light: #f8fafc;
            --bg-blue-light: #eff6ff;
            --white: #ffffff;
            --radius-md: 0.5rem;
            --sidebar-width: 260px;
            --gemini-color: #8b5cf6;
            --gemini-gradient: linear-gradient(135deg, #8b5cf6, #6366f1);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: url('https://i.ibb.co/N6BsLQr3/image.png') center/cover no-repeat fixed;
            min-height: 100vh;
            position: relative;
            overflow: hidden;
            display: flex;
        }

        /* –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--white);
            border-right: 1px solid var(--border-color);
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            z-index: 100;
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-dark);
            text-decoration: none;
        }

        .logo-icon {
            width: 30px;
            height: 30px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: var(--radius-md);
        }

        .sidebar-nav {
            padding: 1.5rem 0;
            flex-grow: 1;
        }

        .sidebar-section {
            padding: 0 1.5rem;
            margin-bottom: 0.75rem;
            color: var(--text-light);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 600;
        }

        .sidebar-nav-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1.5rem;
            color: var(--text-gray);
            text-decoration: none;
            transition: background-color 0.2s, color 0.2s;
            border-left: 3px solid transparent;
            font-size: 0.9rem;
        }

        .sidebar-nav-item.active {
            background-color: var(--bg-blue-light);
            color: var(--primary-blue);
            border-left-color: var(--primary-blue);
        }

        .sidebar-nav-item:hover {
            background-color: var(--bg-blue-light);
            color: var(--primary-blue);
        }

        .sidebar-nav-item i {
            margin-right: 0.75rem;
            width: 20px;
            text-align: center;
        }

        .sidebar-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border-color);
        }

        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 99;
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.mobile-open {
                transform: translateX(0);
            }

            .sidebar-overlay.show {
                display: block;
            }
        }

        /* –°–∫—Ä—ã–≤–∞–µ–º config panel –≤ embed —Ä–µ–∂–∏–º–µ */
        body.embed-mode .config-panel {
            display: none;
        }

        body.embed-mode .main-container {
            padding-top: 0;
        }

        /* –°–∫—Ä—ã–≤–∞–µ–º sidebar –≤ embed —Ä–µ–∂–∏–º–µ */
        body.embed-mode .sidebar {
            display: none;
        }

        body.embed-mode .main-container {
            margin-left: 0;
            width: 100%;
        }

        /* –ö–Ω–æ–ø–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –≤ LLM –ø–∞–Ω–µ–ª–∏ */
        .copy-button {
            background: none;
            border: none;
            color: var(--text-gray);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .copy-button:hover {
            background-color: var(--bg-light);
            color: var(--primary-blue);
        }

        .copy-button:active {
            transform: scale(0.95);
        }

        .copy-button.copied {
            color: #22c55e;
        }

        /* Config Panel Styles - —Ç–µ–ø–µ—Ä—å –≤—Å–µ–≥–¥–∞ –≤–∏–¥–∏–º */
        .config-panel {
            position: fixed;
            top: 0;
            left: var(--sidebar-width);
            right: 0;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border-bottom: 2px solid var(--gemini-color);
            padding: 15px 25px;
            z-index: 90;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        @media (max-width: 768px) {
            .config-panel {
                left: 0;
                padding: 12px 20px;
            }
        }

        .config-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .config-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .mobile-menu-toggle {
            display: none;
            background: none;
            border: none;
            font-size: 1.25rem;
            color: var(--text-gray);
            cursor: pointer;
            padding: 0.5rem;
            margin-right: 0.5rem;
        }

        @media (max-width: 768px) {
            .mobile-menu-toggle {
                display: block;
            }
        }

        .config-icon {
            width: 36px;
            height: 36px;
            background: var(--gemini-gradient);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: white;
            box-shadow: 0 4px 16px rgba(139, 92, 246, 0.4);
        }

        .config-title {
            font-family: 'Orbitron', monospace;
            font-size: 18px;
            font-weight: 700;
            background: var(--gemini-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .config-subtitle {
            color: #6a6a6a;
            font-size: 12px;
        }

        .config-form {
            display: flex;
            align-items: end;
            gap: 15px;
            flex-wrap: wrap;
        }

        .form-group {
            flex: 1;
            min-width: 250px;
        }

        .form-label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 6px;
        }

        .form-select {
            width: 100%;
            padding: 10px 14px;
            font-size: 13px;
            border: 2px solid rgba(139, 92, 246, 0.2);
            border-radius: 10px;
            background: white;
            color: var(--text-color);
            font-family: 'Inter', sans-serif;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .form-select:focus {
            outline: none;
            border-color: var(--gemini-color);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }

        .btn {
            padding: 10px 20px;
            font-size: 13px;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-family: 'Inter', sans-serif;
        }

        .btn-secondary {
            background-color: var(--bg-light);
            color: var(--text-gray);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background-color: var(--border-color);
        }

        .btn-primary {
            background: var(--gemini-gradient);
            color: white;
            box-shadow: 0 4px 16px rgba(139, 92, 246, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            box-shadow: 0 4px 16px rgba(34, 197, 94, 0.3);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(34, 197, 94, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .config-actions {
            display: flex;
            gap: 10px;
        }

        .success-message {
            position: fixed;
            top: 120px;
            right: 30px;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(34, 197, 94, 0.3);
            font-weight: 600;
            display: none;
            align-items: center;
            gap: 12px;
            z-index: 1001;
            animation: slideIn 0.3s ease;
        }

        .success-message.show {
            display: flex;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Adjust main container - –≤—Å–µ–≥–¥–∞ —É—á–∏—Ç—ã–≤–∞–µ–º config panel */
        .main-container {
            margin-left: var(--sidebar-width);
            width: calc(100% - var(--sidebar-width));
            padding-top: 140px;
        }

        @media (max-width: 768px) {
            .main-container {
                margin-left: 0;
                width: 100%;
                padding-top: 160px;
            }
        }

        /* Blur overlay */
        .background-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            backdrop-filter: blur(12px);
            background: rgba(255, 255, 255, 0.15);
            z-index: 1;
        }

        /* Three.js Canvas */
        #jarvis-three-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            opacity: 0.3;
        }

        /* Main layout */
        .main-container {
            position: relative;
            z-index: 2;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-color);
            padding: 20px 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.05);
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: var(--gemini-gradient);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
            box-shadow: 0 4px 16px rgba(139, 92, 246, 0.4);
        }

        .logo-text {
            font-family: 'Orbitron', monospace;
            font-size: 28px;
            font-weight: 700;
            background: var(--gemini-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.02em;
        }

        .header-subtitle {
            font-size: 14px;
            color: #5a5a5a;
            margin-left: 10px;
            font-weight: 500;
        }

        /* HUD Frames */
        .hud-frame {
            position: fixed;
            pointer-events: none;
            z-index: 50;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .hud-frame.active {
            opacity: 1;
        }

        .hud-frame::before,
        .hud-frame::after {
            content: '';
            position: absolute;
            background: var(--gemini-color);
            box-shadow: 0 0 8px rgba(139, 92, 246, 0.4);
            animation: line-glow 3s ease-in-out infinite;
        }

        @keyframes line-glow {
            0%, 100% {
                box-shadow: 0 0 8px rgba(139, 92, 246, 0.4);
                opacity: 0.6;
            }
            50% {
                box-shadow: 0 0 15px rgba(139, 92, 246, 0.7);
                opacity: 1;
            }
        }

        .hud-tl { top: 20px; left: 20px; }
        .hud-tl::before { width: 60px; height: 2px; top: 0; left: 0; }
        .hud-tl::after { width: 2px; height: 60px; top: 0; left: 0; }

        .hud-tr { top: 20px; right: 20px; }
        .hud-tr::before { width: 60px; height: 2px; top: 0; right: 0; }
        .hud-tr::after { width: 2px; height: 60px; top: 0; right: 0; }

        .hud-bl { bottom: 20px; left: 20px; }
        .hud-bl::before { width: 60px; height: 2px; bottom: 0; left: 0; }
        .hud-bl::after { width: 2px; height: 60px; bottom: 0; left: 0; }

        .hud-br { bottom: 20px; right: 20px; }
        .hud-br::before { width: 60px; height: 2px; bottom: 0; right: 0; }
        .hud-br::after { width: 2px; height: 60px; bottom: 0; right: 0; }

        /* Content layout */
        .content-container {
            flex: 1;
            display: flex;
            gap: 20px;
            padding: 20px;
            min-height: 0;
        }

        /* Left panel - LLM Results */
        .llm-panel {
            flex: 1;
            background: var(--background);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            border-radius: 24px;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.08),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .llm-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.5), transparent);
        }

        .llm-header {
            background: rgba(255, 255, 255, 0.15);
            padding: 24px 32px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.06);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .llm-icon {
            width: 32px;
            height: 32px;
            background: var(--gemini-gradient);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
            box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);
        }

        .llm-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-color);
            flex: 1;
        }

        .llm-meta {
            font-size: 12px;
            color: #6a6a6a;
            background: rgba(139, 92, 246, 0.1);
            padding: 6px 12px;
            border-radius: 8px;
            font-weight: 500;
        }

        .llm-content {
            flex: 1;
            padding: 32px;
            overflow-y: auto;
            font-size: 15px;
            line-height: 1.7;
            color: var(--text-color);
        }

        .llm-content::-webkit-scrollbar {
            width: 8px;
        }

        .llm-content::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.03);
            border-radius: 4px;
        }

        .llm-content::-webkit-scrollbar-thumb {
            background: rgba(139, 92, 246, 0.3);
            border-radius: 4px;
        }

        .llm-content::-webkit-scrollbar-thumb:hover {
            background: rgba(139, 92, 246, 0.5);
        }

        .llm-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            color: #6a6a6a;
        }

        .placeholder-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.6;
        }

        .placeholder-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #3a3a3a;
        }

        .placeholder-text {
            font-size: 16px;
            max-width: 500px;
            line-height: 1.6;
            color: #6a6a6a;
        }

        /* Streaming cursor */
        .streaming-cursor {
            display: inline-block;
            width: 2px;
            height: 1.2em;
            background: var(--gemini-color);
            margin-left: 2px;
            animation: blink 0.8s infinite;
            vertical-align: text-bottom;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        /* Streaming indicator */
        .streaming-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(139, 92, 246, 0.1);
            border-radius: 20px;
            font-size: 13px;
            color: var(--gemini-color);
            margin-bottom: 16px;
        }

        .streaming-indicator .dot {
            width: 6px;
            height: 6px;
            background: var(--gemini-color);
            border-radius: 50%;
            animation: pulse-dot 1s infinite;
        }

        /* Error message in LLM panel */
        .llm-error {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            text-align: center;
        }

        .llm-error-icon {
            font-size: 48px;
            color: #ef4444;
            margin-bottom: 16px;
        }

        .llm-error-title {
            font-size: 18px;
            font-weight: 600;
            color: #ef4444;
            margin-bottom: 8px;
        }

        .llm-error-text {
            font-size: 14px;
            color: #6a6a6a;
        }

        /* Right panel - Voice Assistant */
        .voice-panel {
            flex: 0 0 480px;
            background: var(--background);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            border-radius: 24px;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.08),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .voice-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.5), transparent);
        }

        .voice-header {
            background: rgba(255, 255, 255, 0.15);
            padding: 24px 32px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.06);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .voice-icon {
            width: 32px;
            height: 32px;
            background: var(--gemini-gradient);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
            box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);
        }

        .voice-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-color);
            flex: 1;
        }

        .voice-status {
            font-size: 12px;
            padding: 6px 12px;
            border-radius: 8px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .voice-status.connected {
            background: rgba(34, 197, 94, 0.15);
            color: #16a34a;
        }

        .voice-status.processing {
            background: rgba(139, 92, 246, 0.15);
            color: #8b5cf6;
        }

        .voice-status.speaking {
            background: rgba(59, 130, 246, 0.15);
            color: #2563eb;
        }

        .voice-status.interrupted {
            background: rgba(249, 115, 22, 0.15);
            color: #ea580c;
        }

        .voice-status.connecting {
            background: rgba(234, 179, 8, 0.15);
            color: #ca8a04;
        }

        .voice-status.error {
            background: rgba(239, 68, 68, 0.15);
            color: #dc2626;
        }

        .voice-status.streaming {
            background: rgba(139, 92, 246, 0.15);
            color: #8b5cf6;
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse-dot 2s ease-in-out infinite;
        }

        @keyframes pulse-dot {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.2); }
        }

        .voice-content {
            flex: 1;
            padding: 32px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        /* JARVIS Sphere */
        .jarvis-container {
            position: relative;
            width: 320px;
            height: 320px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .jarvis-sphere {
            width: 280px;
            height: 280px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, rgba(139, 92, 246, 0.15), transparent 70%),
                        radial-gradient(circle at 70% 70%, rgba(99, 102, 241, 0.1), transparent 60%);
            backdrop-filter: blur(10px);
            border: 2px solid var(--gemini-color);
            box-shadow: 
                inset 0 0 40px rgba(139, 92, 246, 0.1),
                0 0 40px rgba(139, 92, 246, 0.2),
                0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: all 0.5s ease;
            cursor: pointer;
        }

        .jarvis-sphere.listening {
            background: radial-gradient(circle at 30% 30%, rgba(139, 92, 246, 0.25), transparent 70%);
            border-color: rgba(139, 92, 246, 0.6);
            box-shadow: 
                inset 0 0 40px rgba(139, 92, 246, 0.2),
                0 0 60px rgba(139, 92, 246, 0.4);
            animation: pulse-sphere 2s ease-in-out infinite;
        }

        .jarvis-sphere.speaking {
            background: radial-gradient(circle at 30% 30%, rgba(34, 197, 94, 0.25), transparent 70%);
            border-color: rgba(34, 197, 94, 0.6);
            box-shadow: 
                inset 0 0 40px rgba(34, 197, 94, 0.2),
                0 0 60px rgba(34, 197, 94, 0.4);
            animation: pulse-sphere-fast 1s ease-in-out infinite;
        }

        .jarvis-sphere.processing {
            background: radial-gradient(circle at 30% 30%, rgba(139, 92, 246, 0.25), transparent 70%);
            border-color: rgba(139, 92, 246, 0.6);
            box-shadow: 
                inset 0 0 40px rgba(139, 92, 246, 0.2),
                0 0 60px rgba(139, 92, 246, 0.4);
            animation: pulse-sphere-slow 1.5s ease-in-out infinite;
        }

        .jarvis-sphere.streaming {
            background: radial-gradient(circle at 30% 30%, rgba(139, 92, 246, 0.3), transparent 70%);
            border-color: rgba(139, 92, 246, 0.8);
            box-shadow: 
                inset 0 0 50px rgba(139, 92, 246, 0.3),
                0 0 80px rgba(139, 92, 246, 0.5);
            animation: pulse-streaming 1s ease-in-out infinite;
        }

        .jarvis-sphere.interrupted {
            background: radial-gradient(circle at 30% 30%, rgba(249, 115, 22, 0.25), transparent 70%);
            border-color: rgba(249, 115, 22, 0.6);
            box-shadow: 
                inset 0 0 40px rgba(249, 115, 22, 0.2),
                0 0 60px rgba(249, 115, 22, 0.4);
            animation: pulse-interrupted 0.5s ease-in-out 3;
        }

        @keyframes pulse-sphere {
            0%, 100% {
                transform: scale(1);
                box-shadow: 
                    inset 0 0 40px rgba(139, 92, 246, 0.2),
                    0 0 60px rgba(139, 92, 246, 0.4);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 
                    inset 0 0 60px rgba(139, 92, 246, 0.3),
                    0 0 80px rgba(139, 92, 246, 0.6);
            }
        }

        @keyframes pulse-sphere-fast {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.08); }
        }

        @keyframes pulse-sphere-slow {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.03); }
        }

        @keyframes pulse-streaming {
            0%, 100% { 
                transform: scale(1);
                border-color: rgba(139, 92, 246, 0.6);
            }
            50% { 
                transform: scale(1.02);
                border-color: rgba(139, 92, 246, 1);
            }
        }

        @keyframes pulse-interrupted {
            0%, 100% {
                box-shadow: 
                    inset 0 0 40px rgba(249, 115, 22, 0.2),
                    0 0 60px rgba(249, 115, 22, 0.4);
            }
            50% {
                box-shadow: 
                    inset 0 0 60px rgba(249, 115, 22, 0.4),
                    0 0 100px rgba(249, 115, 22, 0.8);
            }
        }

        .jarvis-icon {
            font-size: 64px;
            color: var(--gemini-color);
            filter: drop-shadow(0 0 20px rgba(139, 92, 246, 0.6));
            transition: all 0.3s ease;
            z-index: 10;
        }

        .jarvis-sphere.listening .jarvis-icon {
            animation: icon-pulse 2s ease-in-out infinite;
        }

        .jarvis-sphere.speaking .jarvis-icon {
            color: #22c55e;
        }

        .jarvis-sphere.processing .jarvis-icon,
        .jarvis-sphere.streaming .jarvis-icon {
            color: #8b5cf6;
            animation: icon-rotate 2s linear infinite;
        }

        .jarvis-sphere.interrupted .jarvis-icon {
            color: #f97316;
        }

        @keyframes icon-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        @keyframes icon-rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Visualizer */
        .circular-visualizer {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
        }

        .viz-bar {
            position: absolute;
            width: 3px;
            background: linear-gradient(to top, transparent, var(--gemini-color), transparent);
            border-radius: 2px;
            bottom: 50%;
            left: 50%;
            transform-origin: bottom center;
            transition: height 0.1s ease;
            box-shadow: 0 0 8px rgba(139, 92, 246, 0.6);
        }

        .jarvis-sphere.speaking .viz-bar {
            background: linear-gradient(to top, transparent, #22c55e, transparent);
            box-shadow: 0 0 8px rgba(34, 197, 94, 0.6);
        }

        .jarvis-sphere.processing .viz-bar,
        .jarvis-sphere.streaming .viz-bar {
            background: linear-gradient(to top, transparent, #8b5cf6, transparent);
            box-shadow: 0 0 8px rgba(139, 92, 246, 0.6);
        }

        /* Instructions */
        .instructions {
            margin-top: 32px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            max-width: 360px;
        }

        .instructions-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 8px;
        }

        .instructions-text {
            font-size: 13px;
            color: #5a5a5a;
            line-height: 1.5;
        }

        /* Error message */
        .error-container {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            text-align: center;
            max-width: 400px;
            z-index: 1000;
        }

        .error-container.active {
            display: block;
        }

        .error-icon {
            font-size: 64px;
            color: #ef4444;
            margin-bottom: 20px;
        }

        .error-title {
            font-size: 24px;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 12px;
        }

        .error-text {
            font-size: 16px;
            color: #6a6a6a;
            line-height: 1.6;
        }

        /* Loading animation */
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
        }

        .loading {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 20px;
        }

        .loading-dot {
            width: 10px;
            height: 10px;
            background: var(--gemini-color);
            border-radius: 50%;
            animation: pulse-loading 1.4s infinite ease-in-out;
        }

        .loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes pulse-loading {
            0%, 80%, 100% {
                transform: scale(0);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .loading-text {
            color: #6a6a6a;
            font-size: 16px;
        }

        /* Content formatting */
        .llm-content h1, .llm-content h2, .llm-content h3 {
            margin: 24px 0 12px 0;
            color: var(--text-color);
            font-weight: 600;
        }

        .llm-content h1 { font-size: 24px; }
        .llm-content h2 { font-size: 20px; }
        .llm-content h3 { font-size: 18px; }

        .llm-content p {
            margin: 16px 0;
        }

        .llm-content ul, .llm-content ol {
            margin: 16px 0;
            padding-left: 24px;
        }

        .llm-content li {
            margin: 8px 0;
        }

        .llm-content code {
            background: rgba(139, 92, 246, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
            color: var(--gemini-color);
        }

        .llm-content pre {
            background: rgba(0, 0, 0, 0.05);
            padding: 16px;
            border-radius: 12px;
            overflow-x: auto;
            margin: 20px 0;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .llm-content pre code {
            background: none;
            padding: 0;
            color: var(--text-color);
        }

        .llm-content strong {
            color: var(--gemini-color);
            font-weight: 600;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .voice-panel {
                flex: 0 0 400px;
            }
        }

        @media (max-width: 1024px) {
            .content-container {
                flex-direction: column;
            }

            .voice-panel {
                flex: 0 0 320px;
                order: -1;
            }
        }

        @media (max-width: 768px) {
            .header {
                padding: 16px 20px;
            }

            .content-container {
                padding: 16px;
            }

            .logo-text {
                font-size: 24px;
            }

            .header-subtitle {
                display: none;
            }

            .config-panel {
                padding: 15px 20px;
            }

            .config-form {
                flex-direction: column;
            }

            .config-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Overlay –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ –º–µ–Ω—é -->
    <div class="sidebar-overlay" id="sidebar-overlay"></div>

    <!-- ============================================================ -->
    <!-- SIDEBAR NAVIGATION -->
    <!-- ============================================================ -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <a href="/" class="sidebar-logo">
                <div class="logo-icon">
                    <img src="/static/images/IMG_2820.PNG" alt="Voicyfy Logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div style="display:none; width: 30px; height: 30px; border-radius: 0.5rem; background: linear-gradient(135deg, #8b5cf6, #6366f1); color: white; align-items: center; justify-content: center; font-size: 0.875rem;">
                        <i class="fas fa-robot"></i>
                    </div>
                </div>
                <span>Voicyfy</span>
            </a>
        </div>

        <nav class="sidebar-nav">
            <div class="sidebar-section">–û—Å–Ω–æ–≤–Ω–æ–µ</div>
            <a href="/static/dashboard.html" class="sidebar-nav-item">
                <i class="fas fa-home"></i> –î–∞—à–±–æ—Ä–¥
            </a>
            <a href="/static/agents.html" class="sidebar-nav-item">
                <i class="fas fa-robot"></i> OpenAI –∞–≥–µ–Ω—Ç—ã
            </a>
            <a href="/static/gemini-agents.html" class="sidebar-nav-item">
                <i class="fas fa-gem"></i> Gemini –∞–≥–µ–Ω—Ç—ã
            </a>
            <a href="/static/knowledge-base.html" class="sidebar-nav-item">
                <i class="fas fa-book"></i> –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π
            </a>
            <a href="/static/outbound-calls.html" class="sidebar-nav-item">
                <i class="fas fa-phone-alt"></i> –ò—Å—Ö–æ–¥—è—â–∏–µ –∑–≤–æ–Ω–∫–∏
            </a>
            <a href="/static/conversations.html" class="sidebar-nav-item">
                <i class="fas fa-comments"></i> –î–∏–∞–ª–æ–≥–∏
            </a>

            <div class="sidebar-section">–ò–ò –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å</div>
            <a href="/static/voice_llm_interface.html" class="sidebar-nav-item active">
                <i class="fas fa-gem"></i> JARVIS AI (Gemini)
            </a>

            <div class="sidebar-section">–ê–∫–∫–∞—É–Ω—Ç</div>
            <a href="/static/settings.html" class="sidebar-nav-item">
                <i class="fas fa-gear"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏
            </a>
        </nav>

        <div class="sidebar-footer">
            <a href="https://voicyfy.ru/static/index.html" class="btn btn-secondary" style="width: 100%; text-decoration: none; justify-content: center;">
                <i class="fas fa-sign-out-alt"></i> –í—ã–π—Ç–∏
            </a>
        </div>
    </aside>

    <!-- ============================================================ -->
    <!-- CONFIG PANEL -->
    <!-- ============================================================ -->
    <div class="config-panel" id="configPanel">
        <div class="config-container">
            <div class="config-header">
                <button class="mobile-menu-toggle" id="mobile-menu-toggle">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="config-icon">üíé</div>
                <div>
                    <div class="config-title">JARVIS AI + Gemini</div>
                    <div class="config-subtitle">–ì–æ–ª–æ—Å–æ–≤–æ–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –Ω–∞ –±–∞–∑–µ Google Gemini —Å LLM —Å—Ç—Ä–∏–º–∏–Ω–≥–æ–º</div>
                </div>
            </div>
            
            <div class="config-form">
                <div class="form-group">
                    <label class="form-label">üíé Gemini –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç:</label>
                    <select class="form-select" id="assistantSelect">
                        <option value="">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞...</option>
                    </select>
                </div>
                
                <div class="config-actions">
                    <button class="btn btn-primary" id="saveBtn" onclick="saveConfig()">
                        <i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                    </button>
                    <button class="btn btn-success" id="testBtn" onclick="testAgent()" disabled>
                        <i class="fas fa-play"></i> –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å
                    </button>
                    <button class="btn btn-success" id="copyBtn" onclick="copyHTMLCode()" disabled>
                        <i class="fas fa-code"></i> –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Message -->
    <div class="success-message" id="successMessage">
        <i class="fas fa-check-circle" style="font-size: 20px;"></i>
        <span id="successText">–£—Å–ø–µ—à–Ω–æ!</span>
    </div>

    <!-- ============================================================ -->
    <!-- MAIN INTERFACE -->
    <!-- ============================================================ -->
    <canvas id="jarvis-three-canvas"></canvas>
    <div class="background-overlay"></div>
    
    <div class="main-container">
        <!-- HUD Frames -->
        <div class="hud-frame hud-tl" id="hudTL"></div>
        <div class="hud-frame hud-tr" id="hudTR"></div>
        <div class="hud-frame hud-bl" id="hudBL"></div>
        <div class="hud-frame hud-br" id="hudBR"></div>

        <!-- Header -->
        <div class="header">
            <div class="logo-icon">üíé</div>
            <div class="logo-text" id="headerTitle">JARVIS AI</div>
            <div class="header-subtitle" id="headerSubtitle">Gemini Voice + LLM Streaming</div>
        </div>

        <!-- Error Container -->
        <div class="error-container" id="errorContainer">
            <div class="error-icon">‚ö†Ô∏è</div>
            <div class="error-title" id="errorTitle">–û—à–∏–±–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏</div>
            <div class="error-text" id="errorText">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞</div>
        </div>

        <!-- Content Container -->
        <div class="content-container">
            <!-- Left Panel - LLM Results -->
            <div class="llm-panel">
                <div class="llm-header">
                    <div class="llm-icon">ü§ñ</div>
                    <div class="llm-title">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ò–ò</div>
                    <div class="llm-meta" id="llmMeta">–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞</div>
                    <button class="copy-button" id="copyLlmButton" onclick="copyLLMResponse()" style="display: none;">
                        <i class="fas fa-copy"></i>
                        <span id="copyButtonText">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</span>
                    </button>
                </div>
                <div class="llm-content" id="llmContent">
                    <div class="llm-placeholder">
                        <span class="placeholder-icon">‚ú®</span>
                        <div class="placeholder-title">–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –≥–æ–ª–æ—Å–æ–≤–æ–º—É –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç—É</div>
                        <div class="placeholder-text">
                            –ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Å—Ñ–µ—Ä—É JARVIS —Å–ø—Ä–∞–≤–∞ –∏ –ø—Ä–æ–∏–∑–Ω–µ—Å–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å. 
                            –î–ª—è —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–¥–∞—á –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∏—Ç —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç—ã–π –æ—Ç–≤–µ—Ç –æ—Ç LLM –∏ –ø–æ–∫–∞–∂–µ—Ç –µ–≥–æ –Ω–∞ —ç–∫—Ä–∞–Ω–µ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Panel - Voice Assistant -->
            <div class="voice-panel">
                <div class="voice-header">
                    <div class="voice-icon">üíé</div>
                    <div class="voice-title">Gemini Voice</div>
                    <div class="voice-status connecting" id="voiceStatus">
                        <span class="status-dot"></span>
                        <span id="statusText">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</span>
                    </div>
                </div>
                <div class="voice-content">
                    <div class="jarvis-container">
                        <div class="jarvis-sphere" id="jarvisSphere">
                            <i class="fas fa-gem jarvis-icon"></i>
                            <div class="circular-visualizer" id="circularViz"></div>
                        </div>
                    </div>
                    
                    <div class="instructions">
                        <div class="instructions-title">–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å</div>
                        <div class="instructions-text">
                            –ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Å—Ñ–µ—Ä—É –∏ –≥–æ–≤–æ—Ä–∏—Ç–µ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ —Å Gemini. 
                            –î–ª—è —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ —Ç–µ–∫—Å—Ç –±—É–¥–µ—Ç –ø–æ—è–≤–ª—è—Ç—å—Å—è –Ω–∞ —ç–∫—Ä–∞–Ω–µ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // ============================================================================
        // WAIT FOR DOM TO BE READY
        // ============================================================================
        document.addEventListener('DOMContentLoaded', function() {
            'use strict';

            // ============================================================================
            // CONFIGURATION
            // ============================================================================
            
            const DEBUG_MODE = true;
            const MAX_RECONNECT_ATTEMPTS = 5;
            const MOBILE_MAX_RECONNECT_ATTEMPTS = 10;
            const PING_INTERVAL = 15000;
            const MOBILE_PING_INTERVAL = 10000;
            
            // ‚úÖ v2.0: localStorage key for saving assistant
            const STORAGE_KEY_ASSISTANT = 'lastGeminiAssistantId';

            // ‚úÖ –û–ø—Ä–µ–¥–µ–ª—è–µ–º SERVER_URL –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ location
            const SERVER_URL = `${window.location.protocol}//${window.location.host}`;
            
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
            const isAndroid = /Android/i.test(navigator.userAgent);

            // ============================================================================
            // ASSISTANT CONFIGURATION
            // ============================================================================

            const urlParams = new URLSearchParams(window.location.search);

            // ‚úÖ ASSISTANT_ID - —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (Gemini –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç—ã)
            let ASSISTANT_ID = urlParams.get('assistant') || null;

            console.log('[JARVIS] JARVIS AI Interface v4.1 (Gemini + Dual WebSocket LLM + User API Keys)');
            console.log('[JARVIS] Assistant ID from URL:', ASSISTANT_ID);

            // ============================================================================
            // UI ELEMENTS
            // ============================================================================

            const configPanel = document.getElementById('configPanel');
            const assistantSelect = document.getElementById('assistantSelect');
            const saveBtn = document.getElementById('saveBtn');
            const testBtn = document.getElementById('testBtn');
            const copyBtn = document.getElementById('copyBtn');
            const successMessage = document.getElementById('successMessage');
            const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebar-overlay');

            // –í—Å–µ–≥–¥–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ Gemini –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–≤
            loadGeminiAssistantsList();

            // ============================================================================
            // üÜï LOAD GEMINI ASSISTANTS (with localStorage restore)
            // ============================================================================
            
            async function loadGeminiAssistantsList() {
                try {
                    console.log('[CONFIG] Loading Gemini assistants...');
                    
                    // ‚úÖ /api/gemini-assistants
                    const response = await fetch(`${SERVER_URL}/api/gemini-assistants`, {
                        headers: {
                            'Authorization': `Bearer ${getAuthToken()}`
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to load Gemini assistants');
                    }
                    
                    const assistants = await response.json();
                    
                    console.log('[CONFIG] Loaded Gemini assistants:', assistants.length);
                    
                    assistantSelect.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ Gemini –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ --</option>';
                    
                    assistants.forEach(assistant => {
                        const option = document.createElement('option');
                        option.value = assistant.id;
                        option.textContent = `üíé ${assistant.name || assistant.id}`;
                        assistantSelect.appendChild(option);
                    });
                    
                    // ‚úÖ v2.0: –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –≤—ã–±–æ—Ä–∞ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞:
                    // 1. URL –ø–∞—Ä–∞–º–µ—Ç—Ä (–¥–ª—è embed —Ä–µ–∂–∏–º–∞)
                    // 2. localStorage (–¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞)
                    if (ASSISTANT_ID && assistantSelect.querySelector(`option[value="${ASSISTANT_ID}"]`)) {
                        // URL –ø–∞—Ä–∞–º–µ—Ç—Ä –∏–º–µ–µ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
                        assistantSelect.value = ASSISTANT_ID;
                        testBtn.disabled = false;
                        copyBtn.disabled = false;
                        console.log('[CONFIG] Using assistant from URL:', ASSISTANT_ID);
                    } else {
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º localStorage
                        const savedAssistantId = localStorage.getItem(STORAGE_KEY_ASSISTANT);
                        if (savedAssistantId && assistantSelect.querySelector(`option[value="${savedAssistantId}"]`)) {
                            assistantSelect.value = savedAssistantId;
                            ASSISTANT_ID = savedAssistantId;
                            testBtn.disabled = false;
                            copyBtn.disabled = false;
                            console.log('[CONFIG] ‚úÖ Restored assistant from localStorage:', savedAssistantId);
                        } else {
                            console.log('[CONFIG] No saved assistant found');
                        }
                    }
                    
                } catch (error) {
                    console.error('[CONFIG] Error loading Gemini assistants:', error);
                    assistantSelect.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ Gemini –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–≤</option>';
                }
            }
            
            function getAuthToken() {
                return localStorage.getItem('auth_token') ||
                       document.cookie.split('; ').find(row => row.startsWith('auth_token='))?.split('=')[1] ||
                       '';
            }

            function setLoading(isLoading) {
                if (isLoading) {
                    saveBtn.disabled = true;
                    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
                    testBtn.disabled = true;
                    copyBtn.disabled = true;
                } else {
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = '<i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
                }
            }

            // ============================================================================
            // ‚úÖ v2.0: SAVE CONFIG WITH LOCALSTORAGE
            // ============================================================================
            
            window.saveConfig = async function() {
                const selectedAssistantId = assistantSelect.value;

                if (!selectedAssistantId) {
                    alert('‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ Gemini –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞!');
                    return;
                }

                try {
                    setLoading(true);

                    // –ü—Ä–∏–º–µ–Ω—è–µ–º assistant_id
                    ASSISTANT_ID = selectedAssistantId;
                    
                    // ‚úÖ v2.0: –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
                    localStorage.setItem(STORAGE_KEY_ASSISTANT, selectedAssistantId);
                    console.log('[CONFIG] ‚úÖ Assistant saved to localStorage:', selectedAssistantId);

                    // –í–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫–∏
                    testBtn.disabled = false;
                    copyBtn.disabled = false;

                    showSuccess(`‚úÖ Gemini –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω!`);

                    // –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ–º WebSocket
                    if (websocket) {
                        websocket.close();
                    }
                    
                    // –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ–º LLM WebSocket —Å –Ω–æ–≤—ã–º assistant_id
                    if (llmWebSocket) {
                        llmWebSocket.close();
                        llmWebSocket = null;
                        isLLMConnected = false;
                    }
                    
                    connectWebSocket();

                } catch (error) {
                    console.error('[CONFIG] Save error:', error);
                    alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
                } finally {
                    setLoading(false);
                }
            };

            window.testAgent = function() {
                if (!ASSISTANT_ID) {
                    alert('‚ùå –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞!');
                    return;
                }

                if (!isConnected) {
                    showSuccess('üîÑ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Gemini...');
                    connectWebSocket();
                } else {
                    showSuccess('‚úÖ –ì–æ—Ç–æ–≤ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é! –ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Å—Ñ–µ—Ä—É –∏ –≥–æ–≤–æ—Ä–∏—Ç–µ');
                }
            };
            
            window.copyHTMLCode = function() {
                if (!ASSISTANT_ID) {
                    alert('‚ùå –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞!');
                    return;
                }

                try {
                    const embedUrl = `${SERVER_URL}/static/voice_llm_interface.html?assistant=${ASSISTANT_ID}`;
                    
                    const embedCode = `<!-- Voicyfy JARVIS AI (Gemini) Widget -->
<iframe
    src="${embedUrl}"
    width="100%"
    height="800px"
    frameborder="0"
    allow="microphone"
    style="border-radius: 16px; box-shadow: 0 4px 16px rgba(0,0,0,0.1);">
</iframe>`;

                    navigator.clipboard.writeText(embedCode).then(() => {
                        showSuccess('‚úÖ –ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
                    }).catch(err => {
                        const textarea = document.createElement('textarea');
                        textarea.value = embedCode;
                        textarea.style.position = 'fixed';
                        textarea.style.opacity = '0';
                        document.body.appendChild(textarea);
                        textarea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textarea);
                        showSuccess('‚úÖ –ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!');
                    });

                } catch (error) {
                    console.error('[CONFIG] Copy error:', error);
                    alert('‚ùå –û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è: ' + error.message);
                }
            };
            
            function showSuccess(message) {
                const successText = document.getElementById('successText');
                successText.textContent = message;
                successMessage.classList.add('show');
                
                setTimeout(() => {
                    successMessage.classList.remove('show');
                }, 3000);
            }

            // ============================================================================
            // GLOBALS
            // ============================================================================

            window.audioInitialized = false;
            window.globalAudioContext = null;
            window.globalMicStream = null;
            window.silentAudioBuffer = null;

            let websocket = null;
            let llmWebSocket = null;  // üÜï v3.2: –û—Ç–¥–µ–ª—å–Ω—ã–π WebSocket –¥–ª—è LLM —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å—Ç—Ä–∏–º–∏–Ω–≥–∞
            let isConnected = false;
            let isLLMConnected = false;  // üÜï –°–æ—Å—Ç–æ—è–Ω–∏–µ LLM WebSocket
            let isListening = false;
            let audioProcessor = null;
            let isPlayingAudio = false;
            let reconnectAttempts = 0;
            let pingInterval = null;
            let lastPingTime = Date.now();
            let lastPongTime = Date.now();
            let isReconnecting = false;

            let hasAudioData = false;
            let audioDataStartTime = 0;
            const minimumAudioLength = 300;

            // üÜï LLM Streaming state
            let isStreamingLLM = false;
            let streamingContent = "";
            let currentRequestId = null;

            // ============================================================================
            // üîß SMOOTH AUDIO PLAYBACK SYSTEM v4.0 - NO CLICKS/POPS
            // Uses larger buffers + proper scheduling + crossfade
            // ============================================================================
            
            const AUDIO_PLAYBACK_SAMPLE_RATE = 24000;
            let playbackAudioContext = null;
            let audioBufferQueue = [];        // –ù–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–µ Int16 —Å—ç–º–ø–ª—ã
            let isSchedulingAudio = false;
            let nextPlayTime = 0;
            let scheduledSources = [];        // –ê–∫—Ç–∏–≤–Ω—ã–µ AudioBufferSourceNode
            let schedulerInterval = null;     // üÜï v4.0: Stable interval instead of rAF
            
            // üîß v4.0: –£–≤–µ–ª–∏—á–µ–Ω–Ω–∞—è –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è –¥–ª—è —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è —Ç—Ä–µ—Å–∫–∞
            const MIN_BUFFER_SAMPLES = 12000;  // 500ms –ø—Ä–∏ 24kHz (–±—ã–ª–æ 200ms)
            const CHUNK_SIZE = 4800;           // 200ms chunks (–±—ã–ª–æ 50ms)
            const SCHEDULE_AHEAD_TIME = 0.3;   // 300ms ahead (–±—ã–ª–æ 100ms)
            const SCHEDULER_INTERVAL_MS = 50;  // Check every 50ms
            
            // üÜï v4.0: Crossfade –¥–ª—è —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è —â–µ–ª—á–∫–æ–≤
            const CROSSFADE_SAMPLES = 64;      // ~2.7ms fade
            
            function initPlaybackAudioContext() {
                if (!playbackAudioContext) {
                    const AudioContextClass = window.AudioContext || window.webkitAudioContext;
                    playbackAudioContext = new AudioContextClass({
                        sampleRate: AUDIO_PLAYBACK_SAMPLE_RATE,
                        latencyHint: 'playback'  // üÜï v4.0: Optimize for smooth playback
                    });
                    log('üîä Playback AudioContext created (v4.0 anti-click)');
                }
                return playbackAudioContext;
            }
            
            function base64ToInt16Array(base64) {
                try {
                    const binaryString = atob(base64);
                    const bytes = new Uint8Array(binaryString.length);
                    for (let i = 0; i < binaryString.length; i++) {
                        bytes[i] = binaryString.charCodeAt(i);
                    }
                    return new Int16Array(bytes.buffer);
                } catch (e) {
                    log(`–û—à–∏–±–∫–∞ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è base64: ${e.message}`, 'error');
                    return new Int16Array(0);
                }
            }
            
            function addAudioChunkToBuffer(base64Data) {
                if (!base64Data || typeof base64Data !== 'string') return;
                
                const int16Samples = base64ToInt16Array(base64Data);
                if (int16Samples.length === 0) return;
                
                // üÜï v4.0: –î–æ–±–∞–≤–ª—è–µ–º —Å—ç–º–ø–ª—ã –≤ –±—É—Ñ–µ—Ä (–±–æ–ª–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ)
                for (let i = 0; i < int16Samples.length; i++) {
                    audioBufferQueue.push(int16Samples[i]);
                }
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –µ—Å–ª–∏ –µ—â—ë –Ω–µ –∑–∞–ø—É—â–µ–Ω –∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö
                if (!isSchedulingAudio && audioBufferQueue.length >= MIN_BUFFER_SAMPLES) {
                    startAudioScheduler();
                }
            }
            
            function startAudioScheduler() {
                if (isSchedulingAudio) return;
                
                isSchedulingAudio = true;
                isPlayingAudio = true;
                
                const ctx = initPlaybackAudioContext();
                
                // –í–æ–∑–æ–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –µ—Å–ª–∏ suspended
                if (ctx.state === 'suspended') {
                    ctx.resume();
                }
                
                // üÜï v4.0: –ù–∞—á–∏–Ω–∞–µ–º —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π –¥–ª—è –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏–∏
                nextPlayTime = ctx.currentTime + 0.15;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º UI
                jarvisSphere.classList.add('speaking');
                jarvisSphere.classList.remove('listening', 'processing', 'streaming');
                updateStatus('speaking', '–ì–æ–≤–æ—Ä–∏—Ç...', 'speaking');
                
                interruptionState.is_assistant_speaking = true;
                
                // üÜï v4.0: –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–±–∏–ª—å–Ω—ã–π setInterval –≤–º–µ—Å—Ç–æ requestAnimationFrame
                schedulerInterval = setInterval(scheduleNextChunk, SCHEDULER_INTERVAL_MS);
                scheduleNextChunk(); // –°—Ä–∞–∑—É –ø–µ—Ä–≤—ã–π –≤—ã–∑–æ–≤
            }
            
            function scheduleNextChunk() {
                if (!isSchedulingAudio) {
                    if (schedulerInterval) {
                        clearInterval(schedulerInterval);
                        schedulerInterval = null;
                    }
                    return;
                }
                
                const ctx = playbackAudioContext;
                if (!ctx) return;
                
                // üÜï v4.0: –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º nextPlayTime –µ—Å–ª–∏ –æ—Ç—Å—Ç–∞–ª–∏
                if (nextPlayTime < ctx.currentTime) {
                    log('‚ö†Ô∏è Audio scheduler caught up, adjusting timing');
                    nextPlayTime = ctx.currentTime + 0.05;
                }
                
                // –ü–ª–∞–Ω–∏—Ä—É–µ–º —á–∞–Ω–∫–∏ –ø–æ–∫–∞ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –∏ –≤—Ä–µ–º—è –≤–ø–µ—Ä–µ–¥–∏
                while (audioBufferQueue.length >= CHUNK_SIZE && nextPlayTime < ctx.currentTime + SCHEDULE_AHEAD_TIME) {
                    // üÜï v4.0: –ë–µ—Ä—ë–º –±–æ–ª—å—à–∏–µ —á–∞–Ω–∫–∏ (200ms –≤–º–µ—Å—Ç–æ 50ms)
                    const chunkSize = Math.min(CHUNK_SIZE, audioBufferQueue.length);
                    const chunk = audioBufferQueue.splice(0, chunkSize);
                    
                    // –°–æ–∑–¥–∞—ë–º AudioBuffer
                    const audioBuffer = ctx.createBuffer(1, chunk.length, AUDIO_PLAYBACK_SAMPLE_RATE);
                    const channelData = audioBuffer.getChannelData(0);
                    
                    // üÜï v4.0: –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º Int16 -> Float32 —Å crossfade
                    for (let i = 0; i < chunk.length; i++) {
                        let sample = chunk[i] / 32768.0;
                        
                        // Fade in –ø–µ—Ä–≤—ã–µ CROSSFADE_SAMPLES
                        if (i < CROSSFADE_SAMPLES) {
                            sample *= (i / CROSSFADE_SAMPLES);
                        }
                        // Fade out –ø–æ—Å–ª–µ–¥–Ω–∏–µ CROSSFADE_SAMPLES
                        else if (i >= chunk.length - CROSSFADE_SAMPLES) {
                            const fadePos = chunk.length - i;
                            sample *= (fadePos / CROSSFADE_SAMPLES);
                        }
                        
                        channelData[i] = sample;
                    }
                    
                    // –°–æ–∑–¥–∞—ë–º –∏—Å—Ç–æ—á–Ω–∏–∫
                    const source = ctx.createBufferSource();
                    source.buffer = audioBuffer;
                    source.connect(ctx.destination);
                    
                    // –ü–ª–∞–Ω–∏—Ä—É–µ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
                    source.start(nextPlayTime);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —á–∞–Ω–∫–∞
                    nextPlayTime += audioBuffer.duration;
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
                    scheduledSources.push(source);
                    
                    // –û—á–∏—â–∞–µ–º –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏
                    source.onended = () => {
                        const idx = scheduledSources.indexOf(source);
                        if (idx > -1) scheduledSources.splice(idx, 1);
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–∫–æ–Ω—á–∏–ª–æ—Å—å –ª–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
                        if (scheduledSources.length === 0 && audioBufferQueue.length < CHUNK_SIZE && isSchedulingAudio) {
                            // üÜï v4.0: –î–∞—ë–º –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É –Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ –ø—Ä–∏–¥—É—Ç –µ—â—ë –¥–∞–Ω–Ω—ã–µ
                            setTimeout(() => {
                                if (scheduledSources.length === 0 && audioBufferQueue.length < CHUNK_SIZE) {
                                    finishAudioPlayback();
                                }
                            }, 200);
                        }
                    };
                }
            }
            
            function finishAudioPlayback() {
                log('üîá Audio playback finished');
                
                if (schedulerInterval) {
                    clearInterval(schedulerInterval);
                    schedulerInterval = null;
                }
                
                isSchedulingAudio = false;
                isPlayingAudio = false;
                interruptionState.is_assistant_speaking = false;
                
                // üÜï v4.0: –û—á–∏—â–∞–µ–º –æ—Å—Ç–∞—Ç–∫–∏ –±—É—Ñ–µ—Ä–∞
                audioBufferQueue = [];
                
                jarvisSphere.classList.remove('speaking');
                
                if (!isStreamingLLM) {
                    updateStatus('connected', '–ì–æ—Ç–æ–≤', 'connected');
                    
                    // –í–æ–∑–æ–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ
                    setTimeout(() => {
                        if (!isPlayingAudio && !isStreamingLLM && !isReconnecting) {
                            startListening();
                        }
                    }, 400);
                }
            }
            
            function stopAllAudioPlayback() {
                log('üõë Stopping all audio playback');
                
                if (schedulerInterval) {
                    clearInterval(schedulerInterval);
                    schedulerInterval = null;
                }
                
                isSchedulingAudio = false;
                isPlayingAudio = false;
                interruptionState.is_assistant_speaking = false;
                
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏
                scheduledSources.forEach(source => {
                    try {
                        source.stop();
                    } catch (e) {}
                });
                scheduledSources = [];
                
                // –û—á–∏—â–∞–µ–º –±—É—Ñ–µ—Ä
                audioBufferQueue = [];
                
                jarvisSphere.classList.remove('speaking');
                
                if (websocket && websocket.readyState === WebSocket.OPEN) {
                    try {
                        websocket.send(JSON.stringify({
                            type: "audio_playback.stopped",
                            timestamp: Date.now()
                        }));
                    } catch (e) {}
                }
            }

            const interruptionState = {
                is_assistant_speaking: false,
                is_user_speaking: false,
                last_speech_start: 0,
                last_speech_stop: 0,
                interruption_count: 0,
                last_interruption_time: 0
            };

            const AUDIO_CONFIG = {
                silenceThreshold: 0.01,
                silenceDuration: 300,
                bufferCheckInterval: 50,
                soundDetectionThreshold: 0.02,
                amplificationFactor: isMobile ? 2.0 : 1.0
            };

            // DOM Elements
            const jarvisSphere = document.getElementById('jarvisSphere');
            const circularViz = document.getElementById('circularViz');
            const llmContent = document.getElementById('llmContent');
            const llmMeta = document.getElementById('llmMeta');
            const voiceStatus = document.getElementById('voiceStatus');
            const statusText = document.getElementById('statusText');
            const errorContainer = document.getElementById('errorContainer');
            const hudFrames = [
                document.getElementById('hudTL'),
                document.getElementById('hudTR'),
                document.getElementById('hudBL'),
                document.getElementById('hudBR')
            ];

            let threeScene, threeCamera, threeRenderer, threeParticles;
            let threeInitialized = false;

            // ============================================================================
            // UTILITY FUNCTIONS
            // ============================================================================
            
            function log(message, type = 'info') {
                if (DEBUG_MODE || type === 'error') {
                    const prefix = '[JARVIS]';
                    if (type === 'error') {
                        console.error(`${prefix} ERROR:`, message);
                    } else if (type === 'warn') {
                        console.warn(`${prefix} WARNING:`, message);
                    } else {
                        console.log(`${prefix}`, message);
                    }
                }
            }

            function showError(title, text) {
                const errorTitle = document.getElementById('errorTitle');
                const errorText = document.getElementById('errorText');
                
                if (errorTitle) errorTitle.textContent = title;
                if (errorText) errorText.textContent = text;
                
                errorContainer.classList.add('active');
                
                console.error('[JARVIS] Error:', title, text);
            }

            // ============================================================================
            // üÜï LLM STREAMING FUNCTIONS
            // ============================================================================
            
            function startStreamingUI(query) {
                log(`üìù Starting LLM streaming for query: ${query}`);
                
                isStreamingLLM = true;
                streamingContent = "";
                
                // Update UI state
                jarvisSphere.classList.remove('listening', 'speaking', 'processing');
                jarvisSphere.classList.add('streaming');
                
                updateStatus('streaming', '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞...', 'streaming');
                
                // Clear content and show streaming indicator
                llmContent.innerHTML = `
                    <div class="streaming-indicator">
                        <span class="dot"></span>
                        <span>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞...</span>
                    </div>
                    <div id="streamingText"></div>
                    <span class="streaming-cursor"></span>
                `;
                
                llmMeta.textContent = 'Streaming...';
                
                // Hide copy button during streaming
                const copyButton = document.getElementById('copyLlmButton');
                if (copyButton) copyButton.style.display = 'none';
            }
            
            function appendStreamingText(content) {
                if (!isStreamingLLM) return;
                
                streamingContent += content;
                
                const streamingText = document.getElementById('streamingText');
                if (streamingText) {
                    // Format and display
                    streamingText.innerHTML = formatMarkdown(streamingContent);
                    
                    // Auto-scroll to bottom
                    llmContent.scrollTop = llmContent.scrollHeight;
                }
            }
            
            function finishStreamingUI(data) {
                log(`‚úÖ LLM streaming finished`);
                
                isStreamingLLM = false;
                
                // Remove streaming state
                jarvisSphere.classList.remove('streaming');
                
                // Update status
                updateStatus('connected', '–ì–æ—Ç–æ–≤', 'connected');
                
                // Display final formatted content
                const fullContent = data.full_content || streamingContent;
                displayLLMContent(fullContent, data.model || 'gpt-4o-mini');
                
                // Show duration if available
                if (data.duration_ms) {
                    const seconds = (data.duration_ms / 1000).toFixed(1);
                    llmMeta.textContent = `${data.model || 'gpt-4o-mini'} ‚Ä¢ ${seconds}s`;
                }
                
                // Reset streaming content
                streamingContent = "";
                currentRequestId = null;
            }
            
            function showStreamingError(message) {
                log(`‚ùå LLM streaming error: ${message}`, 'error');
                
                isStreamingLLM = false;
                streamingContent = "";
                
                // Remove streaming state
                jarvisSphere.classList.remove('streaming');
                
                // Update status
                updateStatus('error', '–û—à–∏–±–∫–∞', 'error');
                
                // Show error in LLM panel
                llmContent.innerHTML = `
                    <div class="llm-error">
                        <div class="llm-error-icon">‚ùå</div>
                        <div class="llm-error-title">–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</div>
                        <div class="llm-error-text">${message}</div>
                    </div>
                `;
                
                llmMeta.textContent = '–û—à–∏–±–∫–∞';
                
                // Reset after delay
                setTimeout(() => {
                    updateStatus('connected', '–ì–æ—Ç–æ–≤', 'connected');
                }, 3000);
            }

            function formatMarkdown(text) {
                if (!text) return '<p>–ù–µ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç–∞</p>';

                return text
                    .replace(/```(\w+)?\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>')
                    .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                    .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                    .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                    .replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>')
                    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.+?)\*/g, '<em>$1</em>')
                    .replace(/`([^`]+)`/g, '<code>$1</code>')
                    .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>')
                    .replace(/^\* (.+)$/gim, '<li>$1</li>')
                    .replace(/^- (.+)$/gim, '<li>$1</li>')
                    .replace(/\n\n/g, '</p><p>')
                    .replace(/\n/g, '<br>');
            }

            let currentLLMContent = '';

            function copyLLMResponse() {
                if (!currentLLMContent) {
                    showSuccess('‚ùå –ù–µ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è');
                    return;
                }

                const copyButton = document.getElementById('copyLlmButton');
                const copyButtonText = document.getElementById('copyButtonText');
                const copyIcon = copyButton.querySelector('i');

                try {
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = currentLLMContent;
                    const plainText = tempDiv.textContent || tempDiv.innerText || '';

                    navigator.clipboard.writeText(plainText).then(() => {
                        copyButton.classList.add('copied');
                        copyIcon.className = 'fas fa-check';
                        copyButtonText.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';

                        setTimeout(() => {
                            copyButton.classList.remove('copied');
                            copyIcon.className = 'fas fa-copy';
                            copyButtonText.textContent = '–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å';
                        }, 2000);

                    }).catch(err => {
                        showSuccess('‚ùå –û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è');
                    });

                } catch (error) {
                    console.error('[COPY] Error:', error);
                    showSuccess('‚ùå –û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è');
                }
            }

            function displayLLMContent(content, model = 'gpt-4o-mini') {
                log('‚úÖ Displaying LLM content');

                const formattedContent = formatMarkdown(content);
                llmContent.innerHTML = `<div class="fade-in">${formattedContent}</div>`;
                llmMeta.textContent = model;
                llmContent.scrollTop = 0;

                currentLLMContent = formattedContent;
                const copyButton = document.getElementById('copyLlmButton');
                if (copyButton) {
                    copyButton.style.display = 'flex';
                }
            }

            function updateStatus(status, text, className) {
                statusText.textContent = text;
                voiceStatus.className = `voice-status ${className}`;
            }

            // ============================================================================
            // THREE.JS BACKGROUND
            // ============================================================================
            
            function createCircleTexture() {
                const canvas = document.createElement('canvas');
                canvas.width = 64;
                canvas.height = 64;
                const ctx = canvas.getContext('2d');
                
                const gradient = ctx.createRadialGradient(32, 32, 0, 32, 32, 32);
                gradient.addColorStop(0, 'rgba(255, 255, 255, 1)');
                gradient.addColorStop(0.5, 'rgba(255, 255, 255, 0.5)');
                gradient.addColorStop(1, 'rgba(255, 255, 255, 0)');
                
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, 64, 64);
                
                const texture = new THREE.Texture(canvas);
                texture.needsUpdate = true;
                return texture;
            }

            function initThreeJS() {
                try {
                    const canvas = document.getElementById('jarvis-three-canvas');
                    if (!canvas) return;

                    threeScene = new THREE.Scene();
                    threeCamera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 2000);
                    threeCamera.position.z = 500;

                    threeRenderer = new THREE.WebGLRenderer({
                        canvas: canvas,
                        alpha: true,
                        antialias: !isMobile
                    });
                    threeRenderer.setSize(window.innerWidth, window.innerHeight);
                    threeRenderer.setPixelRatio(isMobile ? 1 : Math.min(window.devicePixelRatio, 2));

                    const particleCount = isMobile ? 800 : 1500;
                    const positions = new Float32Array(particleCount * 3);
                    const colors = new Float32Array(particleCount * 3);
                    const sizes = new Float32Array(particleCount);

                    // üÜï Gemini purple color palette
                    const colorPalette = [
                        new THREE.Color(0x8b5cf6),
                        new THREE.Color(0x6366f1),
                        new THREE.Color(0xa855f7)
                    ];

                    for (let i = 0; i < particleCount; i++) {
                        const i3 = i * 3;
                        positions[i3] = (Math.random() - 0.5) * 2000;
                        positions[i3 + 1] = (Math.random() - 0.5) * 2000;
                        positions[i3 + 2] = (Math.random() - 0.5) * 1500;

                        const color = colorPalette[Math.floor(Math.random() * colorPalette.length)];
                        colors[i3] = color.r;
                        colors[i3 + 1] = color.g;
                        colors[i3 + 2] = color.b;

                        const distance = Math.abs(positions[i3 + 2]);
                        sizes[i] = (1 - distance / 1500) * 4 + 0.5;
                    }

                    const particleGeometry = new THREE.BufferGeometry();
                    particleGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
                    particleGeometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
                    particleGeometry.setAttribute('size', new THREE.BufferAttribute(sizes, 1));

                    const circleTexture = createCircleTexture();

                    const particleMaterial = new THREE.PointsMaterial({
                        size: isMobile ? 2 : 3,
                        vertexColors: true,
                        transparent: true,
                        opacity: 0.6,
                        sizeAttenuation: true,
                        blending: THREE.AdditiveBlending,
                        map: circleTexture
                    });

                    threeParticles = new THREE.Points(particleGeometry, particleMaterial);
                    threeScene.add(threeParticles);

                    threeInitialized = true;
                    animateThreeJS();

                } catch (error) {
                    log(`–û—à–∏–±–∫–∞ Three.JS: ${error.message}`, 'error');
                }
            }

            function animateThreeJS() {
                if (!threeInitialized) return;
                requestAnimationFrame(animateThreeJS);

                if (threeParticles) {
                    threeParticles.rotation.y += 0.0002;
                    threeParticles.rotation.x += 0.0001;

                    const positions = threeParticles.geometry.attributes.position.array;
                    for (let i = 0; i < positions.length; i += 3) {
                        positions[i + 1] += Math.sin(Date.now() * 0.0001 + i) * 0.05;
                        if (positions[i + 1] > 1000) positions[i + 1] = -1000;
                        if (positions[i + 1] < -1000) positions[i + 1] = 1000;
                    }
                    threeParticles.geometry.attributes.position.needsUpdate = true;
                }

                threeRenderer.render(threeScene, threeCamera);
            }

            window.addEventListener('resize', function() {
                if (!threeInitialized) return;
                threeCamera.aspect = window.innerWidth / window.innerHeight;
                threeCamera.updateProjectionMatrix();
                threeRenderer.setSize(window.innerWidth, window.innerHeight);
            });

            // ============================================================================
            // VISUALIZER
            // ============================================================================
            
            function createCircularVisualizer() {
                const barCount = isMobile ? 40 : 60;
                const angleStep = 360 / barCount;
                
                for (let i = 0; i < barCount; i++) {
                    const bar = document.createElement('div');
                    bar.className = 'viz-bar';
                    bar.style.transform = `rotate(${i * angleStep}deg) translateY(-140px)`;
                    bar.style.height = '20px';
                    circularViz.appendChild(bar);
                }
            }

            function updateCircularVisualization(audioData) {
                const bars = circularViz.querySelectorAll('.viz-bar');
                const step = Math.floor(audioData.length / bars.length);
                
                for (let i = 0; i < bars.length; i++) {
                    let sum = 0;
                    for (let j = 0; j < step; j++) {
                        const index = i * step + j;
                        if (index < audioData.length) {
                            sum += Math.abs(audioData[index]);
                        }
                    }
                    const average = sum / step;
                    const multiplier = isMobile ? 300 : 200;
                    const height = 20 + Math.min(80, Math.floor(average * multiplier));
                    bars[i].style.height = `${height}px`;
                }
            }

            function resetCircularVisualization() {
                const bars = circularViz.querySelectorAll('.viz-bar');
                bars.forEach(bar => {
                    bar.style.height = '20px';
                });
            }

            // ============================================================================
            // AUDIO INPUT FUNCTIONS (MICROPHONE)
            // ============================================================================
            
            function arrayBufferToBase64(buffer) {
                const bytes = new Uint8Array(buffer);
                let binary = '';
                for (let i = 0; i < bytes.byteLength; i++) {
                    binary += String.fromCharCode(bytes[i]);
                }
                return btoa(binary);
            }

            async function initializeAudio() {
                log('–ù–∞—á–∞–ª–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∞—É–¥–∏–æ');
                
                try {
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        throw new Error("–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É");
                    }

                    if (!window.globalAudioContext) {
                        const AudioContextClass = window.AudioContext || window.webkitAudioContext;
                        window.globalAudioContext = new AudioContextClass({
                            sampleRate: 24000,
                            latencyHint: 'interactive'
                        });
                        log(`AudioContext —Å–æ–∑–¥–∞–Ω —Å —á–∞—Å—Ç–æ—Ç–æ–π ${window.globalAudioContext.sampleRate} –ì—Ü`);
                    }

                    if (window.globalAudioContext.state === 'suspended') {
                        await window.globalAudioContext.resume();
                        log('AudioContext –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω');
                    }

                    if (!window.globalMicStream) {
                        const constraints = {
                            audio: {
                                echoCancellation: true,
                                noiseSuppression: true,
                                autoGainControl: true,
                                sampleRate: 24000,
                                channelCount: 1
                            }
                        };

                        window.globalMicStream = await navigator.mediaDevices.getUserMedia(constraints);
                        log('–ú–∏–∫—Ä–æ—Ñ–æ–Ω –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω');

                        window.globalMicStream.getAudioTracks().forEach(track => {
                            track.onended = () => {
                                log('–ü–æ—Ç–æ–∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω');
                                window.globalMicStream = null;
                            };
                        });
                    }

                    if (isIOS && !window.silentAudioBuffer) {
                        try {
                            window.silentAudioBuffer = window.globalAudioContext.createBuffer(1, 1, window.globalAudioContext.sampleRate);
                            const silentSource = window.globalAudioContext.createBufferSource();
                            silentSource.buffer = window.silentAudioBuffer;
                            silentSource.connect(window.globalAudioContext.destination);
                            silentSource.start(0);
                            log('iOS: –ë—É—Ñ–µ—Ä —Ç–∏—à–∏–Ω—ã –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω');
                        } catch (iosError) {
                            log(`–û—à–∏–±–∫–∞ –±—É—Ñ–µ—Ä–∞ —Ç–∏—à–∏–Ω—ã: ${iosError.message}`, 'warn');
                        }
                    }

                    window.audioInitialized = true;
                    log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞—É–¥–∏–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ');
                    return true;

                } catch (error) {
                    log(`–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∞—É–¥–∏–æ: ${error.message}`, 'error');
                    showError(
                        '–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É',
                        '–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞.'
                    );
                    return false;
                }
            }

            async function startListening() {
                if (!isConnected || isPlayingAudio || isReconnecting || isListening || isStreamingLLM) {
                    return;
                }
                
                if (!window.audioInitialized || !window.globalAudioContext || !window.globalMicStream) {
                    const success = await initializeAudio();
                    if (!success) {
                        return;
                    }
                }
                
                isListening = true;
                log('–ù–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ');
                
                if (websocket && websocket.readyState === WebSocket.OPEN) {
                    websocket.send(JSON.stringify({
                        type: "input_audio_buffer.clear",
                        event_id: `clear_${Date.now()}`
                    }));
                }
                
                if (window.globalAudioContext.state === 'suspended') {
                    try {
                        await window.globalAudioContext.resume();
                    } catch (error) {
                        log(`–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å AudioContext: ${error}`, 'error');
                        isListening = false;
                        return;
                    }
                }
                
                if (!audioProcessor) {
                    const bufferSize = 2048;
                    audioProcessor = window.globalAudioContext.createScriptProcessor(bufferSize, 1, 1);
                    
                    let isSilent = true;
                    let silenceStartTime = Date.now();
                    let lastCommitTime = 0;
                    let hasSentAudioInCurrentSegment = false;
                    
                    audioProcessor.onaudioprocess = function(e) {
                        if (isListening && websocket && websocket.readyState === WebSocket.OPEN && !isReconnecting) {
                            const inputBuffer = e.inputBuffer;
                            let inputData = inputBuffer.getChannelData(0);
                            
                            if (inputData.length === 0) return;
                            
                            let maxAmplitude = 0;
                            for (let i = 0; i < inputData.length; i++) {
                                maxAmplitude = Math.max(maxAmplitude, Math.abs(inputData[i]));
                            }
                            
                            if (isMobile && AUDIO_CONFIG.amplificationFactor > 1.0) {
                                const amplifiedData = new Float32Array(inputData.length);
                                const gainFactor = AUDIO_CONFIG.amplificationFactor;
                                
                                for (let i = 0; i < inputData.length; i++) {
                                    amplifiedData[i] = Math.max(-1.0, Math.min(1.0, inputData[i] * gainFactor));
                                }
                                
                                inputData = amplifiedData;
                                maxAmplitude = 0;
                                for (let i = 0; i < inputData.length; i++) {
                                    maxAmplitude = Math.max(maxAmplitude, Math.abs(inputData[i]));
                                }
                            }
                            
                            const hasSound = maxAmplitude > AUDIO_CONFIG.soundDetectionThreshold;
                            updateCircularVisualization(inputData);
                            
                            const pcm16Data = new Int16Array(inputData.length);
                            for (let i = 0; i < inputData.length; i++) {
                                pcm16Data[i] = Math.max(-32768, Math.min(32767, Math.floor(inputData[i] * 32767)));
                            }
                            
                            try {
                                const message = JSON.stringify({
                                    type: "input_audio_buffer.append",
                                    event_id: `audio_${Date.now()}`,
                                    audio: arrayBufferToBase64(pcm16Data.buffer)
                                });
                                
                                websocket.send(message);
                                hasSentAudioInCurrentSegment = true;
                                
                                if (!hasAudioData && hasSound) {
                                    hasAudioData = true;
                                    audioDataStartTime = Date.now();
                                }
                                
                            } catch (error) {
                                log(`–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∞—É–¥–∏–æ: ${error.message}`, "error");
                            }
                            
                            const now = Date.now();
                            
                            if (hasSound) {
                                isSilent = false;
                                silenceStartTime = now;
                                
                                if (!jarvisSphere.classList.contains('listening') && 
                                    !jarvisSphere.classList.contains('speaking') &&
                                    !jarvisSphere.classList.contains('processing') &&
                                    !jarvisSphere.classList.contains('streaming')) {
                                    jarvisSphere.classList.add('listening');
                                }
                            } else if (!isSilent) {
                                const silenceDuration = now - silenceStartTime;
                                
                                if (silenceDuration > AUDIO_CONFIG.silenceDuration) {
                                    isSilent = true;
                                    
                                    if (now - lastCommitTime > 1000 && hasSentAudioInCurrentSegment) {
                                        setTimeout(() => {
                                            if (isSilent && isListening && !isReconnecting) {
                                                commitAudioBuffer();
                                                lastCommitTime = Date.now();
                                                hasSentAudioInCurrentSegment = false;
                                            }
                                        }, 100);
                                    }
                                }
                            }
                        }
                    };
                    
                    const streamSource = window.globalAudioContext.createMediaStreamSource(window.globalMicStream);
                    streamSource.connect(audioProcessor);
                    
                    const gainNode = window.globalAudioContext.createGain();
                    gainNode.gain.value = 0;
                    audioProcessor.connect(gainNode);
                    gainNode.connect(window.globalAudioContext.destination);
                }
                
                hasAudioData = false;
                audioDataStartTime = 0;
                
                if (!isPlayingAudio && !isStreamingLLM) {
                    jarvisSphere.classList.add('listening');
                    jarvisSphere.classList.remove('speaking', 'processing', 'streaming');
                }
                
                log("–ü—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ –Ω–∞—á–∞—Ç–æ —É—Å–ø–µ—à–Ω–æ");
            }

            function commitAudioBuffer() {
                if (!isListening || !websocket || websocket.readyState !== WebSocket.OPEN || isReconnecting) return;
                
                if (!hasAudioData) {
                    return;
                }
                
                const audioLength = Date.now() - audioDataStartTime;
                if (audioLength < minimumAudioLength) {
                    setTimeout(() => {
                        if (isListening && hasAudioData && !isReconnecting) {
                            sendCommitBuffer();
                        }
                    }, minimumAudioLength - audioLength + 50);
                    return;
                }
                
                sendCommitBuffer();
            }
            
            function sendCommitBuffer() {
                const audioLength = Date.now() - audioDataStartTime;
                if (audioLength < 100) {
                    hasAudioData = false;
                    audioDataStartTime = 0;
                    return;
                }
                
                jarvisSphere.classList.remove('listening');
                
                websocket.send(JSON.stringify({
                    type: "input_audio_buffer.commit",
                    event_id: `commit_${Date.now()}`
                }));
                
                hasAudioData = false;
                audioDataStartTime = 0;
            }

            // ============================================================================
            // WEBSOCKET CONNECTION
            // ============================================================================
            
            async function connectWebSocket() {
                if (!ASSISTANT_ID) {
                    log('Waiting for Gemini assistant configuration');
                    updateStatus('connecting', '–í—ã–±–µ—Ä–∏—Ç–µ Gemini –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞', 'connecting');
                    return;
                }

                try {
                    // ‚úÖ WebSocket URL –¥–ª—è Gemini + LLM Streaming
                    const WS_URL = SERVER_URL.replace(/^http/, 'ws') + '/ws/gemini-browser/' + ASSISTANT_ID;
                    
                    log('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Gemini WebSocket...');
                    log(`URL: ${WS_URL}`);
                    
                    isReconnecting = true;
                    
                    if (websocket) {
                        try {
                            websocket.close();
                        } catch (e) {}
                    }
                    
                    if (pingInterval) {
                        clearInterval(pingInterval);
                        pingInterval = null;
                    }
                    
                    websocket = new WebSocket(WS_URL);
                    websocket.binaryType = 'arraybuffer';
                    
                    websocket.onopen = function() {
                        log('‚úÖ Gemini WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω');
                        isConnected = true;
                        isReconnecting = false;
                        reconnectAttempts = 0;
                        
                        hudFrames.forEach(frame => frame.classList.add('active'));
                        updateStatus('connected', '–ì–æ—Ç–æ–≤', 'connected');
                        
                        // üÜï v3.2: –ü–æ–¥–∫–ª—é—á–∞–µ–º –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π LLM WebSocket —Å assistant_id
                        connectLLMWebSocket();
                        
                        setTimeout(() => {
                            startListening();
                        }, 500);
                        
                        const pingIntervalTime = isMobile ? MOBILE_PING_INTERVAL : PING_INTERVAL;
                        pingInterval = setInterval(() => {
                            if (websocket && websocket.readyState === WebSocket.OPEN) {
                                websocket.send(JSON.stringify({ type: "ping" }));
                            }
                        }, pingIntervalTime);
                    };
                    
                    websocket.onmessage = function(event) {
                        try {
                            if (event.data instanceof Blob || !event.data) return;

                            try {
                                const data = JSON.parse(event.data);
                                lastPongTime = Date.now();
                                
                                // =============================================
                                // üÜï v3.2: LLM REQUEST EVENT (triggers LLM WebSocket)
                                // =============================================
                                
                                if (data.type === 'llm.request') {
                                    // Gemini handler –æ—Ç–ø—Ä–∞–≤–∏–ª –∑–∞–ø—Ä–æ—Å –Ω–∞ LLM
                                    // –ü–µ—Ä–µ—Å—ã–ª–∞–µ–º –µ–≥–æ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π LLM WebSocket
                                    log(`üìù LLM request received: ${data.query}`);
                                    startStreamingUI(data.query);
                                    sendLLMQuery(data.query, data.request_id);
                                    return;
                                }
                                
                                // =============================================
                                // LEGACY: LLM STREAMING EVENTS (fallback for old backend)
                                // =============================================
                                
                                if (data.type === 'llm.stream.start') {
                                    log(`üìù LLM Stream started: ${data.query}`);
                                    currentRequestId = data.request_id;
                                    startStreamingUI(data.query);
                                    return;
                                }
                                
                                if (data.type === 'llm.stream.delta') {
                                    if (data.request_id === currentRequestId || !currentRequestId) {
                                        appendStreamingText(data.content);
                                    }
                                    return;
                                }
                                
                                if (data.type === 'llm.stream.done') {
                                    log(`‚úÖ LLM Stream done`);
                                    finishStreamingUI(data);
                                    return;
                                }
                                
                                if (data.type === 'llm.stream.error') {
                                    log(`‚ùå LLM Stream error: ${data.message}`, 'error');
                                    showStreamingError(data.message);
                                    return;
                                }
                                
                                // =============================================
                                // GEMINI CONNECTION EVENTS
                                // =============================================
                                
                                if (data.type === 'connection_status') {
                                    log(`Gemini connection: ${data.status}`);
                                    if (data.status === 'connected') {
                                        updateStatus('connected', 'Gemini –≥–æ—Ç–æ–≤', 'connected');
                                    }
                                    return;
                                }
                                
                                if (data.type === 'gemini.setup.complete') {
                                    log('Gemini setup complete');
                                    return;
                                }
                                
                                // =============================================
                                // FUNCTION CALL EVENTS
                                // =============================================
                                
                                if (data.type === 'function_call.executing') {
                                    log(`üîß Function executing: ${data.function}`);
                                    if (data.function === 'query_llm') {
                                        // LLM streaming will handle UI
                                        updateStatus('processing', '–ó–∞–ø—Ä–æ—Å –∫ –ò–ò...', 'processing');
                                        jarvisSphere.classList.add('processing');
                                    }
                                    return;
                                }
                                
                                if (data.type === 'function_call.completed') {
                                    log(`‚úÖ Function completed: ${data.function}`);
                                    return;
                                }
                                
                                // =============================================
                                // üîß AUDIO EVENTS - SMOOTH PLAYBACK (v4.0)
                                // =============================================
                                
                                if (data.type === 'response.audio.delta') {
                                    if (data.delta) {
                                        // ‚úÖ v4.0: –î–æ–±–∞–≤–ª—è–µ–º –≤ –±—É—Ñ–µ—Ä –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
                                        addAudioChunkToBuffer(data.delta);
                                    }
                                    return;
                                }
                                
                                if (data.type === 'assistant.speech.started') {
                                    log('üîä Assistant started speaking');
                                    // UI –æ–±–Ω–æ–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –Ω–∞—á–∞–ª–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
                                    return;
                                }
                                
                                if (data.type === 'assistant.speech.ended') {
                                    log('üîá Assistant speech ended (server)');
                                    // –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—Å—è –¥–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è –±—É—Ñ–µ—Ä–∞
                                    return;
                                }
                                
                                if (data.type === 'response.done') {
                                    // –ù–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º - –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–∞–∫–æ–Ω—á–∏—Ç—Å—è —Å–∞–º–æ
                                    return;
                                }
                                
                                // =============================================
                                // TRANSCRIPTION EVENTS
                                // =============================================
                                
                                if (data.type === 'input.transcription') {
                                    log(`üë§ User: ${data.text}`);
                                    return;
                                }
                                
                                if (data.type === 'output.transcription') {
                                    log(`ü§ñ Gemini: ${data.text}`);
                                    return;
                                }
                                
                                // =============================================
                                // ERROR EVENTS
                                // =============================================
                                
                                if (data.type === 'error') {
                                    log(`Gemini API Error: ${JSON.stringify(data.error)}`, 'error');
                                    
                                    if (data.error && data.error.code === 'input_audio_buffer_commit_empty') {
                                        if (!isPlayingAudio && !isReconnecting && !isStreamingLLM) {
                                            setTimeout(() => { 
                                                startListening(); 
                                            }, 500);
                                        }
                                        return;
                                    }
                                    
                                    updateStatus('error', '–û—à–∏–±–∫–∞', 'error');
                                    return;
                                }
                                
                            } catch (parseError) {
                                if (event.data === 'pong') {
                                    lastPongTime = Date.now();
                                    return;
                                }
                            }
                        } catch (generalError) {
                            log(`–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏: ${generalError.message}`, "error");
                        }
                    };
                    
                    websocket.onclose = function(event) {
                        log(`WebSocket –∑–∞–∫—Ä—ã—Ç: ${event.code}`);
                        isConnected = false;
                        isListening = false;
                        
                        if (pingInterval) {
                            clearInterval(pingInterval);
                            pingInterval = null;
                        }
                        
                        if (event.code === 1000 || event.code === 1001) {
                            return;
                        }
                        
                        const maxAttempts = isMobile ? MOBILE_MAX_RECONNECT_ATTEMPTS : MAX_RECONNECT_ATTEMPTS;
                        if (reconnectAttempts < maxAttempts) {
                            reconnectAttempts++;
                            const delay = Math.min(30000, Math.pow(2, reconnectAttempts) * 1000);
                            log(`–ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ ${delay}ms (–ø–æ–ø—ã—Ç–∫–∞ ${reconnectAttempts}/${maxAttempts})`);
                            updateStatus('connecting', '–ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...', 'connecting');
                            setTimeout(() => {
                                connectWebSocket();
                            }, delay);
                        } else {
                            log('–î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –ø–æ–ø—ã—Ç–æ–∫ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', 'error');
                            updateStatus('error', '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', 'error');
                            showError(
                                '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è',
                                '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.'
                            );
                        }
                    };
                    
                    websocket.onerror = function(error) {
                        log(`WebSocket –æ—à–∏–±–∫–∞: ${error}`, 'error');
                    };
                    
                    return true;
                    
                } catch (error) {
                    log(`–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error}`, 'error');
                    isReconnecting = false;
                    return false;
                }
            }

            // ============================================================================
            // üÜï LLM WEBSOCKET CONNECTION (v3.2 - with assistant_id for User API key)
            // ============================================================================
            
            function connectLLMWebSocket() {
                if (llmWebSocket && llmWebSocket.readyState === WebSocket.OPEN) {
                    log('üìù LLM WebSocket already connected');
                    return;
                }
                
                try {
                    // ‚úÖ v2.0: –î–æ–±–∞–≤–ª—è–µ–º assistant_id –≤ URL –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è OpenAI –∫–ª—é—á–∞ –∏–∑ User –º–æ–¥–µ–ª–∏
                    let LLM_WS_URL = SERVER_URL.replace(/^http/, 'ws') + '/llm-stream';
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º assistant_id –µ—Å–ª–∏ –µ—Å—Ç—å
                    if (ASSISTANT_ID) {
                        LLM_WS_URL += '?assistant_id=' + encodeURIComponent(ASSISTANT_ID);
                    }
                    
                    log(`üìù Connecting to LLM WebSocket: ${LLM_WS_URL}`);
                    
                    llmWebSocket = new WebSocket(LLM_WS_URL);
                    
                    llmWebSocket.onopen = function() {
                        log('üìù ‚úÖ LLM WebSocket connected (User API key mode)');
                        isLLMConnected = true;
                    };
                    
                    llmWebSocket.onmessage = function(event) {
                        try {
                            const data = JSON.parse(event.data);
                            
                            // LLM Stream Events
                            if (data.type === 'llm.stream.start') {
                                log(`üìù LLM Stream started: ${data.query}`);
                                currentRequestId = data.request_id;
                                startStreamingUI(data.query);
                                return;
                            }
                            
                            if (data.type === 'llm.stream.delta') {
                                if (data.request_id === currentRequestId || !currentRequestId) {
                                    appendStreamingText(data.content);
                                }
                                return;
                            }
                            
                            if (data.type === 'llm.stream.done') {
                                log(`‚úÖ LLM Stream done`);
                                finishStreamingUI(data);
                                return;
                            }
                            
                            if (data.type === 'llm.stream.error') {
                                log(`‚ùå LLM Stream error: ${data.message || data.error}`, 'error');
                                showStreamingError(data.message || data.error);
                                return;
                            }
                            
                            if (data.type === 'error') {
                                log(`üìù LLM error: ${data.error}`, 'error');
                                showStreamingError(data.error);
                                return;
                            }
                            
                            if (data.type === 'connection_status') {
                                log(`üìù LLM connection: ${data.status} (API key source: ${data.api_key_source || 'unknown'})`);
                                return;
                            }
                            
                        } catch (e) {
                            log(`üìù LLM WS parse error: ${e}`, 'error');
                        }
                    };
                    
                    llmWebSocket.onclose = function() {
                        log('üìù LLM WebSocket disconnected');
                        isLLMConnected = false;
                        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
                        setTimeout(() => {
                            if (isConnected && ASSISTANT_ID) {
                                connectLLMWebSocket();
                            }
                        }, 3000);
                    };
                    
                    llmWebSocket.onerror = function(error) {
                        log(`üìù LLM WebSocket error: ${error}`, 'error');
                    };
                    
                } catch (error) {
                    log(`üìù LLM WebSocket connection error: ${error}`, 'error');
                }
            }
            
            // üÜï Send query to LLM WebSocket
            function sendLLMQuery(query, requestId) {
                if (!llmWebSocket || llmWebSocket.readyState !== WebSocket.OPEN) {
                    log('üìù LLM WebSocket not connected, connecting...', 'warn');
                    connectLLMWebSocket();
                    // Retry after connection
                    setTimeout(() => sendLLMQuery(query, requestId), 500);
                    return;
                }
                
                log(`üìù Sending query to LLM: ${query.substring(0, 50)}...`);
                llmWebSocket.send(JSON.stringify({
                    type: 'llm.query',
                    query: query,
                    request_id: requestId
                }));
            }

            // ============================================================================
            // CLICK HANDLER
            // ============================================================================
            
            jarvisSphere.addEventListener('click', async function() {
                if (!window.audioInitialized) {
                    log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞—É–¥–∏–æ –ø–æ –∫–ª–∏–∫—É');
                    const success = await initializeAudio();
                    if (!success) {
                        return;
                    }
                }
                
                // –¢–∞–∫–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º playback –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ –∫–ª–∏–∫—É (–≤–∞–∂–Ω–æ –¥–ª—è iOS)
                initPlaybackAudioContext();
                
                if (!isListening && !isPlayingAudio && !isReconnecting && !isStreamingLLM) {
                    if (isConnected) {
                        startListening();
                    } else {
                        connectWebSocket();
                    }
                }
            });

            // ============================================================================
            // MOBILE MENU HANDLERS
            // ============================================================================

            mobileMenuToggle.addEventListener('click', function() {
                sidebar.classList.toggle('mobile-open');
                sidebarOverlay.classList.toggle('show');
            });

            sidebarOverlay.addEventListener('click', function() {
                sidebar.classList.remove('mobile-open');
                sidebarOverlay.classList.remove('show');
            });

            // ============================================================================
            // INITIALIZATION
            // ============================================================================

            log('üöÄ JARVIS AI Interface v4.1 Starting...');
            log(`Mode: Gemini Voice (WS1) + LLM Text (WS2) - Dual WebSocket`);
            log(`Audio: v4.0 Anti-Click (500ms buffer, 200ms chunks, crossfade)`);
            log(`API Keys: User model (via assistant_id)`);
            log(`Assistant ID: ${ASSISTANT_ID || 'Not configured yet'}`);
            log(`Server URL: ${SERVER_URL}`);

            createCircularVisualizer();
            initThreeJS();

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã
            // –ï—Å–ª–∏ –µ—Å—Ç—å assistant –≤ URL - —ç—Ç–æ embed —Ä–µ–∂–∏–º
            const isEmbedMode = urlParams.has('assistant');
            
            if (isEmbedMode && ASSISTANT_ID) {
                // Embed —Ä–µ–∂–∏–º - —Å–∫—Ä—ã–≤–∞–µ–º config panel –∏ sidebar
                document.body.classList.add('embed-mode');
                log('üì¶ Running in EMBED mode');
                connectWebSocket();
            } else if (ASSISTANT_ID) {
                // –û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º —Å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–º –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º
                document.body.classList.remove('embed-mode');
                log('üñ•Ô∏è Running in NORMAL mode with saved assistant');
                connectWebSocket();
            } else {
                // –û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º –±–µ–∑ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
                document.body.classList.remove('embed-mode');
                updateStatus('connecting', '–í—ã–±–µ—Ä–∏—Ç–µ Gemini –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞', 'connecting');
                if (jarvisSphere) {
                    jarvisSphere.classList.remove('listening', 'speaking', 'processing', 'streaming');
                }
                log('üñ•Ô∏è Running in NORMAL mode - waiting for assistant selection');
            }
        });
    </script>
</body>
</html>
